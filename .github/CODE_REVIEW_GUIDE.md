# コードレビューガイドライン（関屋式）

## 目的
PRごとに「ビルドできる」「型が崩れてない」「最低限のテストが通る」「品質ガイドラインに違反してない」を担保し、「動かない/反応しない/抜け漏れ」を早期に減らす。

---

## レビュー観点チェックリスト

### 1. 入力の安全性
- [ ] ユーザー入力のバリデーションがあるか
- [ ] SQLインジェクション対策（プリペアドステートメント使用）
- [ ] XSS対策（サニタイズ/エスケープ）

### 2. ロジック正確性
- [ ] 境界値処理（0件、上限、null/undefined）
- [ ] 非同期処理のエラーハンドリング（try-catch）
- [ ] レースコンディションの考慮

### 3. エラーハンドリング
- [ ] catch ブロックで適切なログ出力
- [ ] ユーザーへのエラーメッセージが適切
- [ ] 失敗時のフォールバック/リトライ戦略

### 4. 既存コード整合性
- [ ] 既存APIの互換性を壊していない
- [ ] 既存の命名規則に従っている
- [ ] 重複コードを作っていない（共通化の検討）

### 5. セキュリティ
- [ ] 機密情報（APIキー/トークン）がコードにハードコードされていない
- [ ] 認証・認可のチェックが適切
- [ ] テナント分離（workspace_id/owner_user_id）が守られている

### 6. 設定・インフラ
- [ ] wrangler.jsonc の変更が必要な場合、本番影響を確認
- [ ] DBマイグレーションが必要な場合、ロールバック可能か確認
- [ ] 環境変数の追加が必要な場合、ドキュメント更新

---

## 出力ルール（レビューコメント）

### 必須マーカー
- **⚠️ 懸念点**: 潜在的な問題（セキュリティ、パフォーマンス等）
- **TODO**: 後で対応が必要なこと
- **📝 トレードオフ**: 意図的な妥協点とその理由

### 禁止事項
- ❌ 「たぶん動く」は禁止（確認してから承認）
- ❌ 仕様変更をPRコメントで提案しない（Issue化）
- ❌ 「ここも直しといて」で範囲拡大しない

---

## 自動チェック（CI）

### 必須パス
1. **lint** - ESLint
2. **typecheck** - TypeScript
3. **build** - ビルド成功
4. **unit** - Vitest
5. **e2e:smoke** - Playwright smoke

### P0 Guardrails（追加チェック）
- Migration不変性（過去migration編集禁止）
- OFFSET禁止（cursor only強制）
- Tenant Isolation SQLチェック

---

## GenSpark固定指示（プロジェクト開始時に貼る）

```md
# GenSpark 固定指示（PRドリブン品質ゲート運用）

- このリポジトリは GitHub Actions による PR品質ゲートを必須とする
- 作業は feature/* ブランチで行い、PRを作成してから main にマージ（直push可だが推奨しない）
- PRで必須の自動チェック：
  1) lint (ESLint)
  2) typecheck (TypeScript)
  3) build (frontend + backend)
  4) unit (Vitest)
  5) e2e:smoke (Playwright smoke)
  6) P0 Guardrails (migration/tenant/offset)
- 主要なUI操作要素（ボタン・フォーム・保存等）には data-testid を付与する
- 仕様変更は禁止。仕様に関わる変更が必要な場合は Issue 提案
- 機密情報（APIキー/トークン/個人情報）をコードやログに出さない
- PR本文に「目的/影響範囲/テスト方法」を記載する
```

---

## ブランチ運用

| ブランチ | 用途 | 保護 |
|---------|------|------|
| `main` | 本番相当 | 直push可（ただしCI必須） |
| `feature/*` | 作業用 | なし |

### 現状の運用
- GenSpark でキリのいい単位まで実装
- main に直接 push（CI が自動実行）
- CI が落ちたら GenSpark/ChatGPT に戻して修正

### PRドリブン運用（推奨）
- GenSpark で feature/* ブランチで作業
- PR作成 → CI自動実行
- 緑になったらマージ

---

## トラブルシュート

### CIが落ちた場合
1. GitHub Actions のログを確認
2. ログをGenSpark（またはChatGPT）に貼り付け
3. 修正を依頼
4. 再push → CI再実行

### よくある失敗
- **lint**: `npm run lint` で事前確認
- **typecheck**: `npx tsc --noEmit` で事前確認
- **build**: `npm run build` で事前確認
- **e2e**: `data-testid` の付け忘れ、セレクタ変更
