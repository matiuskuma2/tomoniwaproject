name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Phase 2.5a: Guardrail - prevent /api/threads/i/* reintroduction
      # Note: threads.ts is excluded (Phase 2.5b will delete /i/* routes from it)
      - name: "Guardrail: forbid /api/threads/i/* routes"
        run: |
          echo "Checking for forbidden path '/api/threads/i/'..."
          # Exclude: threads.ts (legacy, to be deleted in 2.5b), workflow files (contain the pattern)
          FOUND=$(grep -RIn "/api/threads/i/" apps/ packages/ frontend/ \
            --include="*.ts" --include="*.tsx" --include="*.js" \
            --exclude="threads.ts" 2>/dev/null || true)
          if [ -n "$FOUND" ]; then
            echo "$FOUND"
            echo "❌ Found forbidden path '/api/threads/i/' in repo."
            echo "   Public invites must use '/i/*' routes (served by invite.ts)."
            exit 1
          fi
          echo "✅ Guardrail passed: no /api/threads/i/* references found (excluding legacy threads.ts)"
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            package-lock.json
      
      # Frontend checks
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: TypeScript check (frontend)
        working-directory: ./frontend
        run: npx tsc -b
      
      - name: ESLint (frontend)
        working-directory: ./frontend
        run: npm run lint
      
      - name: Build (frontend)
        working-directory: ./frontend
        run: npm run build
      
      # Backend checks (root directory - Cloudflare Workers)
      - name: Install backend dependencies
        run: npm ci
      
      - name: TypeScript check (backend)
        run: npm run build
      
      # Bundle size check (optional)
      - name: Check frontend bundle size
        working-directory: ./frontend
        run: |
          echo "Frontend bundle size:"
          du -sh dist/
          # Fail if bundle is too large (over 5MB)
          SIZE=$(du -sb dist/ | cut -f1)
          if [ $SIZE -gt 5242880 ]; then
            echo "❌ Bundle size too large: $SIZE bytes (limit: 5MB)"
            exit 1
          fi
          echo "✅ Bundle size OK: $SIZE bytes"
