{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "webapp",
  "main": "apps/api/src/index.ts",
  "compatibility_date": "2024-12-01",
  "compatibility_flags": ["nodejs_compat"],
  "minify": true,
  
  // ============================================================
  // D1 Database (SQLite)
  // ============================================================
  // IMPORTANT: Create production database first:
  //   npx wrangler d1 create webapp-production
  // Local development automatically uses local SQLite with --local flag
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "webapp-production",
      "database_id": "35dad869-c19f-40dd-90a6-11f87a3382d2",
      "migrations_dir": "db/migrations"
    }
  ],

  // ============================================================
  // KV Namespaces (Key-Value Storage)
  // ============================================================
  // Used for: OTP codes, Rate limiting, Session management
  // IMPORTANT: Create namespaces first:
  //   npx wrangler kv:namespace create RATE_LIMIT
  //   npx wrangler kv:namespace create RATE_LIMIT --preview
  //   npx wrangler kv:namespace create OTP_STORE
  //   npx wrangler kv:namespace create OTP_STORE --preview
  "kv_namespaces": [
    {
      "binding": "RATE_LIMIT",
      "id": "5f0feea9940643ed93ef9ca1a682f264",
      "preview_id": "97f4d56518464fce844d726e88f914e4"
    },
    {
      "binding": "OTP_STORE",
      "id": "9ad0e9b7e8bf4efa96b9fdb8ab89b176",
      "preview_id": "31ee64a07fd8477f9219072e61600d1c"
    }
  ],

  // ============================================================
  // R2 Buckets (Object Storage)
  // ============================================================
  // Used for: Voice recordings, attachments, exports
  // Created: webapp-storage
  "r2_buckets": [
    {
      "binding": "STORAGE",
      "bucket_name": "webapp-storage"
    }
  ],

  // ============================================================
  // Queues (Message Queues)
  // ============================================================
  // Used for: Email sending, background jobs
  // Created: email-queue, email-dlq
  "queues": {
    "producers": [
      {
        "binding": "EMAIL_QUEUE",
        "queue": "email-queue"
      }
    ],
    "consumers": [
      {
        "queue": "email-queue",
        "max_batch_size": 1,
        "max_batch_timeout": 30,
        "max_retries": 3,
        "dead_letter_queue": "email-dlq"
      }
    ]
  },

  // ============================================================
  // Environment Variables
  // ============================================================
  // Secrets should be set using: npx wrangler secret put SECRET_NAME
  // For local development, use .dev.vars file
  "vars": {
    "ENVIRONMENT": "production",  // Production mode: Requires Bearer token authentication
    "LOG_LEVEL": "warn",  // Production: warn/error only (perf optimization for 1000+ connections)
    "CORS_ORIGINS": "https://app.tomoniwao.jp,.pages.dev",  // Production: restrict to app domain + Pages previews
    "AI_FALLBACK_ENABLED": "false"  // Default: Gemini-only (cost control for free tier)
  },

  // ============================================================
  // Triggers (Cron Jobs)
  // ============================================================
  "triggers": {
    "crons": [
      // Daily cleanup of expired data
      "0 2 * * *",
      // Hourly budget check
      "0 * * * *"
    ]
  },

  // ============================================================
  // Analytics Engine
  // ============================================================
  "analytics_engine_datasets": [
    {
      "binding": "ANALYTICS"
    }
  ],

  // ============================================================
  // Development Settings
  // ============================================================
  "dev": {
    "ip": "0.0.0.0",
    "port": 3000,
    "local_protocol": "http"
  }
}
