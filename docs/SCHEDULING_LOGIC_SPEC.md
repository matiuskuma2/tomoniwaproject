# SCHEDULING_LOGIC_SPEC.md
## ToMoniWao – 日程調整ロジック仕様 "正（Source of Truth）"

最終更新: 2025-12-29  
目的: 日程調整の「本質（調整ループ）」を固定し、UIが邪魔しないようにする  
重要: DB/マイグレーション/APIコントラクトは変更しない（ロジックはAIの判断層として扱う）

---

## 0. 絶対前提（変更禁止）
- 日程調整は「一回で終わらないループ処理」が本質。
- UIは"結果表示"が基本。ループはAIが裏で回す。
- いまの実装は審査/検証用であり、最終形のロジック全てをUIで表現しない。

---

## 1. 合意条件の3タイプ（確定）
### A) AND（全員参加必須）
- 条件: 全員OKになるまで確定しない
- NGが出たら候補再生成（繰り返し）

### B) CORE（コアメンバー必須）
- 条件: コアメンバーがOKなら確定
- その他は任意参加（参加できる人だけ）

### C) MAX（参加率最大化）
- 条件: 参加率が最大の日時で確定
- 全員一致は不要
- 大人数イベントでは"繰り返し再確認"をしない（うざいから）
- 締切を持つ（締切時点で最大の日時で確定）

---

## 2. 調整ループ（共通構造）
### 2.1 ループの状態（概念）
1) 条件解釈（AND/CORE/MAX、期間、時間帯、必須者、締切）
2) 候補生成（対象者/主催者の空きから）
3) 依頼送信（利用者=アプリ通知、非利用者=/iリンク）
4) 回答収集（OK/NG/候補選択/未返信）
5) 集計と判定（条件を満たすか）
6) 満たす → 確定（Meet生成・カレンダー登録）
7) 満たさない → 候補再生成 or 条件再確認 → 2へ戻る

> UX上は、ユーザーに「ループ」を意識させない  
> チャットで「調整中」「確定」「再提案します」だけ返すのが理想

---

## 3. 関係性で"候補生成"が変わる（確定）
### family
- 代理確定が許容される（基本は自動で入れる）
- 不満が出たら「変更」要求として扱う（別の調整）

### coworker（Room/Grid）
- 事前許諾/同意があれば freebusy で候補を強く絞れる
- 原則: AIが提案→合意→確定（調整コスト最小）

### external
- 原則: リンク送付→相手が選ぶ→主催者が確定
- 何度も通知しない（必要なら最小回数に抑える）

---

## 4. 審査用MVP（現状の正しい説明）
- まず「主催者が候補を提示」「相手が選択」「主催者が回答状況を確認」「主催者が最適日を確定」「Meet生成」「カレンダー作成」を実演できれば良い。
- AND/CORE/MAXの自動ループは将来機能として説明（現状実装と混ぜない）。

---
