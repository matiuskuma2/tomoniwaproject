# SCHEDULING_COVERAGE_MATRIX.md
## ToMoniWao – 日程調整ロジックの網羅マトリクス（現状 / 将来 / 影響範囲）

最終更新: 2025-12-29  
ステータス: ✅ 確定版

---

## 0. 目的（この資料が守るもの）
このマトリクスは以下を守るための「境界線」です。

- **既存のDB/マイグレーション/APIコントラクトを壊さない**
- 「今できていること」と「将来やること」を混同しない
- AIが推測で実装を拡大して混乱するのを止める
- 追加実装は **"既存構造の上に積む（追記）"** だけに限定する

---

## 1. 絶対ルール（Breaking禁止）
- 既存DBテーブル/カラムの削除・リネーム禁止（DROP/RENAME禁止）
- 既存migrationファイル変更禁止（追記のみ。追加マイグレーションはOK）
- 既存APIのURL/レスポンスキー変更禁止（削除禁止。追加は後方互換のみ）
- 日程調整フローの骨格（Thread作成→招待→選択→主催者確定→Meet生成）は変更しない
- 「将来AIがやる」は、**"現状の動作を説明する材料"にしない**  
  （＝現状で動画に映ることだけを「できること」とする）

---

## 2. 用語（短い定義）
### 調整対象の関係性（relationship_type）
- **family**: 原則「代理確定」が許される領域（プライバシー配慮あり）
- **coworker**: Room/Grid前提。許諾範囲でAIが調整（合意→確定）
- **external**: TimeRex/Spear型。リンク送付→相手が選ぶ

### 合意条件（参加の成立条件）
- **AND**: 全員参加が必須（1人NGなら成立しない）
- **CORE**: コア必須（コアOKで成立、他は任意）
- **MAX**: 参加率最大（最も参加が多い日で成立）

### 調整ループ（Iteration）
- 候補→回答→不成立→候補再生成…の繰り返し  
- **全関係性で最大2回まで**（無限ループは禁止）

---

## 3. いまの実装が「確実に保証している範囲」
※ここが"現状の正"です。ここ以外は「将来」扱い。

### ✅ 現状保証（MVPで確実に動く）
- external型の招待リンク（/i/:token）で **候補日選択**
- 主催者が **回答状況を確認**（誰がどの候補を選んだか）
- 主催者が **任意の候補を選び確定**（Finalize）
- 確定時に **Google Meet生成 + Calendar Event作成**
- 確定後に **Meet URL / Event ID を表示**

### ⚠️ 現状は「手動判断」で成立している部分
- 「最適日」の判断（MAX/AND/COREのロジックはUI上で人が判断）
- 「全員一致してないから再調整」等の自動ループ（未実装）

---

## 4. カバレッジマトリクス（最重要）
凡例:
- ✅ = 現状で保証（動画で実演できる）
- ⚠️ = 現状は手動運用で成立（判断は主催者）
- 🔜 = 将来拡張（現状説明に混ぜない）
- ❌ = 予定なし / まだ定義不足（先に定義が必要）
- 影響範囲: UIのみ / API追加のみ / DB追加あり（※変更ではなく追記）

---

### 4.1 関係性 × 調整方式

| 区分 | 現状保証 | 将来拡張 | 影響範囲（壊さない前提） | 備考 |
|---|---:|---:|---|---|
| external（他人）リンク調整 | ✅ | 🔜（候補自動抽出/最適化） | UIのみ/AI層 | 今の主戦場。反復は最大2回 |
| coworker（仕事仲間）リンク調整（暫定） | ⚠️ | 🔜（相互カレンダー参照→自動調整） | UI→API追加（freebusy） | 現状は外部と同様のリンク運用で代替可 |
| coworker（仕事仲間）合意→確定 | ❌ | 🔜 | API追加（同意/提案/応答） | ここは「将来の秘書体験」の核 |
| family（家族）代理確定 | ❌ | 🔜 | 権限/同意設計が先 | プライバシー設計が先に必要 |

---

### 4.2 合意条件（AND / CORE / MAX）

| 合意条件 | 現状保証 | 将来拡張 | 影響範囲 | 備考 |
|---|---:|---:|---|---|
| MAX（参加率最大） | ⚠️（主催者が人数を見て選ぶ） | 🔜（自動選定） | UIのみ→AI層 | 今回の審査動画では「主催者が最適日を選ぶ」でOK |
| AND（全員必須） | ⚠️（主催者が未回答/NGを見てやり直す） | 🔜（自動再調整ループ） | UI→API追加 | "自動ループ"は次フェーズ |
| CORE（コア必須） | ❌（UIで運用は可能だが仕様未固定） | 🔜 | 仕様→UI→API | コア指定のUXが先に必要 |

---

### 4.3 調整ループ（再調整の回し方）

| ループ方式 | 現状保証 | 将来拡張 | 影響範囲 | 備考 |
|---|---:|---:|---|---|
| external: 最大2回調整 | ⚠️（主催者が新スレッド/再送で運用） | 🔜（同一スレッドでラウンド管理） | API追加 or 新規テーブル追記 | **無限ループ禁止**（回数上限2回） |
| coworker: 合意まで自動反復（最大2回） | ❌ | 🔜 | AI層＋API追加 | 最終形の肝。今は実装しない |
| family: 代理確定→変更要求で再調整 | ❌ | 🔜 | 権限設計→API | "勝手に入れる"は設定制が必須 |

---

## 5. 「現状のDB/APIで矛盾しない」整理（重要）
現状の骨格は **external型（リンク）** に最適化されている。

- `thread_invites` + `/i/:token` = 外部ユーザーの入口  
- `thread_selections` = 参加者が「どの候補を選んだか」  
- `threads/:id/status` = 主催者が「集計して見る」  
- `finalize` + `thread_finalize` = 最終確定 + Meet/Calendar

👉 これは "秘書AIの調整ループ" の **土台として成立**するが、  
ループ自動化（再提案・再確認）は **別レイヤー（AI層/追加API）** で積むべき。

---

## 6. 今後の実装は「どこまでやるか」宣言してから着手する
今後の作業は必ずこの形式で宣言してから実装する。

### 実装宣言テンプレ
- 対象: external / coworker / family
- 合意条件: MAX / AND / CORE
- ループ: 最大2回
- 影響範囲: UIのみ / API追加のみ / DB追記あり
- 既存の壊さない宣言: DB/マイグレーション/APIキー削除なし

---

## 7. 直近の運用（審査・動画・相手共有のための「現状説明」）
相手に渡す/動画に載せるときは、現状をこのように説明する。

- 現状は external型のリンク調整がMVP（確実に動く）
- 主催者は回答状況（誰がどの候補を選んだか、各候補の選択人数）を確認できる
- 主催者が最適日を選んで確定すると、Google Meetとカレンダーイベントが自動生成される
- coworker/familyの自動調整ループは、将来のAI秘書機能として拡張予定（現状の仕様に混ぜない）

---

## 8. 次に作るべき補助資料（任意）
- docs/SCHEDULING_RULES.md  
  - AND/CORE/MAXの「終了条件」「回数上限」「通知方針（うざさ回避）」を明文化
- docs/UX_CHAT_INTENT_MAP.md  
  - 発話例 → intent → どのAPIを叩くか（現状APIのまま）

---
