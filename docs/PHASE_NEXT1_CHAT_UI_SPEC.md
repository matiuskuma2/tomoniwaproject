# PHASE_NEXT1_CHAT_UI_SPEC.md
## ToMoniWao – Phase Next-1: チャットUI（器）画面仕様書

最終更新日: 2025-12-29  
Phase: Next-1（最優先 / 2週間）  
目的: 最終形UXの「器」だけを作る（AI理解・音声入力は後回し）

---

## 0. 絶対ルール（Breaking禁止）

- **DB/マイグレーション/APIコントラクトは一切変更しない**
- **既存E2E（外部招待→選択→票数→確定→Meet表示）を絶対に壊さない**
- **既存の認証フロー（Cookie→/auth/token→Bearer）を壊さない**
- **既存API（/api/threads/*）をそのまま使用**
- **Phase Next-1では「器だけ」作る。AI理解・音声入力は Phase Next-2**

---

## 1. 画面構成（3カラムレイアウト）

```
┌─────────────────────────────────────────────────────────┐
│  ヘッダー（固定）                                        │
│  [Logo] ToMoniWao    [ユーザー名] [ログアウト]         │
├─────────┬─────────────────────────┬─────────────────────┤
│         │                         │                     │
│  左     │        中央             │      右             │
│  カラム │      （チャット）        │    （カード）       │
│         │                         │                     │
│ スレッド│  チャットログ表示       │  補助カード表示     │
│ 一覧    │  +                      │  （状況による）     │
│         │  テキスト入力エリア     │                     │
│         │                         │                     │
│ 180px   │      flex-1             │    320px            │
│         │                         │  （可変・非表示可） │
└─────────┴─────────────────────────┴─────────────────────┘
```

---

## 2. 左カラム：スレッド一覧

### 2.1 表示項目（固定）
各スレッドに以下を表示：
- **title**: スレッドタイトル（例: 本番テスト - E2E）
- **status**: ステータスバッジ
  - `draft`: グレー
  - `active`: 青
  - `confirmed`: 緑
  - `cancelled`: 赤
- **pending_count**: 未返信数（例: 2人未返信）
- **updated_at**: 最終更新日時（相対表示: 2時間前、昨日、2025/12/29）

### 2.2 データソース
- **API**: `GET /api/threads`（既存）
- **レスポンス**: 
  ```json
  {
    "threads": [
      {
        "id": "thread-id",
        "title": "本番テスト - E2E",
        "status": "active",
        "created_at": "2025-12-29T00:00:00Z",
        "updated_at": "2025-12-29T12:00:00Z"
      }
    ]
  }
  ```
- **pending_count**: `GET /api/threads/:id/status` から計算（後で最適化可能）

### 2.3 UI動作
- スレッドをクリック → 中央（チャット）に遷移
- 選択中のスレッドは背景色を変更（青背景）
- スクロール可能
- 上部に「新規作成」ボタン（既存の Thread作成画面へ遷移）

---

## 3. 中央カラム：チャット

### 3.1 Phase Next-1 での実装内容
**「チャットログの表示」のみ**

- **チャットログ = Thread の操作履歴**を時系列で表示
- AI理解・応答は Phase Next-2 で実装
- **Phase Next-1 では静的ログのみ**

### 3.2 チャットログの種類（Phase Next-1）

#### A. システムメッセージ（自動生成）
Thread の操作に応じて自動生成：

1. **Thread作成時**
   ```
   [システム] 2025/12/29 10:00
   新しい日程調整を作成しました
   タイトル: 本番テスト - E2E
   候補日時: 3件
   ```

2. **招待送信時**
   ```
   [システム] 2025/12/29 10:05
   3名に招待リンクを送信しました
   - Alex Johnson
   - David Chen
   - Maria Garcia
   ```

3. **回答受信時**
   ```
   [システム] 2025/12/29 11:00
   Alex Johnson が候補日時を選択しました
   選択: 2025/12/30 23:00 〜 2025/12/31 00:00
   ```

4. **確定時**
   ```
   [システム] 2025/12/29 12:00
   日程が確定しました
   確定日時: 2025/12/30 23:00 〜 2025/12/31 00:00
   Google Meet: https://meet.google.com/xxx-xxxx-xxx
   ```

#### B. ユーザーメッセージ（Phase Next-2で実装予定）
Phase Next-1 では表示のみ（入力機能は Phase Next-2）

### 3.3 データソース（Phase Next-1）

**Option A: 既存APIから生成（推奨）**
- `GET /api/threads/:id/status` のレスポンスから自動生成
- DB変更不要
- チャットログは「表示専用」

**Option B: 新規テーブル（Phase Next-2以降）**
- `thread_messages` テーブル（既存: 0022_thread_messages.sql）
- Phase Next-1 では使用しない

### 3.4 テキスト入力エリア（Phase Next-1）

**最小実装:**
- テキストエリア（1行）
- 「送信」ボタン
- **Phase Next-1 では送信しても何も起きない（UI確認用）**
- Phase Next-2 で intent解析を実装

UI:
```
┌────────────────────────────────────────┐
│  [テキスト入力エリア]       [送信]    │
└────────────────────────────────────────┘
```

---

## 4. 右カラム：カード表示エリア

### 4.1 Phase Next-1 での実装内容
**「カードの箱」だけ作る（中身は薄く）**

- カードは **状況に応じて表示/非表示**
- 1つのスレッドに対して 0〜2枚のカードを表示
- カードの種類は 7種類（UI_CARD_CATALOG.md 参照）

### 4.2 Phase Next-1 で実装するカード（3種類のみ）

#### 1. **ProgressCard（進捗カード）**
Thread の進捗状況を表示

**表示条件**: 
- Thread status が `active`

**表示内容**:
```
┌────────────────────────┐
│ 📊 進捗状況            │
├────────────────────────┤
│ 招待数: 3              │
│ 未回答: 1              │
│ 承諾: 2                │
│ 辞退: 0                │
├────────────────────────┤
│ 候補日時（票数）        │
│ ○ 12/30 23:00 (2名)   │
│ ○ 12/31 23:00 (1名)   │
│ ○ 01/01 23:00 (0名)   │
└────────────────────────┘
```

**データソース**: `GET /api/threads/:id/status`

---

#### 2. **MeetCard（確定カード）**
Google Meet URL と確定日時を表示

**表示条件**: 
- Thread status が `confirmed`
- `evaluation.meeting.url` が存在

**表示内容**:
```
┌────────────────────────────────┐
│ ✅ 日程が確定しました          │
├────────────────────────────────┤
│ 📅 確定日時                    │
│ 2025/12/30 23:00 〜 24:00     │
├────────────────────────────────┤
│ 🎥 Google Meet                │
│ https://meet.google.com/xxx   │
│ [コピー] [参加] [カレンダー]  │
└────────────────────────────────┘
```

**データソース**: `GET /api/threads/:id/status`

---

#### 3. **InviteCard（招待カード）**
招待リンクを表示

**表示条件**: 
- Thread status が `active`
- 招待リンクが生成されている

**表示内容**:
```
┌────────────────────────────────┐
│ 📨 招待リンク                  │
├────────────────────────────────┤
│ 未回答（1名）                  │
│ - Alex Johnson                │
│   https://app.tomoniwao.jp/i/xxx │
│   [コピー]                     │
└────────────────────────────────┘
```

**データソース**: `GET /api/threads/:id/status`

---

### 4.3 Phase Next-2 以降で実装するカード（4種類）

以下は Phase Next-1 では実装しない:
- **ActionCard**: 次のアクション提案（例: リマインダー送信）
- **ConfirmCard**: 確認ダイアログ（例: 確定してよいか）
- **ErrorCard**: エラー表示
- **InfoCard**: 情報表示（例: 調整失敗理由）

---

## 5. ルーティング（URL構成）

### 5.1 新規ルート（Phase Next-1）

| URL | 説明 | 表示内容 |
|-----|------|----------|
| `/chat` | チャットUI（メイン画面） | 左: スレッド一覧、中央: チャット、右: カード |
| `/chat/:threadId` | 特定スレッドを開く | 同上（スレッド選択済み） |

### 5.2 既存ルート（維持）

以下は **そのまま維持**（Phase Next-1 では変更しない）:
- `/` - Dashboard（既存の仮UI）
- `/threads` - Thread一覧（既存）
- `/threads/new` - Thread作成（既存）
- `/threads/:id` - Thread詳細（既存）
- `/contacts` - 連絡先一覧（既存）
- `/lists` - リスト一覧（既存）
- `/i/:token` - 外部招待ページ（既存）

### 5.3 導線

**Phase Next-1 では以下の導線を追加:**
1. Header に「チャット」リンクを追加 → `/chat` へ遷移
2. Dashboard に「チャットUIを試す」ボタンを追加 → `/chat` へ遷移

**既存の導線は維持:**
- Dashboard → Thread詳細 → 既存UI

---

## 6. データフロー（Phase Next-1）

### 6.1 スレッド一覧の取得
```
User → GET /api/threads
     → 左カラムに表示
```

### 6.2 スレッド選択
```
User → スレッドをクリック
     → GET /api/threads/:id/status
     → 中央: チャットログ生成
     → 右: カード表示
```

### 6.3 チャットログ生成（Phase Next-1）
```
GET /api/threads/:id/status のレスポンスから:
- Thread作成時刻 → システムメッセージ
- Invites → 招待送信メッセージ
- Selections → 回答受信メッセージ
- Evaluation.meeting → 確定メッセージ
```

---

## 7. UI/UXの詳細仕様

### 7.1 レスポンシブ対応

**デスクトップ（1280px以上）:**
- 3カラム表示（左: 180px、中央: flex-1、右: 320px）

**タブレット（768px 〜 1279px）:**
- 2カラム表示（左: 非表示、中央: flex-1、右: 320px）
- 左カラムは「ハンバーガーメニュー」で表示

**モバイル（767px以下）:**
- 1カラム表示（中央のみ）
- 左カラムは「ハンバーガーメニュー」で表示
- 右カラムは「下スライド」で表示

### 7.2 カラーテーマ

**Phase Next-1 では Tailwind CSS のデフォルトカラーを使用:**
- 背景: `bg-gray-50`
- 選択中スレッド: `bg-blue-100`
- カード: `bg-white` + `shadow`
- システムメッセージ: `text-gray-600`
- ユーザーメッセージ: `text-gray-900`

### 7.3 アニメーション

**Phase Next-1 では最小限:**
- スレッド選択時: ホバー時に `hover:bg-gray-100`
- カード表示: フェードイン（`transition-opacity`）

---

## 8. 実装の段取り（Phase Next-1）

### Step 1: 基本レイアウト（1日）
- 3カラムレイアウトの骨組み
- Header（ロゴ、ユーザー名、ログアウト、チャットリンク）
- ルーティング（`/chat`, `/chat/:threadId`）

### Step 2: 左カラム（1日）
- スレッド一覧の表示
- `GET /api/threads` の呼び出し
- スレッド選択機能

### Step 3: 中央カラム（2日）
- チャットログの表示ロジック
- `GET /api/threads/:id/status` からログ生成
- テキスト入力エリア（UI確認用・送信機能なし）

### Step 4: 右カラム（2日）
- ProgressCard の実装
- MeetCard の実装
- InviteCard の実装
- カードの表示/非表示ロジック

### Step 5: レスポンシブ対応（1日）
- タブレット・モバイル対応
- ハンバーガーメニュー

### Step 6: 統合テスト（1日）
- 既存E2Eが壊れていないか確認
- 新規画面（`/chat`）の動作確認

**合計: 8日 ≈ 2週間（余裕を持たせて）**

---

## 9. 成功基準（Phase Next-1）

### ✅ 完成の定義
1. `/chat` で3カラムレイアウトが表示される
2. 左カラムにスレッド一覧が表示される
3. スレッドを選択すると、中央にチャットログが表示される
4. 右カラムに状況に応じたカードが表示される
5. 既存E2E（外部招待→選択→票数→確定→Meet表示）が壊れていない
6. レスポンシブ対応（デスクトップ・タブレット・モバイル）

### ❌ Phase Next-1 では実装しないもの
- AI理解・intent解析
- 音声入力
- テキスト送信機能（Phase Next-2）
- ActionCard/ConfirmCard/ErrorCard/InfoCard
- 通知機能（ベル）

---

## 10. Phase Next-2 への橋渡し

Phase Next-1 が完了したら、以下を Phase Next-2 で実装:
1. テキスト送信機能
2. Intent解析（3種類: external日程送信、募集中一覧、スレッド状況）
3. API呼び出し連携
4. チャットログへのユーザーメッセージ追加

---

## 11. AI実装指示（Phase Next-1用）

```
【Phase Next-1: チャットUIの器】

目的: 最終形UXの「器」だけを作る（AI理解・音声入力は後回し）

絶対ルール:
- DB/API/マイグレーションは一切変更しない
- 既存E2E（外部招待→選択→票数→確定→Meet表示）を絶対に壊さない
- 既存の認証フロー（Cookie→/auth/token→Bearer）を壊さない

実装内容:
1. 3カラムレイアウト（左: スレッド一覧、中央: チャット、右: カード）
2. 左カラム: GET /api/threads でスレッド一覧表示
3. 中央カラム: GET /api/threads/:id/status からチャットログ生成（静的）
4. 右カラム: ProgressCard, MeetCard, InviteCard の3種類
5. ルーティング: /chat, /chat/:threadId
6. レスポンシブ対応（デスクトップ・タブレット・モバイル）

Phase Next-1 では実装しないもの:
- AI理解・intent解析
- 音声入力
- テキスト送信機能
- ActionCard/ConfirmCard/ErrorCard/InfoCard

作業前に必ず:
- 影響範囲: frontend のみ
- 確認項目: 既存E2Eが壊れていないか

参照ドキュメント:
- docs/PHASE_NEXT1_CHAT_UI_SPEC.md
- docs/UX_CHAT_SPEC.md
- docs/AI_WORK_RULES.md
```

---

## 12. まとめ

Phase Next-1 は **「器だけ」** を作るフェーズです。

**作るもの:**
- 3カラムレイアウト
- スレッド一覧（左）
- チャットログ表示（中央）
- カード表示（右）

**作らないもの:**
- AI理解
- 音声入力
- テキスト送信機能

👉 **これで Phase Next-2 の実装準備が完璧に整います**

---
