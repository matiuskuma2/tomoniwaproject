# PHASE_NEXT3_CALENDAR_VIEW_SPEC.md

ToMoniWao / tomonowa – Phase Next-3: カレンダー閲覧（Read）仕様（1枚・固定）

**最終更新日:** 2025-12-30  
**ステータス:** 確定案（実装前提の1枚仕様 / Source of Truth）

---

## 0. 目的（Next-3で"何ができれば勝ちか"）

Phase Next-3 の目的は **「カレンダーアプリとして "自分の予定が見える" ことを最小単位で成立させる」**こと。

同時に、既存の 日程調整フロー（外部リンク型 / 投票 / 確定 / Meet生成）を一切変更しない。

- ✅ できるようにする：自分の予定閲覧（今日/週）
- ✅ 次に繋げる：coworker（Room/Grid）の可視性、音声入力、AI調整ループ
- ❌ やらない：日程調整ロジック変更、DBスキーマ破壊、無限調整、既存E2E破壊

---

## 1. 不変条件（Breaking禁止）

### 1.1 スケジューリング（調整）ロジックは変更禁止
- SCHEDULING_RULES.md（最大2回 / AND/CORE/MAX / 無限再調整禁止）は維持
- Phase 0B/Next-1/Next-2で動いている「招待→選択→確定→Meet生成」は変更しない

### 1.2 DB / API / migration は壊さない
- 既存テーブル/カラムの削除・リネーム禁止
- migrationの過去ファイル修正禁止（必要なら追加のみ）
- 既存APIのURL・レスポンスキーは変更しない（追加は後方互換のみ）

### 1.3 プライバシー
- 「相手の予定の中身」を表示しない（少なくとも初期は）
- coworker可視化は Room/Grid の権限設計が固まるまで段階導入

---

## 2. 実装範囲（Next-3でやること / やらないこと）

### 2.1 やること（P0＝最小勝ち筋）

#### P0-1: 自分の予定（Today / Week）をアプリ内で閲覧
- /chat から「今日の予定」「今週の予定」をテキストで聞ける（Next-2の延長）
- UIとしても "カレンダー表示" を最低限追加（一覧 or 簡易カレンダー）

#### P0-2: FreeBusy を使って "空き時間" を抽出できる状態
- ただし "自動で予定調整を回す" のはまだやらない（Next-4相当）

### 2.2 やらないこと（Next-3では禁止）
- ❌ coworkerの予定の詳細表示（タイトル/場所/説明など）
- ❌ coworkerの空き時間を勝手に引く（明示許諾の設計が必要）
- ❌ 予定の自動再調整ループ（最大2回制御の自動化は後段）
- ❌ 音声入力の本実装（UIは置いてよいが、本格導入は次）

---

## 3. UX（ユーザー体験）— 最小で成立させる会話

### 3.1 チャットでできること（Next-3 P0）
- **「今日の予定ある？」** → 今日の予定一覧（時間順）
- **「今週の予定は？」** → 週の予定一覧（曜日ごと）
- **「今日の空いてる時間は？」** → FreeBusyから "空き枠" を返す（候補枠の提案の土台）

### 3.2 表示ポリシー（Chat/カード）
- **チャット：** 要点（件数・重要な1〜3件）
- **カード：** 一覧表示（時間/タイトル/Meetリンクなど）
- **ベル：** 外部からの通知は従来通り（NOTIFICATION_CHANNEL_RULES.mdに従う）

---

## 4. UI（画面）— どこに出すか

### 4.1 /chat に統合（最小変更）

/chat の右ペイン（CardsPane）に CalendarCard を追加（P0）
- タブ（モバイル）にも "カレンダー" を追加してOK（Threads/Chat/Cards/Calendar の4タブ）

### 4.2 CalendarCard（P0仕様）
- **Today（今日）タブ**
- **Week（今週）タブ**
- クリックで詳細（最初は簡易でOK）

**表示項目（P0）:**
- 開始時刻〜終了時刻
- タイトル（自分の予定なので表示OK）
- Meetリンク（あれば）
- 場所（任意、P0では省略可）

---

## 5. API/実装方式（壊さない前提）

### 5.1 サーバ側（Workers）に "代理API" を追加するか？

**原則:** 追加して良いが、既存APIを壊さないこと。

**P0として安全な方針（推奨）:**

**A案（推奨）：Workersに /api/calendar/* を追加**
- /api/calendar/today
- /api/calendar/week
- /api/calendar/freebusy

**理由:** フロントにGoogle APIを直結させず、トークン管理・監査・制御をWorkers側で持てる

**B案：** フロントから直接Google APIを叩く（非推奨）
- トークン取り扱い・CORS・監査が増えて事故りやすい

**Next-3はA案を基本とする**（セキュリティ/運用が安定）

### 5.2 使うGoogle API（Read）
- **FreeBusy**
- **Events.list**

※ 書き込み（events.insert）は既に"確定時"にやっている（Phase 0Bの流れを維持）

---

## 6. 権限（Scopes）— 今の審査と衝突させない

**前提:** すでに審査は提出済み。

Next-3で「読み取り」を増やす場合は、スコープ追加＝審査影響が出る可能性がある。

**方針（安全）:**
- まずは 同一スコープでできる範囲を確認（無理なら段階的に）
- 読み取りスコープが必要なら：
  - 追加スコープは "次の申請" として分離
  - 既存の機能（確定→Meet生成）は維持し、審査の追加要件が出ないように分離

---

## 7. Room/Grid（coworker可視性）— Next-3は"準備まで"

Next-3では「Room/Gridの予定を見せる」本番実装はしない。

ただし、仕様として以下を固定しておく：
- **Room:** 組織の箱（会社/複数プロジェクト）
- **Grid:** 目的（Quest）で動くチーム
- **coworker可視化は "許諾" と "見せる粒度" が必須**
  - P0では「busy/free」だけ
  - P1で「会議名は伏せる」「詳細は自分のみ」など

---

## 8. DoD（完了条件）

### P0（必須）
- ✅ /chat で「今日の予定」「今週の予定」が取得できる
- ✅ CalendarCard で Today/Week が表示できる
- ✅ 「今日の空いてる時間は？」で FreeBusyから空き枠が出せる
- ✅ 既存E2E（招待→選択→確定→Meet生成）が一切壊れていない

### Day2/Day3 完了状態（2025-12-30）
- ✅ **Day2:** `/api/calendar/today`, `/api/calendar/week` 実装完了（events.list）
- ✅ **Day3:** `/api/calendar/freebusy?range=today|week` 実装完了（busy のみ）
- ✅ **API 契約:** JSON 形式・warning 設計・安定性 → 合格
- ⚠️ **権限不足:** `google_calendar_permission_missing` により `busy` 実データは未取得
- 📝 **UI 対応:** `warning` がある場合は「busy 無し扱い」で空き枠 UI を描く

### P1（任意）
- ⬜ coworkerの "busy/free" を Room/Grid 設定の範囲で見れる（詳細は出さない）
- ⬜ OAuth スコープ追加（`calendar.freebusy` または `calendar.readonly`）で `busy` 実データ取得

---

## 9. Next-4（この先の接続）
- 音声入力の本格導入（Speech→Intent→API）
- 調整ループの自動化（最大2回制御をコード化）
- coworkerの許諾モデル（Room/Grid権限とプライバシー）
- 「会話スレッドで調整スレッドを束ねる」最終形の整理

---

**仕様書終わり**
