# UI_SYNC_DESIGN.md
Calendar Sync UI/UX Design (Phase Next-7 Day0)

**Purpose**: 審査完了後に即実装できるよう、UI導線だけを先に固める  
**Status**: Design Only（実装は審査後）

---

## 1. 表示場所

### Desktop（3カラム）
- **右ペイン（CardsPane）**: confirmed スレッドのみ
- **位置**: カードの下部（投票結果の下）
- **表示条件**: `thread.status === "confirmed"` かつ `evaluation.final_slot_id` が存在

### Mobile（タブ切り替え）
- **カードタブ**: Desktop と同じ位置
- **チャット上部**: 小バナー（固定表示）
  - テキスト: 「📅 確定しました。カレンダーに同期できます」
  - タップで同期画面へ

---

## 2. ボタン表示（状態別）

### 未同期（初期状態）
```
┌─────────────────────────────────┐
│ 📅 カレンダーに同期（ベータ）   │
└─────────────────────────────────┘
```
- **ラベル**: 「カレンダーに同期（ベータ）」
- **色**: 青（Primary）
- **アイコン**: 📅
- **動作**: タップで同期実行

### 同期中
```
┌─────────────────────────────────┐
│ ⏳ 同期中...                     │
└─────────────────────────────────┘
```
- **ラベル**: 「同期中...」
- **色**: グレー（Disabled）
- **アイコン**: ⏳（スピナー）
- **動作**: タップ不可

### 同期済み（冪等）
```
┌─────────────────────────────────┐
│ ✅ 同期済み（もう一度確認）      │
└─────────────────────────────────┘
```
- **ラベル**: 「同期済み（もう一度確認）」
- **色**: 緑（Success）
- **アイコン**: ✅
- **動作**: タップで同期状態を再確認（API呼び出し）

### 失敗（A案フォールバック）
```
┌─────────────────────────────────┐
│ ❌ 同期できませんでした          │
│ 手動登録用の情報を表示           │
└─────────────────────────────────┘
```
- **ラベル**: 「同期できませんでした」
- **色**: 赤（Error）
- **アイコン**: ❌
- **動作**: タップで手動登録セットを表示

---

## 3. 同期結果の表示

### 成功（初回）
```
┌─────────────────────────────────┐
│ ✅ カレンダーに同期しました      │
│                                  │
│ 📅 イベントID: evt_123           │
│ 🔗 Meet URL: https://meet...     │
│                                  │
│ [Meetを開く] [閉じる]            │
└─────────────────────────────────┘
```

### 成功（冪等・既に同期済み）
```
┌─────────────────────────────────┐
│ ✅ すでに同期済みです            │
│                                  │
│ 📅 イベントID: evt_123           │
│ 🔗 Meet URL: https://meet...     │
│                                  │
│ [Meetを開く] [閉じる]            │
└─────────────────────────────────┘
```

### 失敗（A案フォールバック）
```
┌─────────────────────────────────┐
│ ❌ 同期できませんでした          │
│                                  │
│ 以下の情報をコピーして           │
│ 手動でカレンダーに登録してください│
│                                  │
│ 📅 タイトル: 日程調整ミーティング │
│ 🕐 開始: 2026-01-05 10:00       │
│ 🕐 終了: 2026-01-05 11:00       │
│ 🌐 タイムゾーン: Asia/Tokyo     │
│ 🔗 Meet URL: https://meet...     │
│                                  │
│ [すべてコピー] [閉じる]         │
└─────────────────────────────────┘
```

---

## 4. 状態遷移

```
未同期 (initial)
  ↓ ユーザーが「カレンダーに同期」をタップ
  ↓
同期中 (loading)
  ↓ API: POST /api/threads/:id/calendar/sync
  ├→ 成功: 同期済み (synced)
  │   ↓ 2回目以降
  │   └→ 同期済み（冪等）
  │
  └→ 失敗: フォールバック (failed)
      ↓ 手動登録セットを表示
      └→ ユーザーが手動で登録
```

---

## 5. UI Components（実装Day1で作成）

### SyncButton.tsx
```typescript
interface SyncButtonProps {
  threadId: string;
  status: 'initial' | 'loading' | 'synced' | 'failed';
  onSync: () => void;
}
```

### SyncResultModal.tsx
```typescript
interface SyncResultModalProps {
  result: {
    status: 'created' | 'already_synced' | 'failed';
    calendar_event_id?: string;
    meet_url?: string;
    manual_event_payload?: ManualEventPayload;
  };
  onClose: () => void;
}
```

### ManualEventPayload (Type)
```typescript
interface ManualEventPayload {
  title: string;
  start_at: string;
  end_at: string;
  timezone: string;
  description: string;
  meet_url?: string;
}
```

---

## 6. ユーザーフロー

### 正常系（初回同期）
1. 確定済みスレッドを表示
2. 「📅 カレンダーに同期（ベータ）」ボタンが表示される
3. ユーザーがタップ
4. 「⏳ 同期中...」に変わる
5. API呼び出し成功
6. モーダルで「✅ カレンダーに同期しました」表示
7. ボタンが「✅ 同期済み（もう一度確認）」に変わる

### 正常系（再同期・冪等）
1. 「✅ 同期済み（もう一度確認）」ボタンをタップ
2. 「⏳ 同期中...」に変わる
3. API呼び出し成功（`status: "already_synced"`）
4. モーダルで「✅ すでに同期済みです」表示
5. ボタンが「✅ 同期済み（もう一度確認）」のまま

### 失敗系（A案フォールバック）
1. 「📅 カレンダーに同期（ベータ）」ボタンをタップ
2. 「⏳ 同期中...」に変わる
3. API呼び出し失敗（OAuth未許可 / API失敗）
4. モーダルで「❌ 同期できませんでした」表示
5. 手動登録用の情報セット表示
6. ユーザーが「すべてコピー」をタップ
7. クリップボードにコピー
8. ユーザーが手動でカレンダーに登録

---

## 7. エラーハンドリング

### OAuth未許可
- **メッセージ**: 「カレンダーへのアクセスが許可されていません」
- **動作**: 手動登録セットを表示

### API失敗
- **メッセージ**: 「同期中にエラーが発生しました」
- **動作**: 手動登録セットを表示

### ネットワークエラー
- **メッセージ**: 「ネットワークエラーが発生しました」
- **動作**: 再試行ボタンを表示

### スレッド未確定
- **メッセージ**: 「スレッドが確定していません」
- **動作**: ボタンを非表示

---

## 8. アクセシビリティ

### キーボード操作
- ボタンは `Tab` でフォーカス可能
- `Enter` / `Space` で実行

### スクリーンリーダー
- `aria-label="カレンダーに同期"`
- `aria-busy="true"` 同期中
- `aria-live="polite"` 結果通知

---

## 9. モバイル対応

### タップ領域
- 最小サイズ: 44x44px（iOS/Android標準）
- ボタン幅: 100%（フルワイド）

### 小バナー（チャット上部）
```
┌─────────────────────────────────┐
│ 📅 確定しました。同期できます →  │
└─────────────────────────────────┘
```
- タップで同期ボタンへスクロール
- または直接同期実行

---

## 10. 機能フラグ

### FEATURE_CALENDAR_SYNC_ENABLED
```typescript
const FEATURE_CALENDAR_SYNC_ENABLED = process.env.FEATURE_CALENDAR_SYNC_ENABLED === 'true';

if (!FEATURE_CALENDAR_SYNC_ENABLED) {
  return null; // ボタンを非表示
}
```

### 用途
- 審査完了前: `false`（ボタン非表示）
- 審査完了後: `true`（ボタン表示）
- 問題発生時: `false`（即座に無効化）

---

## 11. 実装Day1のタスク

### Frontend
1. `SyncButton.tsx` 作成
2. `SyncResultModal.tsx` 作成
3. `CardsPane.tsx` に同期ボタン追加
4. モバイルバナー追加（チャット上部）
5. 状態管理（`syncStatus`）追加

### API統合
1. `POST /api/threads/:id/calendar/sync` 呼び出し
2. `GET /api/threads/:id/calendar/sync-status` 呼び出し
3. エラーハンドリング（OAuth / API失敗）

### スタイル
1. ボタンスタイル（未同期 / 同期中 / 同期済み / 失敗）
2. モーダルスタイル（成功 / 失敗）
3. レスポンシブデザイン（Desktop / Mobile）

---

## 12. 事故ゼロ設計

### ✅ 自動同期なし
- ユーザーがボタンをタップしない限り同期しない

### ✅ 確定後のみ
- 未確定スレッドではボタンを表示しない

### ✅ A案フォールバック
- 失敗時は必ず手動登録セットを表示

### ✅ 冪等性
- 同じスレッドで何度実行しても同じ結果

### ✅ 機能フラグ
- `FEATURE_CALENDAR_SYNC_ENABLED` でいつでもOFF可能

---

## 13. 次のステップ

### 審査完了後（Next-7 Day1）
1. `NEXT7_REVIEW_CHECKLIST.md` を完了
2. Backend実装（D1、API、OAuth）
3. Frontend実装（UI Components、状態管理）
4. DoD実行（3本のテスト）

### 審査完了前（現在）
- ✅ 設計完了（本ドキュメント）
- ⏳ OAuth審査待ち
- ❌ 実装禁止

---

## ✅ まとめ

**UI導線設計が完了しました。**

- 表示場所: confirmed スレッドのカード + モバイルバナー
- ボタン: 未同期 / 同期中 / 同期済み / 失敗
- 結果表示: モーダル（成功 / 失敗 / 手動登録セット）
- 事故ゼロ: 自動同期なし、確定後のみ、A案フォールバック
- 機能フラグ: `FEATURE_CALENDAR_SYNC_ENABLED` でOFF可能

**審査完了後、即実装可能な状態です。** 🚀
