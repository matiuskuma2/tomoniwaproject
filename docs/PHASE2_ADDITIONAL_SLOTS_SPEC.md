# Phase2: 追加候補（Additional Proposals）仕様書

最終更新: 2026-01-11

---

## 0. 目的

Beta A で成立した「チャット→確認→送信→回答→確定」の主導線を壊さずに、回答収集中（collecting）の途中で候補日時を追加できるようにする。

追加候補は、運用事故（回答消失/誤通知/勝手に候補差し替え）を起こしやすい領域なので、以下を満たすことを最優先とする。

- 既存回答は絶対に消さない
- "再回答が必要"であることを必ず説明する
- 2回まで（ルールで固定）
- 回答収集中（collecting）のみ（確定後のやり直しは原則なし）
- 通知は メール＋Inboxの両方（アプリユーザー判定はメール一致でOK）

---

## 1. 概念整理（将来拡張を見据えた分離）

本機能は「候補（Slots）」の追加だが、将来の清掃配置など n対nの割当 に拡張しても破綻しないために、以下の分離を維持する。

### 1-1. Relationship（承認モデル）と Delivery（通知チャネル）を混ぜない

- **Relationship**: other / work / family（許可と承認のルール）
- **Delivery**: email / inbox（将来 slack/chatwork）

追加候補は Beta/Phase2 では Relationship=other の運用で固定する（仕事仲間/家族の自動化は別フェーズ）。

### 1-2. Thread（調整単位）と Group/List（参加者グルーピング）の分離

- **Thread**: "この1回の調整"
- **List**: "送信先の再利用"

※ListはThreadに固定されない。ThreadはListを参照して参加者を追加できるだけ。

### 1-3. "候補を追加する"は「新しい提案セット」を作る行為

将来のn対n（配置/割当）でも同じ：
「候補セットを更新する行為」＝「新しい提案を出す」なので、提案バージョン（後述）を導入して整合性を担保する。

---

## 2. 追加候補（Additional Slots）の機能要件

### 2-1. 発動条件（ガード）

追加候補は以下の条件でのみ許可する。

- `thread.phase === collecting` のみ
- 追加候補回数 <= 2
- finalize済みは拒否（別スレッドに誘導）
- 送信確認（pending_action）を必ず経由（誤送信防止）

### 2-2. 対象者（再通知）

- **全員に再通知**（必須）
- ただし **辞退（declined）済みは除外**
  - 理由：辞退した人へ再通知すると運用事故・クレームが急増するため

### 2-3. 既存回答の扱い（最重要）

- 既存の `thread_selections` は **一切更新しない**
- `scheduling_slots` に **新規追加のみ**
- status API / UI は「既存の票＋新候補（票0）」を共存表示
- 「追加候補が出たので無効」などの扱いはしない（事故る）

### 2-4. 回数制限

- 追加候補は **最大2回**
- 3回目は拒否し、別スレッド誘導

### 2-5. "やり直し"ポリシー

- finalize後のやり直しは原則なし
- どうしても必要な場合は「別スレッドで」を使う（タイトルのみ引継ぎ、候補は新規生成）

---

## 3. 重要設計：提案バージョン（Proposal Version）

追加候補によって「何が新しく追加されたか」を安全に扱うため、Threadに提案バージョン概念を入れる。

### 3-1. 最小導入（DB変更最小）

- `scheduling_threads` に `proposal_version`（INT）を追加
  - 初期=1
  - 追加候補1回目で2、2回目で3
- `scheduling_slots` に `proposal_version` を付与（どの提案で追加された候補か分かる）

これにより、将来のn対n（配置）でも「どの提案で追加された候補か」「誰がどの提案に回答したか」が追える。

### 3-2. 回答（Selection）側の整合性

- `thread_selections` に `proposal_version_at_response` を追加（任意）
- "この人は提案v1に回答した"が追跡できる
- Phase2でやるかは実装負荷次第だが、運用事故防止のため推奨

---

## 4. API設計（既存のPendingActionフローに統合）

### 4-1. 追加候補のprepare（確認用）

**POST /api/threads/:id/proposals/prepare**

入力：生成方法（固定ルールでOK）、または slots候補（サーバ生成でもフロント生成でも可）

出力：
```json
{
  "confirm_token": "...",
  "proposal_version_next": 2,
  "slots_preview": [
    { "start_at": "...", "end_at": "...", "location_id": null }
  ],
  "remaining_count": 1,
  "message_for_chat": "..."
}
```

**message_for_chat（テンプレ）**:
```
📅 候補日を追加します。

・既存の回答はそのまま残ります
・追加した候補について、全員に再回答をお願いします（辞退済みの方には送りません）
・追加候補はあと {残り回数} 回まで可能です

追加候補（{件数}件）:
1. {start} - {end}
2. ...

次に「送る / キャンセル / 別スレッドで」のいずれかを入力してください。
```

### 4-2. confirm（3語固定）

既存：`POST /api/pending-actions/:token/confirm`

- decision: `send` / `cancel` / `new_thread`
- 「別スレッドで」はタイトル引継ぎ、候補は新規生成（既存仕様）

### 4-3. execute（実行）

既存：`POST /api/pending-actions/:token/execute`

追加候補の場合のexecuteの責務：
- `proposal_version` を +1
- `scheduling_slots` を追加（proposal_versionを付与）
- 通知の作成（メール＋Inbox）※全員、辞退除外
- `invite_deliveries` に記録（email/inbox）

---

## 5. 通知設計（メール＋Inbox）

### 5-1. 追加候補通知（必須）

**件名（メール）**:
```
【候補追加】日程調整の候補日が追加されました
```

**本文（メール・Inbox共通）**:
```
日程調整の候補日が追加されました。

・あなたのこれまでの回答は保持されています
・追加された候補について、あらためてご都合を選んでください

回答はこちら：
{invite_url}

— Tomoniwao
```

### 5-2. 説明が弱いと事故るポイント（必須文言）

- 「既存回答は保持」
- 「追加候補に再回答が必要」
- 「回答リンク」

この3つはテンプレ固定で必須。

---

## 6. UI/UX（チャット主導・カードは補助）

- 追加候補の発動はチャット
- カードは status API を元に表示更新
- 追加候補の送信後は、カードに "追加された候補" が見える必要がある
- `proposal_version` を表示する必要はないが、差分表示ができると良い（後回し可）

---

## 7. 運用インシデント防止（必須ガード）

### 7-1. "回答が消える"事故防止

- slots追加は INSERTのみ、selectionsは不変
- status APIは "古いselectionをそのまま表示し続ける"
- 新しい候補は票0で並ぶだけ

### 7-2. "勝手に再募集"事故防止（説明）

- 追加候補送信時に必ず「再回答が必要」を送る
- 辞退者には送らない

### 7-3. 冪等性

- `pending_action.execute` は `request_id` で冪等
- slots追加も `proposal_version_next` を使って二重加算しない
- 例：execute前に現在proposal_versionをチェックし、期待値とズレたら409

### 7-4. 回数制限

- 2回超過はサーバ側で拒否（UIだけで止めない）

---

## 8. テスト（E2E）— 必須ケース一覧

### 8-1. 基本系

1. collectingで追加候補prepareが成功し、サマリが出る
2. sendでexecuteし、slotsが増える（既存slotsは残る）
3. send後、既存selectionsがDB上変化していない
4. send後、通知が全員に作成される（辞退除外）
5. cancelでexecuteされない（DB変化なし）
6. 2回目はOK、3回目は拒否
7. finalize後は拒否
8. 追加候補後のstatusで、旧票＋新候補(票0)が共存して見える

### 8-2. エッジ

- 追加候補が既存候補と全重複 → "追加可能な候補がありません"で終了
- threadがキャンセル済み → 拒否
- pending_action期限切れ（410） → 送れない

---

## 9. 将来のn対n（配置/割当）への接続（設計上の保険）

清掃配置のようなn対nに近い問題は「Slots」ではなく「Assignments」になるが、構造は同じ。

- Proposal Version（提案バージョン）はそのまま使える
- PendingAction（確認必須）もそのまま使える
- Delivery（メール＋Inbox）もそのまま使える

違いは "候補" が時間ではなく割当（誰がどこへ）になるだけ。
よって Phase2の追加候補設計は **将来の配置最適化の基盤にもなる**。

| 概念 | 今回 | 将来（清掃） |
|------|------|-------------|
| Slot | 時間 | 時間＋場所 |
| Selection | 可/不可 | 担当可否 |
| Proposal | 候補日 | 配置案 |
| Finalize | 日程確定 | 担当割当確定 |

---

## 10. Phase2のDone条件（リリース判定）

- [ ] collecting時のみ追加候補が動く
- [ ] 追加候補は2回まで
- [ ] 既存回答が消えない（DB・UI）
- [ ] 全員に再通知（辞退除外）され、必須文言が入る
- [ ] 3語固定（送る/キャンセル/別スレッドで）で完結
- [ ] E2E 8ケースが全部PASS

---

## 確定した意思決定

| 項目 | 決定 |
|------|------|
| 再通知対象 | 全員（辞退除外） |
| 発動条件 | collecting のみ |
| 回数制限 | 最大2回 |
| 確定後やり直し | 原則なし（別スレッド誘導） |
| 意図判定 | 今はルール、将来AI |
