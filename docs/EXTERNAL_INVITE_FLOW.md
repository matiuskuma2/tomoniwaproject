# External Invite Flow (Spear/TimeRex型) 確定版

本ドキュメントは、サービス未登録者（外部の人）を日程調整に巻き込み、自然に「ともにわ」へ誘導（バイラル）するための UX / 画面 / 手順 を確定する。

**重要**: 現状の Dashboard / ThreadDetailPage / ThreadCreatePage は **OAuth 審査用の検証 UI** であり、最終形ではない。Phase Next-1 で /chat（チャットUIの器）を実装し、Phase Next-2/3 で最終UXを完成させる。

## 0. 目的

- 外部の人に「このサービスに登録して」ではなく **まず"URLで選ぶだけ"で日程調整が完了**する体験を提供
- 調整が成立した後に、必要なら自然にアカウント作成へ誘導する

## 1. 前提（関係性別の思想）

- **他人（未登録者）**:  
  - 予定の詳細は見せない
  - 「候補枠から選ぶ」「辞退する」だけ
  - これを入口に onboarding（アカウント作成）へ誘導

- **仕事仲間（登録者/room参加者）**:  
  - room内で共有（空き枠・タスク・提案）
  - 共有の粒度は permissions / room role で制御

- **家族（強い関係）**:  
  - 共有の粒度を高められる（将来）
  - ただしMVPは「詳細共有はしない（空き枠/参加可否中心）」が安全

## 2. 外部招待の基本フロー（確定）

### 2.1 主催者（ログイン済み）

1. **AI秘書に話す**  
   例：「Aさんを日程調整に誘って。候補は明日14時/明後日10時/金曜18時。CとEは必須、あと4人集まれば成立」

2. **システムが `POST /api/threads` を実行**し、以下を作成
   - `scheduling_threads`（スレッド）
   - `scheduling_slots`（候補枠）
   - `thread_attendance_rules`（参加条件）
   - `thread_invites`（invite token）

3. **メール送信（Queue）**
   - 件名：日程調整のお願い（○○）
   - 本文：リンク（/i/:token）＋「選ぶだけでOK」＋期限

### 2.2 外部参加者（未登録）

4. **メールのリンクを開く**（ログイン不要）
   - URL: `GET /i/:token`

5. **画面で操作**
   - 候補枠を選択（select）
   - または辞退（decline）
   - 名前入力は任意（display_name）

6. **送信**
   - `POST /i/:token/respond`

### 2.3 主催者へ通知・確定

7. **主催者に通知（Inbox）**
   - type: `scheduling_invite`
   - 「Aさんが 12/27 15:00 を選択しました」

8. **成立判定**
   - サーバが評価（AttendanceEngine）
   - 成立したら
     - `auto_finalize=true` → 自動確定
     - `auto_finalize=false` → 主催者に「確定しますか？」提案カード

9. **確定後**
   - `thread_finalize` 作成
   - 必要なら「確定通知メール」もQueue

## 3. 外部ページ（/i/:token）仕様

### 3.1 画面構成（最低限）

- **タイトル**（主催者の用意した `thread.title`）
- **説明**（`thread.description`）
- **候補枠リスト**（slot start/end）
- **ボタン**：
  - 「この日時でOK」
  - 「今回は参加できない」
- **注意文（安心設計）**
  - 「あなたの予定は主催者に公開されません」
  - 「このリンクは本人のみ利用してください」
  - 「期限：○日」

### 3.2 セキュリティ

- tokenは推測困難（32-64文字）
- token期限（例：72時間）
- 連投防止（rate limit）
- 1 token は 1 invite に紐づく（再利用は状態で制御）

## 4. "サービス誘導（アカウント作成）"の位置

外部参加者に対して、最初に登録を要求しない。

- **返信完了後に軽く表示**
  - 「次回からもっと簡単にするために無料アカウントを作成できます」
  - 「Googleで1分」

**導線は「強制」ではなく「自然」。**

## 5. メール文面（テンプレ）

### 5.1 招待メール（外部）

**件名**: `【日程調整】{thread.title}`

**本文（要点）**:
- ご依頼者（主催者名 or サービス名）
- 候補日程
- URL（/i/:token）
- 予定は公開されない旨
- 期限

### 5.2 リマインドメール

**件名**: `【リマインド】日程のご回答のお願い`

**本文**:
- 未回答の旨
- URL再掲
- 期限

## 6. "無料拡散"を阻害しないための条件

- 未登録者は「選ぶだけ」で完結
- 予定詳細は漏れない
- 返信・辞退のUXが軽い
- 返信状況を主催者がAIに聞ける（status/remind）

---

## 7. 実装でのチェックリスト（MVP）

- [ ] `/i/:token/respond` が `thread_selections` に正しく書く
- [ ] `AttendanceEngine` が status API で常に同じ結果を返す
- [ ] `remind` が pending を正しく抽出
- [ ] `auto_finalize` / `manual_finalize` が確定して `thread_finalize` を作る
- [ ] 確定後は二重確定しない（idempotent）
