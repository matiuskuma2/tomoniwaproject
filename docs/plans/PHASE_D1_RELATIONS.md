# Phase D-1: 関係者化（仕事仲間/家族）企画書

> **Version**: 2026-01-28 v0.1 (企画ドラフト)  
> **Status**: 企画確定中（実装前）  
> **目的**: R1/R2に進む前の土台 — 「人と人がこのアプリ内でどうつながるか」を定義

---

## 0. 企画の位置づけ（超重要）

### なぜこの企画が先？

```
❌ 間違った順序：
   予定調整 → 後から「この人は仕事仲間です」

⭕ 正しい順序：
   関係性を確立（相互承認） → その関係に応じた予定調整体験
```

**予定調整より先に必ず存在しないといけない土台**

---

## 1. 基本思想（ブレてはいけない原則）

### 原則①：関係は勝手に決めない

- ❌ AIが推測しない
- ❌ 片側申請で成立しない
- ⭕ **必ず双方の承諾が必要**

### 原則②：仕事仲間も家族も構造は同じ

違うのは「権限レベル」だけ。

| 観点 | 仕事仲間 | 家族 |
|------|----------|------|
| 承諾 | 必須 | 必須 |
| 距離感 | 中 | 近 |
| カレンダー参照 | 制限あり | 選択可（広い） |
| 自動投入 | ❌ | ⭕（許可した場合） |

→ 同じ「関係性モデル」から派生させる

### 原則③：関係値は「後付け」じゃなく「誘い方」で決まる

```
他人を誘う瞬間に、どういう関係として誘っているかを決める
```

---

## 2. 既存資産の棚卸し結果

### 2-1. 既存テーブル（使えるもの）

| テーブル | 用途 | 状態 |
|----------|------|------|
| `relationships` | user_a_id ↔ user_b_id の関係 | ✅ 存在（family/partner/stranger） |
| `relationship_requests` | 申請→承諾フロー | ✅ 存在（pending/accepted/declined） |
| `contacts` | 台帳（連絡先管理） | ✅ 存在（family/coworker/external） |
| `inbox` | アプリ内通知 | ✅ 存在（relationship_request type あり） |

### 2-2. 既存の関係タイプ

**relationships テーブル**:
- `family` / `partner` / `stranger`

**contacts テーブル**:
- `family` / `coworker` / `external`

### 2-3. 差分（追加が必要なもの）

| 項目 | 現状 | 追加提案 |
|------|------|---------|
| 関係タイプ | family/partner | + **workmate**（仕事仲間） |
| 権限セット | なし | **permissions_json** に構造化 |
| QRコード | なし | token + signature の生成 |
| 検索キー | メールのみ | + ユーザーID / 電話 |

---

## 3. 関係タイプの再定義

### 最終形（3種類 + 1）

| relation_type | 意味 | 日本語 |
|---------------|------|--------|
| `stranger` | 他人（未接続） | 他人 |
| `workmate` | 仕事仲間・知人 | 仕事仲間 |
| `family` | 家族 | 家族 |
| (`partner`) | パートナー（将来拡張） | — |

### 権限セット（family のみ必須）

```json
{
  "calendar_share": "none" | "freebusy" | "full",
  "auto_schedule": false | true
}
```

---

## 4. 関係成立フロー

### 4-1. フロー概要

```
[申請] A が B を「仕事仲間として」招待
    ↓
[通知] B のアプリ内（ベル）に通知
    ↓
[承諾] B が承認 → 関係成立
    ↓
[結果] 両者のリストに表示 + 予定調整がアプリ内完結可能に
```

### 4-2. 申請時の選択（主催者側）

```
この人をどういう関係として誘いますか？

○ 仕事仲間
○ 家族
```

※ UI的には「関係性を指定して招待する」だけでOK

### 4-3. 相手に届く通知

**仕事仲間の場合:**

```
🔔 〇〇さんが、仕事仲間としてあなたを招待しています

説明（小さく）:
仕事の予定調整をスムーズに行うための関係です。
（予定の中身は共有されません）

[承認] [拒否]
```

**家族の場合（権限選択あり）:**

```
🔔 〇〇さんが、家族としてあなたを招待しています

カレンダー共有の範囲を選んでください:

□ 共有しない（今まで通り）
□ 空いている時間だけ共有
□ 予定の書き込みを許可

[承認] [拒否]
```

### 4-4. 成立後の状態

**DBの状態:**

```sql
-- relationships
user_a_id: A
user_b_id: B
relation_type: 'workmate'
status: 'active'
permissions_json: '{"calendar_share": "none"}'
```

**できるようになること:**

| 関係 | できること |
|------|-----------|
| 仕事仲間 | アプリ内通知、チャット内AI秘書介在、freebusy内部参照 |
| 家族 | 上記 + 権限に応じた自動調整/自動投入 |

---

## 5. 招待フロー（3パターン）

### パターンA：ユーザー検索

```
[関係者 > 追加]
    ↓
検索（メール / ユーザーID）
    ↓
候補表示（アイコン + 名前）
    ↓
[追加] → 関係タイプ選択 → 申請送信
```

### パターンB：QRコード

```
[関係者 > QRコード]
    ↓
自分のQRを表示 / 読み取り
    ↓
読み取り側が関係タイプ選択 → 申請送信
```

**QRに含める情報:**
- user_id
- nonce（有効期限付き）
- signature（改ざん防止）

### パターンC：招待リンク（アプリ未利用者向け）

```
[招待リンクを発行]
    ↓
相手がアプリ登録
    ↓
登録後に関係申請に変換
```

※ これは既存の R0 フロー（外部URL）と統合

---

## 6. リスト表示（関係者一覧）

### 表示形式

```
👤 山田 太郎
[仕事仲間] ✔

👤 佐藤 花子
[家族] ✔

👤 鈴木 次郎
[他人]
```

### フィルタ

- 全員
- 仕事仲間のみ
- 家族のみ
- 他人のみ

### 既存との統合

現在の `contacts` テーブルのリスト表示に `relationship_type` バッジを追加するだけでOK

---

## 7. 関係性 × 予定調整の振る舞い

### R0：他人（stranger）

- 外部URL / メール / Slack
- Open Slots
- アプリ内通知 ❌
- **→ 今まで作ったもの（B-1〜B-5）はここ**

### R1：仕事仲間（workmate）

- アプリ内通知 ⭕
  - 「仕事仲間の〇〇さんから予定調整が来ています」
- freebusy 参照 ⭕（制限あり、中身は非公開）
- 候補生成はAIが内部で完結
- URLは「補助」

### R2：家族（family）

- アプリ内通知 ⭕
- freebusy 参照 ⭕（許可された範囲で）
- 自動で予定を入れる選択肢 ⭕（許可された場合）
- 調整フロー自体が短縮される

---

## 8. 通知設計

### 通知タイプ

| type | 用途 |
|------|------|
| `relationship_request` | 関係申請（既存） |
| `relationship_accepted` | 承認通知（追加） |
| `scheduling_invite` | 予定調整依頼（既存） |

### 通知の出し方

| 設定 | デフォルト |
|------|-----------|
| ベル通知 | ⭕ ON |
| チャットにも出す | ❌ OFF（設定で変更可） |

---

## 9. 今回「やらないこと」（明確に除外）

- ❌ 自動誘導（勝手にOpen Slotsに行く）
- ❌ AIが関係性を推測
- ❌ 片側承諾だけで関係成立
- ❌ カレンダー自動共有（承諾なし）
- ❌ 相互QR即成立（事故防止のため段階導入）

---

## 10. 実装時のPR分割案（参考）

### MVP（最小実装）

| PR | 内容 |
|----|------|
| D1-DB | relationships に workmate 追加、permissions_json 構造化 |
| D1-API | 関係申請/承諾/拒否 API |
| D1-UI | 関係者一覧にバッジ追加、申請モーダル |
| D1-NOTIFY | 申請/承認の通知 |

### 次段

| PR | 内容 |
|----|------|
| D1-QR | QRコード表示/読み取り |
| D1-SEARCH | ユーザーID検索 |
| D1-PERM | 家族権限の後から変更 |

---

## 11. 決定事項（確定）

| 項目 | 決定 |
|------|------|
| 関係タイプ | `stranger` / `workmate` / `family` の3種 |
| 承諾フロー | 必ず相互承認 |
| 検索キー | メール + ユーザーID |
| QR有効期限 | 10分（ワンタップ更新） |
| 通知デフォルト | ベルのみ（チャットはOFF） |

---

## 12. 次のアクション

1. この企画書の内容でOKか確認
2. UI/UXワイヤー作成（必要なら）
3. DB migration の詳細設計
4. 実装開始（PR-D1-DB から）

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-28 | v0.1 初版作成（企画ドラフト） |
