# Phase D-1: 関係者化（仕事仲間/家族）企画書

> **Version**: 2026-01-28 v1.0 (確定仕様)  
> **Status**: 🔵 Decision Required（4項目）  
> **PR**: #65

---

## 0. ゴール

- アプリ利用者同士が **相互承認** で「仕事仲間 / 家族」としてつながる
- つながった相手は **関係値が contacts/list に表示** される
- つながり申請/承認は **inbox（ベル通知）** で受け取る
- R0（他人）とは明確にUX/権限制御を分ける

---

## 1. 用語定義（最重要）

### 関係値（RelationshipType）

| 値 | 意味 | 対応フェーズ |
|----|------|-------------|
| `stranger` | 他人（未接続） | R0 |
| `workmate` | 仕事仲間 | R1 |
| `family` | 家族 | R2 |

> ⚠️ **AIは関係値を推測しない。必ずユーザーの明示 + 相手の承認で成立。**

### 権限プリセット（PermissionPreset）

| プリセット | カレンダー共有 | 書き込み | 用途 |
|-----------|---------------|---------|------|
| `workmate_default` | 空き時間のみ | ❌ | 仕事仲間（固定） |
| `family_view_freebusy` | 空き時間のみ | ❌ | 家族（控えめ） |
| `family_can_write` | 空き時間 | ⭕ | 家族（自動投入可） |

- 申請時に `family` は「どのプリセットか」選べる
- `workmate` は固定（まずは）

---

## 2. ユーザーストーリー

### US-1: 仕事仲間としてつながる

```
私（A）がBを仕事仲間として追加申請できる
  ↓
Bはベル通知で申請を受け、承認/拒否できる
  ↓
承認されたら双方の contacts/list に「workmate」表示がつく
```

### US-2: 家族としてつながる

```
AがBを家族として追加申請できる（権限プリセットを選択）
  ↓
Bはベル通知で申請を受け、権限の説明を見て承認/拒否できる
  ↓
承認されたら「family」表示＋プリセットに応じた後続機能が解放される
```

### US-3: 関係値の可視化

- contacts/list の行に「他人/仕事仲間/家族」が表示される
- フィルタで絞れる（例：仕事仲間のみ）

---

## 3. 申請フロー（3パターン）

### パターンA：検索で追加（メール or ユーザーID）

```
1. A：検索（email / user_id）
2. A：相手が見つかる → 「仕事仲間として追加」or「家族として追加」
3. A：申請送信（権限プリセット含む）
4. B：inboxに通知 → 承認/拒否
```

| メリット | 前提 |
|---------|------|
| 最短 | 相手がアプリ利用者 |

### パターンB：QRで追加（対面）

```
1. A：マイQR表示（10分有効）
2. B：QR読み取り → 申請画面へ
3. B：関係タイプを選択（workmate/family）→ 送信
4. A：inboxで承認/拒否
```

| メリット | 前提 |
|---------|------|
| メールを知らなくてもOK | 双方ログイン済み |

### パターンC：招待リンク（相手が未利用でもOK）

```
1. A：招待リンク発行（workmate/familyの意図だけ持つ）
2. B：リンクを開く → 未ログインならサインアップ誘導
3. サインアップ完了後、申請として処理（inboxで承認）
```

| メリット | 注意 |
|---------|------|
| R0→R1/R2の自然導線 | 相手に関係値は押し付けない（最終は承認） |

---

## 4. 通知（inbox）設計

### 通知タイプ

| type | 用途 |
|------|------|
| `relationship_request_received` | 申請受信 |
| `relationship_request_accepted` | 承認された |
| `relationship_request_declined` | 拒否された |

### デフォルト

- ✅ ベル通知のみ
- ❌ チャットへの割り込みはしない（将来オプション）

### 通知に載せる情報（最低限）

- 申請者名
- 関係タイプ（workmate/family）
- familyの場合：権限プリセットの説明（空き共有のみ / 書き込み可）

---

## 5. UI要件（最小）

### contacts/list 表示

- 関係バッジ：`他人` / `仕事仲間` / `家族`
- フィルタ：関係値で絞り込み（任意だが早期に入れたい）

### 承認画面

- 「承認」「拒否」2択
- family の場合だけ、申請時に選ばれた権限の説明を必ず表示

---

## 6. 既存資産の利用（棚卸し結果）

> 今回のD-1は「新規で作る」より「既存の線をつなぐ」が中心

### 既存テーブル

| テーブル | 用途 | 状態 |
|----------|------|------|
| `relationship_requests` | 申請 | ✅ 存在（pending/accepted/declined） |
| `relationships` | 成立済み | ✅ 存在（family/partner/stranger） |
| `contacts` | 台帳SSOT | ✅ 存在（family/coworker/external） |
| `inbox` | 通知SSOT | ✅ 存在（relationship_request type あり） |

### 追加が必要なもの

| 項目 | 内容 |
|------|------|
| 関係タイプ | `workmate` を追加 |
| 権限プリセット | `permission_preset` カラム or JSON |
| QRコード | token + signature の生成 |

---

## 7. 実装PR分割

### PR-D1-DB

**目的**: workmate追加＋権限プリセット保存先確定

| 作業 | 詳細 |
|------|------|
| enum追加 | `relationships` / `relationship_requests` に `workmate` |
| 権限保存 | family用 `permission_preset` を保持（JSON or enum） |

**DoD**:
- [ ] migrate-local / remote適用
- [ ] 既存データ互換OK

### PR-D1-API

**目的**: 申請/承認/拒否のAPI

| エンドポイント | 用途 |
|---------------|------|
| `POST /api/relationships/request` | 申請送信 |
| `POST /api/relationships/:token/accept` | 承認 |
| `POST /api/relationships/:token/decline` | 拒否 |
| `GET /api/relationships` | 一覧取得 |

**DoD**:
- [ ] requireAuth境界OK
- [ ] inboxに通知が積まれる

### PR-D1-UI

**目的**: 関係値表示＋申請導線

| 作業 | 詳細 |
|------|------|
| バッジ | contacts/list に関係バッジ追加 |
| 導線 | 検索/QR/リンク（まずは検索だけでも可） |

**DoD**:
- [ ] 関係値が一覧に出る
- [ ] 申請送信できる

### PR-D1-NOTIFY

**目的**: 通知体験を完成させる

| 作業 | 詳細 |
|------|------|
| inbox | 申請→承認/拒否導線 |
| 更新 | 承認後にcontactsの関係値が更新される |

**DoD**:
- [ ] 通知→承認→成立→一覧反映まで通る

---

## 8. 仕様で「やらない」こと（明記）

- ❌ AIが関係値を推測して自動設定
- ❌ 片側だけで関係成立
- ❌ 家族の「自動投入」をD-1で実装（D-2以降）
- ❌ チャットに割り込み通知（ベルのみ）
- ❌ 自動誘導（勝手にOpen Slotsに行く）

---

## 9. 🔵 Decision Required（要決裁）

以下4項目について、`Yes` / `No` / `要修正` で決定をお願いします。

### Decision 1: 関係タイプ

> 関係タイプは `stranger` / `workmate` / `family` の3つで固定してOK？

- [ ] Yes
- [ ] No（理由：                    ）

### Decision 2: 権限プリセット

> familyは申請時に `permission_preset`（空き共有のみ / 書き込み可）を選ばせるでOK？

- [ ] Yes
- [ ] No（理由：                    ）

### Decision 3: 通知方式

> 通知は **ベルのみ** をデフォルトでOK？（チャット割り込みは後回し）

- [ ] Yes
- [ ] No（理由：                    ）

### Decision 4: 初期実装スコープ

> 申請方法の初期実装は **検索（メール/ID）から開始** でOK？（QR/リンクは次PRでも可）

- [ ] Yes
- [ ] No（理由：                    ）

---

## 10. 関係性 × 予定調整の振る舞い（参考）

### R0: 他人（stranger）

- 外部URL / メール / Slack
- Open Slots
- アプリ内通知 ❌
- **→ B-1〜B-5で実装済み**

### R1: 仕事仲間（workmate）

- アプリ内通知 ⭕
  - 「仕事仲間の〇〇さんから予定調整が来ています」
- freebusy 参照 ⭕（制限あり、中身は非公開）
- 候補生成はAIが内部で完結
- URLは「補助」

### R2: 家族（family）

- アプリ内通知 ⭕
- freebusy 参照 ⭕（許可された範囲で）
- 自動で予定を入れる選択肢 ⭕（許可された場合）
- 調整フロー自体が短縮される

---

## 変更履歴

| 日付 | Version | 内容 |
|------|---------|------|
| 2026-01-28 | v0.1 | 初版作成（企画ドラフト） |
| 2026-01-28 | v1.0 | 確定仕様化、Decision項目追加 |
