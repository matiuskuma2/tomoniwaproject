# SCHEDULING_RULES.md
## ToMoniWao – 日程調整ロジック定義（破壊禁止）

最終更新日: 2025-12-29  
ステータス: 確定（UX / AIロジックの正）

---

## 1. このドキュメントの目的

本ドキュメントは以下を定義する：

- 日程調整の「本質的なロジック」
- AIが調整を行う際の判断基準
- 無限調整・迷走を防ぐための制約

👉 **DB / API / マイグレーションは一切変更しない**  
👉 本ドキュメントは「判断ロジックと運用ルール」のみを扱う

---

## 2. 日程調整の本質

日程調整とは以下の処理である：

- 候補日時を生成する
- 各参加者の意思（OK / NG / 未回答）を集める
- 条件を満たす日時を決定する
- 条件を満たさない場合は再調整する

👉 **UIではなく、AI内部のループ処理が本体**

---

## 3. 調整条件の3分類（固定）

### A. AND条件（全員参加必須）

例：
- 家族旅行
- 取締役会
- 全員必須の重要会議

成功条件：
- 全員が OK の日時が存在すること

失敗条件：
- 全員OKの日時が存在しない

---

### B. CORE条件（コアメンバー必須）

例：
- 主催者 + 上司
- 講師 + 主催者

成功条件：
- コアメンバー全員が OK
- その他は任意

失敗条件：
- コアメンバーのいずれかが NG

---

### C. MAX条件（参加率最大化）

例：
- 勉強会
- セミナー
- 懇親会

成功条件：
- 参加人数が最大となる日時を選択

失敗条件：
- 主催者が「開催不可」と判断した場合のみ

---

## 4. 調整回数の上限（最重要）

### Negotiation Budget（固定）

- 調整は **最大2回まで**
  - Round 1：初回提案
  - Round 2：再提案（1回のみ）

### ルール
- Round 2でも成功条件を満たさない場合：
  - 調整失敗として終了
  - それ以上の自動調整は禁止

👉 **無限再調整は禁止**

---

## 5. 関係性ごとの適用ルール

| 関係性 | 調整ループ | 備考 |
|------|----------|------|
| 家族 | 原則なし | 自動確定。変更は別依頼 |
| 仕事仲間 | 最大2回 | AIが空き時間を考慮 |
| 他人 | 最大2回 | 原則1回＋再提案1回 |

---

## 6. 失敗時の扱い（固定）

調整失敗時：

- AIは理由を要約して報告
- 新しい候補生成は **別の依頼** として扱う
- 同一スレッドでの無限継続は禁止

例：
> 「2回調整しましたが、条件を満たす日時が見つかりませんでした」

---

## 7. DB / APIとの関係

- Threads = 調整プロセスの器
- Selections = 各参加者の回答履歴
- Status = 集計結果（計算結果）

👉 本ルールは **既存データ構造で完全に表現可能**

---

## 8. 禁止事項（事故防止）

- 調整回数をユーザーに強制的に増やす
- 条件（AND/CORE/MAX）をUI選択にさせる
- APIやDBをUX都合で変更する

---

## 9. まとめ

- 日程調整は「AI内部の有限ループ」
- 条件は3種類、回数は最大2回
- 失敗は失敗として終了させる
- UIは結果を見せるだけ

👉 **このルールは変更しない**

---

## 10. 調整ラウンド（最大2回）の定義（超重要・解釈ブレ禁止）

本プロダクトにおける「最大2回」とは、  
**候補提示と回答収集を行う「提案ラウンド（Round）」の回数**を指す。

これは UI 操作回数でも、個々の返信回数でもない。

---

### 10.1 調整ラウンドの構造

日程調整は以下のループ構造を持つ。

**Round N:**
1. 候補日時を提示する
2. 対象者から回答を収集する
3. 調整条件（AND / CORE / MAX）を評価する
4. 条件を満たせば確定、満たさなければ次ラウンドへ

---

### 10.2 Round 1（初回調整）

- 主催者または AI により候補日時が提示される
- 対象者が回答（参加可否・希望枠）を行う
- 回答が揃い次第、条件評価を行う

#### 判定結果
- 条件を満たす → **確定**
- 条件を満たさない → **Round 2 に進行**

---

### 10.3 Round 2（再調整）

- Round 1 の結果を踏まえて候補を再生成・再提示する
- 再度、対象者から回答を収集する
- 再度、条件評価を行う

#### 判定結果
- 条件を満たす → **確定**
- 条件を満たさない → **調整失敗として終了**

---

### 10.4 調整失敗の定義

以下の場合、調整は **失敗** として終了する。

- Round 2 終了時点で条件を満たさない
- 対象者の未回答・拒否により条件成立が不可能
- external（他人）調整において、再調整が拒否された

失敗時は以下を行う：

- スレッドは「失敗」または「未確定」状態として扱う
- 追加の再調整は **同一スレッドでは行わない**
- 再調整を行う場合は **新しいスレッドを生成する**

---

### 10.5 関係性別の再調整可否ルール

#### family（家族）
- 原則として再調整ラウンドは不要
- AI が自動的に予定を確定・登録する
- 後からの変更は「予定変更」として別扱い

#### coworker（仕事仲間）
- Round 1 / Round 2 の再調整を許可
- AI が空き時間を参照して再提示を行う
- Round 2 失敗時は調整終了

#### external（他人）
- 原則 Round 1 のみ
- 例外的に Round 2 を **1回だけ許可**
- Round 2 失敗時は必ず終了（無限再調整禁止）

---

### 10.6 無限調整を禁止する理由（設計思想）

- 外部ユーザーへの再通知は UX を著しく損なう
- 調整が終わらない状態は「秘書」として失格
- 実世界の調整と同様、「区切り」を持たせることが重要

そのため、本プロダクトでは：

> **調整は最大2回まで。  
> それ以上は新しい調整として扱う。**

というルールを採用する。

---

### 10.7 UI / API / DB への影響範囲

本ルールは以下を **変更しない**：

- DB スキーマ
- 既存 API の URL / レスポンス
- マイグレーションファイル

調整回数は：

- **AI の内部状態**
- **スレッド運用ルール**
- **UX 表現**

として扱い、  
DB や API に「回数カラム」を強制的に持たせない。

---

### 10.8 このルールを破ってはいけないケース

以下は禁止とする：

- Round 3 以降を同一スレッドで継続すること
- external に無制限の再調整通知を送ること
- UI で「再調整を続ける」選択肢を常時表示すること
- 調整条件（AND / CORE / MAX）を UI で選ばせること

---

👉 **この調整ラウンド定義は変更しない**  
👉 **例外を作る場合は必ず設計レビューを行う**

---

## 11. 現状（Phase 0B MVP）の実装状況

### 実装済み
- ✅ external の MAX 型（主催者が手動で確定）
- ✅ 候補日時の生成（POST /api/threads で3つの候補を自動生成）
- ✅ 票数の集計（GET /api/threads/:id/status）
- ✅ 主催者による確定（POST /api/threads/:id/finalize）
- ✅ 再調整の基盤（thread_selections に複数回の回答を保存可能）

### 未実装（Phase Next で対応予定）
- ❌ AND/CORE の自動判定
- ❌ AI 調整ループ（現状は主催者が手動で「確定しない」を選択可能）
- ❌ 調整回数の自動制御（現状は運用で 2 回まで）
- ❌ 調整失敗時の自動終了メッセージ

### 調整回数について
現状は **運用で 2 回まで** という方針になっている：

1. **Round 1**: 初回の候補日時を送付
2. **Round 2**: 主催者が「確定しない」を選択 → 新規 thread で再調整

**Phase Next-2** で AI が調整ループを自動化する際に、コード側で回数制限を実装する。

### 調整条件の UI 表示について
現状は **UI に調整条件（AND/CORE/MAX）の選択欄はない**（✅ 正しい状態）。

最終形では AI が自然言語から条件を判定するため、UI で選択させることはない。

👉 **現状は「主催者が手動確定」で問題なく動作している**

---
