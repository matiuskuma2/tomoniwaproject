# SCHEDULING_RULES.md
## ToMoniWao – 日程調整ロジック定義（破壊禁止）

最終更新日: 2025-12-29  
ステータス: 確定（UX / AIロジックの正）

---

## 1. このドキュメントの目的

本ドキュメントは以下を定義する：

- 日程調整の「本質的なロジック」
- AIが調整を行う際の判断基準
- 無限調整・迷走を防ぐための制約

👉 **DB / API / マイグレーションは一切変更しない**  
👉 本ドキュメントは「判断ロジックと運用ルール」のみを扱う

---

## 2. 日程調整の本質

日程調整とは以下の処理である：

- 候補日時を生成する
- 各参加者の意思（OK / NG / 未回答）を集める
- 条件を満たす日時を決定する
- 条件を満たさない場合は再調整する

👉 **UIではなく、AI内部のループ処理が本体**

---

## 3. 調整条件の3分類（固定）

### A. AND条件（全員参加必須）

例：
- 家族旅行
- 取締役会
- 全員必須の重要会議

成功条件：
- 全員が OK の日時が存在すること

失敗条件：
- 全員OKの日時が存在しない

---

### B. CORE条件（コアメンバー必須）

例：
- 主催者 + 上司
- 講師 + 主催者

成功条件：
- コアメンバー全員が OK
- その他は任意

失敗条件：
- コアメンバーのいずれかが NG

---

### C. MAX条件（参加率最大化）

例：
- 勉強会
- セミナー
- 懇親会

成功条件：
- 参加人数が最大となる日時を選択

失敗条件：
- 主催者が「開催不可」と判断した場合のみ

---

## 4. 調整回数の上限（最重要）

### Negotiation Budget（固定）

- 調整は **最大2回まで**
  - Round 1：初回提案
  - Round 2：再提案（1回のみ）

### ルール
- Round 2でも成功条件を満たさない場合：
  - 調整失敗として終了
  - それ以上の自動調整は禁止

👉 **無限再調整は禁止**

---

## 5. 関係性ごとの適用ルール

| 関係性 | 調整ループ | 備考 |
|------|----------|------|
| 家族 | 原則なし | 自動確定。変更は別依頼 |
| 仕事仲間 | 最大2回 | AIが空き時間を考慮 |
| 他人 | 最大2回 | 原則1回＋再提案1回 |

---

## 6. 失敗時の扱い（固定）

調整失敗時：

- AIは理由を要約して報告
- 新しい候補生成は **別の依頼** として扱う
- 同一スレッドでの無限継続は禁止

例：
> 「2回調整しましたが、条件を満たす日時が見つかりませんでした」

---

## 7. DB / APIとの関係

- Threads = 調整プロセスの器
- Selections = 各参加者の回答履歴
- Status = 集計結果（計算結果）

👉 本ルールは **既存データ構造で完全に表現可能**

---

## 8. 禁止事項（事故防止）

- 調整回数をユーザーに強制的に増やす
- 条件（AND/CORE/MAX）をUI選択にさせる
- APIやDBをUX都合で変更する

---

## 9. まとめ

- 日程調整は「AI内部の有限ループ」
- 条件は3種類、回数は最大2回
- 失敗は失敗として終了させる
- UIは結果を見せるだけ

👉 **このルールは変更しない**

---
