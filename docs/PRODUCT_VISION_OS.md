# PRODUCT_VISION_OS.md

**tomonowa プラン設計・仕様確定 v1.2-final（改訂確定版）**

**（開発チーム向け / 初見で誤解しない / 仕様・用語・UX・距離感・プラン差・台帳・RAG・権限まで統合）**

---

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| バージョン | v1.2-final |
| 作成日 | 2026-01-01 |
| ステータス | ✅ 確定（唯一の正解） |
| 更新履歴 | v1.1→v1.2: 修正①②③を反映 |

### 主要な修正（v1.1→v1.2）
- **修正①**: Contact参照関係の矛盾を解消（Schedule.participantsはcontact_id参照で固定）
- **修正②**: external予約モードの「確定」を明確化（仮確定pending→主催者確定→confirmed）
- **修正③**: team定義を明文化（共有カレンダー（free/busy以上）が成立している集合を前提）

---

## 目的（Why）

tomonowa は「カレンダーに予定を入れるツール」ではなく、
関係性（距離感）に応じて、AI秘書が"安全に"日程調整を媒介し、必要な場合にのみ実行まで行うプロダクトである。

この仕様は、以下を同時に満たすために存在する。
- 初対面（external）でも事故らない（勝手に入れない／勝手に送らない）
- 仕事仲間（work/team）は "手間を減らす" 方向に踏み込める（ただし同意と制御がある）
- 家族（family）は "先に入れて後で伝える" も許容する（ただし関係性が前提）
- 1対1だけでなく **1対N（イベント/招集/案内）**が破綻しない
- 顧客台帳・名刺・接点が増えてもスケールできる
- 課金・APIコスト・権限・監査が後付けで破綻しない
- PWA前提だが 将来のネイティブアプリ化を見据えて設計が壊れない

---

## 0. 用語定義（最重要：曖昧にしない）

### 0-1. Thread（スレッド）
- AI秘書に話しかける 文脈の単位
- 人同士の雑談スレではない（AI秘書への指示・確認・実行の場）
- 例：
  - 「初回商談リンク（予約モード）」
  - 「チーム定例（投票モード）」
  - 「Aさんとの1on1」
  - 「家族：学校行事」

Thread は "会話の文脈" を管理する。
予定そのものは Schedule が持つ。

---

### 0-2. Schedule / Instance（予定）
- 実際に確定・変更・キャンセルされる 1件の予定
- 必須属性：
  - 日時（開始/終了/タイムゾーン）
  - 参加者
  - 状態（募集中 / 投票中 / 確定 / 変更依頼 / キャンセル）
  - 成立条件（全員必須 / N人以上 / キーマン必須 など：※1対Nで必要）

※ 誘われた側（参加者）が触るのは Scheduleだけ。Threadは選ばせない。

---

### 0-3. Link（リンク）

外部の人（external）や、ツール未利用者に提示する 入口。

Linkは モードを持つ（ここが確定）：
- **予約モード**（商談/相談/1対1が主）
  - 相手が候補から選択 → **Schedule生成（仮確定：pending状態）**
  - **主催者の「確定」アクション** または **締切で最終確定**（calendar登録は最終確定後のみ）
  - ※ external には「勝手に主催者カレンダー登録しない」ガードを維持
- **投票モード**（多人数/イベント/招集）
  - 投票 → 成立条件＋現実優先（FreeBusy）で AIが確定 → Schedule生成/確定

"Linkは原則合意形成" ではなく、予約モード/投票モードの二形態で固定する。
これにより商談リンクとイベント招集が同居できる。

---

### 0-4. Card（カード）
- Thread内で起きている Schedule の状態を、右ペインに視覚化するUI
- カードは「いま何が起きているか」を見るためにある（チャットの補助）

---

### 0-5. Calendar（カレンダー）
- 確定済み予定を確認する画面
- "空き計算結果ビュ-"は作らない（見せない）
- 空きの計算・統合はAIが裏で行い、ユーザーには結論（提案/確定/注意）を出す

---

### 0-6. Contact（顧客台帳 / 人）
- 各ユーザーが所有する 関係者データ（台帳）
- 取り込み元（将来含む）：
  - 名刺
  - メール
  - Slack / Chatwork（ID）
  - 手入力
- Contact は "関係値とルールの蓄積" の器でもある（将来的にRAGのコアになる）

**重要：参照関係（これで固定）**
- **Schedule は参加者として Contact を参照する**（participants.contact_id）
- Thread / Link は必要に応じて Contact を参照してよい（必須ではない）

**固定のデータ構造：**

```
User
 ├─ Contacts（顧客台帳）
 ├─ Threads（会話文脈）
 ├─ Links（外部向け入口）
 ├─ Schedules（予定）
 │   └─ Participants（contact_id参照）
 └─ Policies（本人ルール / RAG参照）
```

※ Scheduleは参加者としてContactを参照する。ContactとScheduleは直接紐づかないという記述は誤りのため削除。

---

## 1. UI/UX（固定構成）

UIは以下で固定する（ブレさせない）。
- **左**：Thread一覧（文脈切替）
- **中央**：AI秘書チャット（指示 → 確認 → 実行）
- **右**：Card（Schedule状態）
- **別タブ**：Calendar（確定予定）

### 1-1. チャット（中央）の原則
- チャットは人同士の雑談ではなく、AI秘書に指示を出す場所
- AIは必ず：
  1. 意図確認
  2. 実行確認
  3. 実行
- 例外：Enterprise＋丸投げON（明示設定時のみ）

---

## 2. 距離感（Relationship）と挙動の固定

距離感は AIが「どこまで踏み込んで良いか」を決める一次概念。

**重要：teamの定義**
- **team は「共有カレンダー（free/busy以上）が成立しているメンバー集合」を前提にする**

| 距離感 | 意味 | AIの原則 |
|--------|------|----------|
| external | 初対面/外部 | 案内中心（リンク）。勝手に登録しない |
| work | 仕事仲間（個別同意） | 確認付き自動登録（Pro以上） |
| team | チーム（共有前提） | 共有カレンダー（free/busy以上）前提で自動確定・登録（Team以上） |
| family | 家族 | 確認なし自動登録（Pro以上） |

### 2-1. 昇格（external→work→team / family）は自動禁止
- external → work も、work → team も、必ず同意が必要
- 同意なしでAIが踏み込みを強めることはない

---

## 3. 多人数調整（1対N）の仕様

### 3-1. 原則：現実優先
- 多数決より FreeBusy（現実の空き）を優先
- 空いていない枠は採用しない（票が多くても不可）

### 3-2. 成立条件（必須）

Schedule は成立条件を持てる。
- 全員必須
- N人以上で成立
- キーマン必須（特定Participant）

### 3-3. 確定のタイミング（例）
- 締切到来
- 逆転不可能
- キーマン投票完了
- 条件達成

---

## 4. 誘われた側UX（破綻防止の核心）

### 4-1. 誘われた側は Thread を選ばない

誘われた側がやりたいことは基本3つだけ：
- 変更したい
- キャンセルしたい
- ひとこと伝えたい

### 4-2. 入口
- メール
- Slack / Chatwork（将来）
- カレンダー通知（同期後）
- **参加者用URL**：`/i/{schedule_id}`

### 4-3. 参加者の発言の紐付け（A方式・固定）
- 参加者の「変更したい」等の発言は 直近のScheduleに自動紐付け
- 複数候補がある場合だけ聞き返す

### 4-4. 距離感別の変更/キャンセル処理
- **external**：主催者へ確認依頼（勝手に入れ替えない）
- **work/team**：AIが空きを探して再提案（条件次第で登録）
- **family**：即変更・即キャンセル反映

---

## 5. 送信チャネル（将来の前提をここで固定）

現状はメール中心だが、設計として以下を最初から前提にする。
- Email（現状）
- Slack（IDが分かる場合）
- Chatwork（IDが分かる場合）
- Zoom（会議URL生成/連携：将来）

### 5-1. externalの基本は「リンク送付」
- externalに対しては基本リンクで誘う（ツール未利用でも成立）
- ただし、Slack/Chatworkで繋がってIDが分かるなら、そこに招待リンク送付も可能

### 5-2. 距離感の"勝手な昇格"は禁止
- externalがツールを使ったとしても、自動で work/team/family にはならない
- work/team/familyにするには 別途同意が必要

---

## 6. AIが把握する「事情・ルール」(RAGイメージ)

将来的に AI は各ユーザーごとのRAGを持つ（最終像）。

RAGに入るのは：
- ユーザーのルール（例：来週午後ならOK、午前NG、家族は先入れOK など）
- Contacts（顧客台帳）に紐づく関係値
- 過去のやり取りで確定した"決め事"

入れない：
- 雑談ログ（ただの会話）
- 推測した個人属性

---

## 7. BYO API（OpenAI/Gemini）とコスト制御

### 7-1. 趣旨

AIコストを運営が固定で持たず、ユーザーが自分のAPIキーで使えるようにする。

### 7-2. 仕様
- 全プランでAPIキー設定可
- APIキー設定時：
  - 意図理解・補正・会話はユーザー負担で回数制限なし
  - 実行権限（勝手に確定/送信/登録）は プラン×距離感×同意で制御

---

## 8. MBTI / 占い（判断補助として固定）

原則：
- 当てない
- 自動決定しない
- 文面トーンや接し方のヒントのみ

---

## 9. プラン（Free/Pro/Team/Enterprise）

価格は確定：
- **Free**：¥0
- **Pro**：¥980/月
- **Team**：¥2,980/月
- **Enterprise**：¥15,000/月

（※制限値は後から調整可能だが、制御単位は固定しておく）

詳細は `docs/BILLING_AND_LIMITS.md` を参照。

---

## 10. カレンダー同期（Next-7：審査完了後）

**固定文（ここが抜けると揉めるので本文に入れる）**
- カレンダー同期は 「確定後のみ」
- 冪等キー：`thread_id + schedule_id`（または `final_slot_id`）
- 失敗時は 手動フォールバック（登録セット） を返す

※ 本実装はOAuth審査完了後に行う（Next-7 Day1）。

---

## 11. 権限構造（admin / superadmin）

- **User**：admin（自分の世界の管理者）
- **SuperAdmin**：
  - 全ユーザー管理
  - APIコスト管理
  - 課金管理（範囲分け）
  - 監査ログ/停止

**重要注記**
- 現フェーズでは **superadminは運営者1名を前提**
- "複数superadmin運用"は将来の運営拡大時に別途定義する
  （現時点ではUI提供対象ではない／内部運用目的）

詳細は `docs/SUPERADMIN_SPEC.md` を参照。

---

## 12. スケーラビリティとデータ増加（必須の設計原則）

本プロダクトは「人数×やり取り×台帳」でデータが爆増する前提。

### 制御単位（固定）
- **User単位**：台帳・ルール・課金
- **Thread単位**：文脈・履歴
- **Schedule単位**：実行状態・成立条件・参加者

### ログとメトリクス
- 実行前チェック
- 実行ログ（監査）
- 使用量（課金/制限）

### セキュリティ
- APIキー暗号化保存・マスク表示・即削除
- Relationship昇格は必ず同意

詳細は以下を参照：
- `docs/BILLING_AND_LIMITS.md`
- `docs/RELATIONSHIP_POLICY.md`
- `docs/CHAT_DATA_CONTRACT.md`
- `docs/LOGGING_AND_RETENTION.md`

---

## 13. これを「唯一の正解」にする条件（運用ルール）

この文書を唯一の正解にして良いが、以下のルールを必ず併設する：
- **仕様変更は PR で差分を出す**
- **用語定義（0章）と距離感（2章）を変える場合は影響範囲を必ず列挙**
- **誘われた側UX（4章）を壊す変更は禁止（最重要）**

---

## 参照文書

この仕様を補完する詳細文書：
- `docs/BILLING_AND_LIMITS.md` - 制限単位・上限・計測・超過時挙動
- `docs/RELATIONSHIP_POLICY.md` - 距離感昇格と同意の詳細
- `docs/INVITEE_UX_SPEC.md` - 誘われた側UX仕様（A方式）
- `docs/SUPERADMIN_SPEC.md` - 運営者向け管理仕様
- `docs/DEVELOPMENT_ROADMAP.md` - 開発計画（審査待ち期間）
- `docs/CHAT_DATA_CONTRACT.md` - チャットデータ契約（増えても壊れない）
- `docs/LOGGING_AND_RETENTION.md` - ログ分離とRetention方針

---

## 次にやること（開発チームに渡す前提で固定）

1. この v1.2-final を `docs/PRODUCT_VISION_OS.md` として保存
2. 併設ファイルとして以下を作成：
   - `docs/BILLING_AND_LIMITS.md`
   - `docs/RELATIONSHIP_POLICY.md`
   - `docs/INVITEE_UX_SPEC.md`
   - `docs/SUPERADMIN_SPEC.md`

---

## 開発チーム向けの短い一言（Slack貼り付け用）

tomanowaは「AI秘書が距離感（external/work/team/family）に応じて安全に調整を媒介し、プランと同意の範囲で実行まで行う」プロダクトです。

**team は「共有カレンダー（free/busy以上）が成立しているメンバー集合」を前提にします。**

Linkは **予約モード（相手選択→仮確定pending→主催者確定で最終確定）** / **投票モード（投票→AI確定）** を持ちます。

参加者（誘われた側）はThreadを選ばず、`/i/{schedule_id}`で直近予定に紐づけて変更/キャンセルできます（A方式）。

**Contacts（顧客台帳）はSchedule参加者がcontact_id参照する前提です。**

カレンダー同期は確定後のみ、冪等キーは`thread_id + schedule_id`（or `final_slot_id`）、失敗時は手動フォールバック。

---

**END OF DOCUMENT**
