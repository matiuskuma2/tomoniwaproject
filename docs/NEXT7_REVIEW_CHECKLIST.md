# NEXT7_REVIEW_CHECKLIST.md
Next-7 Review & Release Checklist

**Phase**: Next-7 Day0 (Design)  
**Purpose**: 審査完了後に Day1 実装へ進むための必須チェック項目

---

## A. OAuth / 審査

### A1. スコープ定義
- [ ] 必要スコープを最小化して定義した
  - `https://www.googleapis.com/auth/calendar.events.owned`
  - （Read-only scope は不要）
- [ ] スコープの用途を明確に説明した
- [ ] 不要なスコープを要求していない

### A2. Google 審査
- [ ] Google OAuth 審査が完了した
- [ ] 審査で指摘された修正を完了した
- [ ] 本番環境で OAuth が動作する

### A3. 既存ユーザー対応
- [ ] 既存ユーザーの再同意が不要 or 導線がある
- [ ] 再同意の導線が明確（UI/UX確認済み）
- [ ] 再同意しないユーザーへのフォールバックがある

---

## B. 実装前チェック

### B1. トリガー条件
- [ ] 同期は `confirmed` スレッドのみ
- [ ] `final_slot_id` が存在する場合のみ
- [ ] ユーザー操作トリガーのみ（自動同期なし）

### B2. 冪等性
- [ ] 冪等キーが `thread_id + final_slot_id` である
- [ ] 同じキーで複数回実行しても同じ結果
- [ ] D1 テーブル `calendar_syncs` の設計が完了

### B3. 差分更新禁止
- [ ] 差分更新をしない設計になっている
- [ ] 初回作成のみを実装する
- [ ] 将来の拡張（Day2）として差分更新を計画

### B4. A案フォールバック
- [ ] 失敗時に手動登録用の情報セットを返す
- [ ] エラーで止めない設計
- [ ] UI で手動登録を案内できる

---

## C. DoD（実装Day1）

### C1. 正常系
- [ ] 初回同期 → `status: "created"`
- [ ] 再同期 → `status: "already_synced"`（冪等）
- [ ] `calendar_event_id` が返る
- [ ] `meet_url` が返る（Meet生成成功時）

### C2. 失敗系
- [ ] OAuth未許可 → `status: "failed"` + 手動セット
- [ ] API失敗 → `status: "failed"` + 手動セット
- [ ] 制限超過 → `status: "failed"` + 手動セット

### C3. UI確認
- [ ] 「カレンダーに同期」ボタンが表示される
- [ ] 同期済みの場合は「同期済み」表示
- [ ] 失敗時の手動登録案内が表示される

---

## D. リグレッション（必須）

### D1. Next-6 への影響
- [ ] Next-6 の通知/提案に影響しない
- [ ] 自動送信は一切発生しない
- [ ] `pendingNotify` / `pendingRemind` が壊れない

### D2. モバイルUI
- [ ] スマホで同期ボタンが押せる
- [ ] スマホで結果が表示される
- [ ] レスポンシブデザインが崩れない

### D3. 既存機能
- [ ] スレッド作成が正常に動作する
- [ ] 投票が正常に動作する
- [ ] 確定が正常に動作する

---

## E. ロールバック

### E1. 機能フラグ
- [ ] `FEATURE_CALENDAR_SYNC_ENABLED` フラグで完全停止できる
- [ ] フラグOFFで同期ボタンが非表示になる
- [ ] フラグOFFでも既存機能は動作する

### E2. データ保護
- [ ] 既存データに影響が出ない
- [ ] `calendar_syncs` テーブルのロールバックスクリプトがある
- [ ] 同期済みイベントは手動削除が必要（自動削除なし）

---

## F. セキュリティ

### F1. OAuth トークン
- [ ] トークンは暗号化保存
- [ ] ユーザーごとにトークン管理
- [ ] リフレッシュトークンの有効期限管理

### F2. 認可
- [ ] 他人のスレッドは同期不可（403 Forbidden）
- [ ] organizer_user_id のチェックが入っている

---

## G. 監査ログ

### G1. 記録項目
- [ ] `thread_id` が記録される
- [ ] `final_slot_id` が記録される
- [ ] 実行ユーザー（`organizer_user_id`）が記録される
- [ ] 実行日時（`synced_at`）が記録される
- [ ] 結果（`created` / `already_synced` / `failed`）が記録される
- [ ] 失敗理由（`failure_reason`）が記録される

---

## H. ドキュメント

### H1. 設計ドキュメント
- [x] `SYNC_RUNBOOK.md` が完成している
- [x] `SYNC_API_SPEC.md` が完成している
- [x] `NEXT7_REVIEW_CHECKLIST.md` が完成している

### H2. 実装ドキュメント（Day1作成）
- [ ] API 実装手順書
- [ ] D1 マイグレーションスクリプト
- [ ] OAuth 設定手順書
- [ ] ロールバック手順書

---

## I. テスト計画

### I1. 単体テスト
- [ ] 冪等性のテスト
- [ ] A案フォールバックのテスト
- [ ] OAuth失敗のテスト

### I2. 統合テスト
- [ ] スレッド作成→確定→同期の一連の流れ
- [ ] 再同期時の冪等性確認
- [ ] 失敗時のフォールバック確認

### I3. 実機テスト
- [ ] Production環境で同期成功
- [ ] スマホで同期成功
- [ ] 失敗時の手動登録案内表示

---

## J. リリース判定

### J1. 全項目チェック
- [ ] A. OAuth / 審査（A1-A3）すべて完了
- [ ] B. 実装前チェック（B1-B4）すべて完了
- [ ] C. DoD（C1-C3）すべて完了
- [ ] D. リグレッション（D1-D3）すべて完了
- [ ] E. ロールバック（E1-E2）すべて完了
- [ ] F. セキュリティ（F1-F2）すべて完了
- [ ] G. 監査ログ（G1）すべて完了
- [ ] H. ドキュメント（H1-H2）すべて完了
- [ ] I. テスト計画（I1-I3）すべて完了

### J2. 最終承認
- [ ] 技術責任者の承認
- [ ] プロダクトオーナーの承認
- [ ] リリース日時の決定

---

## K. 実装Day1のタスク（審査完了後）

### K1. Backend実装
1. D1 マイグレーション: `calendar_syncs` テーブル作成
2. OAuth トークン管理の実装
3. Google Calendar API 統合
4. POST `/api/threads/:id/calendar/sync` 実装
5. GET `/api/threads/:id/calendar/sync-status` 実装

### K2. Frontend実装
1. 「カレンダーに同期」ボタン追加
2. 同期結果の表示
3. 失敗時の手動登録案内表示
4. 同期済み状態の表示

### K3. テスト
1. 単体テスト実行
2. 統合テスト実行
3. 実機テスト実行

### K4. デプロイ
1. Backend デプロイ
2. Frontend デプロイ
3. Production 動作確認

---

## ✅ 完了判定

**Next-7 Day1 実装開始条件**:
- ✅ OAuth 審査完了
- ✅ 本チェックリスト全項目完了

**Next-7 Day1 リリース条件**:
- ✅ DoD（C1-C3）全項目PASS
- ✅ リグレッション（D1-D3）全項目PASS
- ✅ 実機テスト（I3）全項目PASS
