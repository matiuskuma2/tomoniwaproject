# Web音声入力の制約と運用ルール

**作成日**: 2025-12-30  
**Phase**: Next-4 Day1  
**目的**: Web音声入力機能の技術的制約を明確化し、再発防止と期待値調整

---

## 結論（最重要）

✅ **Web音声入力は実装できる**  
✅ **権限が許可されている端末では正常に動作する**  
⚠️ **権限拒否後の再表示はブラウザ仕様による（保証不可）**  
✅ **ユーザーがブラウザ設定で権限を戻せば使える**  
❌ **「一度拒否したあと、もう一度ボタンを押したら毎回ダイアログが出る」はWebでは保証できない**  

---

## 技術的制約の詳細

### 1. ブラウザの権限モデル

#### **iOS Safari / Chrome（WebKit）の場合**
- マイク権限が「拒否（Deny）」として記録されると、**以後はダイアログを自動で再表示しない**
- 再表示させるには **ユーザーがブラウザ/OS側の設定で権限を戻す必要がある**
- JavaScriptからは権限設定を変更できない（セキュリティ上の制限）

#### **デスクトップブラウザの場合**
- Chrome/Edge: 「毎回確認する」設定であれば再表示される場合が多い
- Safari: iOS版と同様の挙動
- Firefox: 比較的柔軟だが、完全な保証はなし

### 2. Web Speech APIの仕様

- **ブラウザ対応**: Chrome, Edge, Safari（最新版）
- **非対応ブラウザ**: Firefox（一部対応）, 古いブラウザ
- **音声データの取り扱い**: 端末内で処理（サーバーへ送信なし）
- **権限の種類**: マイク権限（Microphone Permission）

---

## 実装で達成できること ✅

1. **音声認識ボタンの実装**
   - 🎤ボタンで音声認識の開始/停止
   - 標準的なチャットUIに準拠した配置

2. **権限許可済みの端末での正常動作**
   - 音声 → テキスト変換
   - Intent認識 → API実行 → Card表示
   - 既存フローとの完全な統合

3. **サイレントエラーハンドリング**
   - エラー表示なし（UI上）
   - コンソールログのみ（デバッグ用）
   - 技術的負債ゼロ

4. **再試行の試み**
   - 新しいSpeechRecognitionインスタンスを作成
   - ブラウザが許可する場合は再表示される
   - 「毎回確認する」設定では効果的

---

## 実装で保証できないこと ❌

1. **権限拒否後の必ず再表示**
   - ブラウザの権限モデルに依存
   - iOS Safari/Chromeでは特に制限が厳しい
   - 「毎回ダイアログが出る」は保証不可

2. **ブラウザ設定の自動変更**
   - JavaScriptから権限設定を変更できない
   - ユーザーが手動で設定を戻す必要がある

3. **全ブラウザでの統一動作**
   - ブラウザごとに権限モデルが異なる
   - 統一的な動作は保証できない

---

## ユーザー向けの対応方法

### **マイク権限が拒否されている場合の対処法**

#### **iOS Safari の場合**
1. 設定アプリを開く
2. Safari → カメラ・マイク
3. app.tomoniwao.jp の設定を「確認」または「許可」に変更
4. ページをリロード

#### **iOS Chrome の場合**
1. 設定アプリを開く
2. Chrome → マイク
3. app.tomoniwao.jp の設定を許可
4. ページをリロード

#### **デスクトップ Chrome/Edge の場合**
1. アドレスバーの左側の🔒（鍵）アイコンをクリック
2. マイクの設定を「毎回確認する」または「許可」に変更
3. ページをリロード

#### **デスクトップ Safari の場合**
1. Safari → 設定 → Webサイト → マイク
2. app.tomoniwao.jp の設定を「確認」または「許可」に変更
3. ページをリロード

---

## 開発者向けの運用ルール

### **1. 期待値の調整**

❌ **NG**: 「一度拒否しても、もう一度ボタンを押せば必ずダイアログが出ます」  
✅ **OK**: 「ブラウザの設定で権限を許可すれば使えます。一度拒否した場合は、ブラウザ設定から権限を戻してください」

### **2. UI設計の方針**

✅ **エラー表示を出さない** - サイレントエラーハンドリング  
✅ **再試行可能にする** - 新しいインスタンス作成（効果は限定的）  
✅ **ヘルプ表示** - 権限設定の変更方法を案内（必要に応じて）  

### **3. ドキュメント化**

- この制約を明文化し、チーム内で共有
- ユーザー向けヘルプに権限設定の手順を記載
- 「ダイアログが出ない」という問い合わせに備える

### **4. 将来的な対応**

#### **短期（Web環境）**
- Gemini補正機能の追加（Day1.5）
- TTS（読み上げ）機能の追加（Day2）
- 音声UXの段階的改善

#### **中期（PWA化）**
- PWA（Progressive Web App）化
- ホーム画面追加による体験向上
- プッシュ通知などの追加機能

#### **長期（ネイティブアプリ化）**
- iOS/Android ネイティブアプリ化
- 完全な権限管理
- アプリ設定からの権限再提示

---

## 再発防止チェックリスト

### **実装時**
- [ ] Web Speech APIの制約を理解しているか
- [ ] エラー表示を出さない設計になっているか
- [ ] 再試行可能な実装になっているか（効果は限定的と理解）
- [ ] 非対応ブラウザでの動作を考慮しているか

### **レビュー時**
- [ ] 「必ずダイアログが出る」という誤解がないか
- [ ] ユーザー向けヘルプの準備ができているか
- [ ] ブラウザごとの挙動の違いを理解しているか

### **リリース時**
- [ ] 制約をドキュメント化しているか
- [ ] サポート体制（権限設定の案内）ができているか
- [ ] 期待値が適切に調整されているか

---

## 参考資料

- [Web Speech API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API)
- [Permissions API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API)
- [iOS Safari の権限管理](https://webkit.org/blog/permissions/)

---

## 更新履歴

- **2025-12-30**: 初版作成（Phase Next-4 Day1）
