# UX_CHAT_TO_API_MAPPING.md
## ToMoniWao – 発話 → API対応表（確定版）

最終更新日: 2025-12-29  
ステータス: 確定（AI実装時の必須参照）

---

## 1. このドキュメントの役割

本ドキュメントは以下を定義する：

- ユーザーの自然言語（音声/テキスト）
- AIの判断（関係性・条件・回数制限）
- 実際に呼び出す **既存API**

👉 **新APIを作らない**
👉 **DB構造を変えない**
👉 **UIはAPIの呼び出し結果を表示するだけ**

---

## 2. 基本フロー（全ケース共通）

1. ユーザー発話を受け取る
2. AIが以下を判定
   - 関係性（family / coworker / external）
   - 調整条件（AND / CORE / MAX）
   - 調整回数（最大2回）
3. 既存APIを組み合わせて実行
4. 結果をチャット（＋必要ならカード）で返す

---

## 3. 発話 → APIマッピング（主要パターン）

### 3.1 他人に日程調整を送る（external）

#### 発話例
「田中さんと佐藤さんに日程調整送って」

#### AI判断
- 関係性: external
- 条件: MAX（デフォルト）
- 調整回数: 最大2回
- 通知: メール

#### API呼び出し
1. POST /api/threads  
   - candidates: [田中, 佐藤]
   - slots: 自動生成
2. 招待メール送信（既存処理）

#### UI
- チャット: 「2名に調整リンクを送りました」
- カード（任意）: ProgressCard

---

### 3.2 仕事仲間に調整を依頼（coworker）

#### 発話例
「AさんとBさんと来週どこかで1時間打ち合わせ入れといて」

#### AI判断
- 関係性: coworker
- 条件: AND（デフォルト）
- 調整回数: 最大2回
- 通知: チャット

#### API呼び出し
1. POST /api/threads  
2. GET /api/threads/:id/status（進捗確認）
3. 必要に応じて再調整（同スレッド）

#### UI
- チャットのみ（原則カードなし）
- 「確定しました」で完了

---

### 3.3 家族の予定を入れる（family）

#### 発話例
「家族旅行で3週間後から1週間予定全部入れといて」

#### AI判断
- 関係性: family
- 条件: AND
- 確認: 不要
- 調整回数: 0

#### API呼び出し
- POST /api/threads
- finalize 処理

#### UI
- チャットのみ
- 「予定を入れました」

---

### 3.4 募集中の予定を確認する

#### 発話例
「今募集してる予定って何がある？」

#### AI判断
- 情報参照のみ

#### API呼び出し
- GET /api/threads?status=active

#### UI
- ProgressCard（一覧）

---

### 3.5 募集の進捗を聞く

#### 発話例
「この勉強会、何人参加してる？」

#### AI判断
- 集計要求

#### API呼び出し
- GET /api/threads/:id/status

#### UI
- ProgressCard
  - 参加人数
  - 未返信数
  - 締切

---

### 3.6 日程を確定する（主催者）

#### 発話例
「この日で確定して」

#### AI判断
- 主催者権限
- status === active
- 条件満たすか確認

#### API呼び出し
- POST /api/threads/:id/finalize
- Google Calendar API 呼び出し（内部）

#### UI
- MeetCard
- チャット: 「確定しました」

---

### 3.7 今日の予定を聞く

#### 発話例
「今日の予定ある？」

#### AI判断
- 自分の予定参照

#### API呼び出し
- GET /api/events?date=today（既存想定）

#### UI
- チャット + 簡易カード

---

## 4. 再調整の扱い（重要）

- 再調整は **同一スレッド内** で行う
- 調整回数は最大2回
- 2回失敗したら：

チャット表示：
「2回調整しましたが条件を満たす日時が見つかりませんでした」

API：
- スレッドは close 扱い
- 新しい調整は新スレッド

---

## 5. UI表示ルール（再掲）

- 結果 → チャット
- 判断/選択 → カード
- 他人通知 → ベル
- 未登録者 → メール

---

## 6. 禁止事項（AI向け）

- APIを増やす提案
- DB構造の変更
- UI都合でAPIレスポンスを変える
- 無限再調整

---

## 7. まとめ

- 発話はUXの入口
- APIは既に十分に揃っている
- AIは「翻訳者・調整者」に徹する
- 実装はこの表に従う

👉 **この対応表を変更する場合は必ず設計レビューを行う**

---
