# 統合動作確認チェックリスト（最終版）

> **対象**: PREF-SET-1 + PROG-1 + P3-GEN1/P3-SCORE1 + freebusy(+batch)
> 
> **目的**: "好み設定 → 保存 → 空き枠生成/スコア/理由表示に反映" + "進捗質問 → 要約応答" が一連で壊れていないことを、短時間で検証する。

---

## 0. 前提条件（ここがズレると全部ズレる）

| チェック | 項目 | 確認方法 |
|:---:|------|---------|
| ☐ | Google連携済みアカウント | freebusy が叩ける（カレンダー取得可能） |
| ☐ | 対象機能が入っている | デプロイ/ブランチで PREF-SET-1 / PROG-1 相当が入っていること |
| ☐ | 初期状態の好みが空（推奨） | `好み見せて` → 空ならOK / あるなら `好みクリア` |

### 実施ログ（貼り付け用）

```
実施者: 
環境: prod / staging / local
アカウント: (Google連携済みメール)
実施日: YYYY-MM-DD
結果: PASS / FAIL
```

---

## 1. preference.set（非AI抽出）確認

### 入力（コピペ）

```
午後14時以降がいい
```

### 期待される応答（例）

```
✅ **好みを設定しました**

📝 入力: "午後14時以降がいい"

**追加した優先時間帯:**
• 毎日 14:00〜18:00 (優先)

💡 ヒント: 「好み見せて」で現在の設定を確認、「好みクリア」でリセットできます。
```

### チェックポイント

| チェック | 項目 |
|:---:|------|
| ☐ | 確認フローなしで即保存された |
| ☐ | `14:00〜18:00` のような時間帯が表示された |
| ☐ | エラーが出ていない |

---

## 2. preference.set（AI抽出 / nlPrefs/extract）確認

### 入力

```
ランチ時間は避けて
```

### 期待される応答（確認フロー）

```
🔍 **好み設定の確認**

📝 入力: "ランチ時間は避けて"

📋 **抽出内容:**
平日のランチ時間(12:00-13:00)を回避します

**⛔ 追加する避けたい時間帯:**
• 平日 12:00〜13:00 (避けたい)

---

この設定を保存しますか？
• 「はい」または「保存」で保存
• 「いいえ」または「キャンセル」で取り消し
```

### チェックポイント（確認表示）

| チェック | 項目 |
|:---:|------|
| ☐ | 「好み設定の確認」が出た（確認フロー） |
| ☐ | `12:00-13:00` の回避ルールが提案された |
| ☐ | 「はい/いいえ」の選択肢が出た |

### 「はい」入力後の期待

```
✅ **好みを設定しました**

📝 入力: "ランチ時間は避けて"
...
💡 今後の空き時間検索や候補提案に反映されます。
```

| チェック | 項目 |
|:---:|------|
| ☐ | 「好みを設定しました」が出た |
| ☐ | エラーが出ていない |

---

## 3. 好み表示（保存確認）

### 入力

```
好み見せて
```

### 期待

```
📋 **スケジュール好み設定**

**✅ 優先時間帯:**
• 毎日 14:00〜18:00 (優先)

**⛔ 避けたい時間帯:**
• 平日 12:00〜13:00 (避けたい)
```

| チェック | 項目 |
|:---:|------|
| ☐ | 1と2で設定したルールが両方表示される |
| ☐ | ルールが重複していない（※後述5a） |

---

## 4. 反映確認（freebusy / スコア理由表示）

### 入力

```
来週の空き教えて
```

### 期待（Google連携ありの場合）

- 空き候補が出る
- **P3-SCORE1 の「理由」**が表示される
  - `午後(14:00-18:00)に合致` がプラス
  - `ランチ時間回避` が（対象枠なら）プラス or 回避適用の説明
- 午後寄りが上位に来やすい（絶対ではない）

### 期待（Google未連携の場合）

- `⚠️ Google Calendar未連携` 相当の案内でOK（エラー落ちはNG）

| チェック | 項目 |
|:---:|------|
| ☐ | 空き候補が出た（or 未連携案内で正常終了した） |
| ☐ | スコア理由が表示された（P3-SCORE1） |
| ☐ | 午後の候補が上位に寄る傾向がある |
| ☐ | "壊れた感じの文言"になっていない（未実装/理解できない等） |

---

## 5. 進捗要約（PROG-1）確認

### 5-1. スレッド未選択時

### 入力

```
今どうなってる？
```

### 期待

- スレッド選択案内 または 一覧が返る
- 「どのスレッドの進捗を確認しますか？」的な誘導

| チェック | 項目 |
|:---:|------|
| ☐ | スレッド選択案内 または 一覧が出た |
| ☐ | エラー落ちしていない |

### 5-2. スレッド選択時

（スレッドを選択した状態で）

### 入力

```
今どうなってる？
```

### 期待

```
📌 **進捗: ミーティング調整**

状態: 募集中（v1 / 追加候補あと2回可）
候補数: 5件

👥 **招待者: 4名**
• 未回答: 2名
• 回答済み: 1名
• 辞退: 1名

✅ **次のおすすめ:**
2名が未回答です。リマインドをおすすめします

💡 「リマインドして」と入力してください
```

| チェック | 項目 |
|:---:|------|
| ☐ | 進捗要約が出た |
| ☐ | 招待者数・未回答数が表示された |
| ☐ | 次のアクション推奨が出た |
| ☐ | エラー落ちしていない |

---

## 6. "壊れやすい"落とし穴（回帰ポイント）

### 6a. 二重追加（dedupe）

### 入力（2回目）

```
午後14時以降がいい
```

### 期待

- 同じルールが二重に積まれない（or 上書き）

| チェック | 項目 |
|:---:|------|
| ☐ | `好み見せて` で同じルールが二重に並んでいない |

---

### 6b. 上書き/削除（未対応でもOKだが挙動は明確に）

### 入力

```
やっぱりランチ時間はOK
```

### 期待

- 削除成功、または **未対応の案内が出る**（サイレント無視はNG）

| チェック | 項目 |
|:---:|------|
| ☐ | 削除できた or 未対応と明示された |

---

## 7. クリア（最後に必ず戻す）

### 入力

```
好みクリア
```

### 期待

```
✅ 好み設定をクリアしました

設定はすべてリセットされました。
新しい好みを設定する場合は、例えば「平日14時以降がいい」などと入力してください。
```

| チェック | 項目 |
|:---:|------|
| ☐ | クリア成功 |
| ☐ | `好み見せて` で「設定されていません」となる |

---

## 詰まりやすい箇所 → 最小パッチ（即修正の指針）

**優先度の考え方**: 「保存したのに効いてない」>「変な抽出」>「UX迷子」

### A. 「保存したのに効いてない」

| 項目 | 内容 |
|------|------|
| **症状** | `好み見せて` では見えるのに freebusy の並び・理由に出ない |
| **原因候補** | prefs取得のキー（userId/workspaceId/ownerUserId）がズレ |
| **最小修正** | `freebusyBatch` の prefs 取得を "実行主体" に統一 |

### B. 「AI抽出が変なルールを作る」

| 項目 | 内容 |
|------|------|
| **症状** | "昼"が朝扱い、"午後"が夜になる等 |
| **最小修正** | `nlPrefsPrompt` に日本語→時間の定型を追記 |

**追加すべき定義:**
- 「昼」「ランチ」= 12:00-13:00
- 「午後」= 14:00-18:00
- 「夜」「夕方」= 18:00-22:00
- 「午前」「朝」= 09:00-12:00

### C. 確認フローが迷子

| 項目 | 内容 |
|------|------|
| **症状** | AI抽出時だけ確認、非AIは即保存で統一感がない |
| **方針** | 現行（非AI即保存、AIのみ確認）でOK。ただし文言で明確化 |

### D. 二重追加

| 項目 | 内容 |
|------|------|
| **症状** | 同じルールが積み上がる |
| **最小修正** | merge/dedupe を start/end/dow/kind の完全一致で正規化 |

### E. 上書き/削除

| 項目 | 内容 |
|------|------|
| **症状** | "やっぱりOK" が無視される |
| **方針** | まずは「未対応の明示」でOK → 次に `remove` op 対応 |

### F. 進捗要約が出ない（PROG-1）

| 項目 | 内容 |
|------|------|
| **症状** | 「今どうなってる？」でエラー or 従来の詳細表示になる |
| **原因候補** | classifier のパターンマッチ漏れ or executor の分岐漏れ |
| **最小修正** | `classifier/thread.ts` のパターン追加、`mode: 'summary'` の分岐確認 |

---

## 次の開発に進む基準

| 状態 | アクション |
|------|-----------|
| **全部PASS** | CONV-1.1 または FAIL-1 に進んでOK |
| **A〜F のいずれかがFAIL** | 該当の最小パッチを当ててから |

---

## 実施ログテンプレート（そのまま貼れる）

```markdown
## [統合確認ログ]

- **環境**: prod / staging / local
- **実施者**: 
- **Google連携**: 済 / 未
- **実施日**: YYYY-MM-DD

### 結果

| # | 項目 | 結果 | メモ |
|---|------|------|------|
| 0 | 前提条件 | OK / NG | |
| 1 | 非AI抽出（午後14時以降がいい） | PASS / FAIL | |
| 2 | AI抽出→確認→保存（ランチ避けて） | PASS / FAIL | |
| 3 | 好み見せて | PASS / FAIL | |
| 4 | freebusy反映（来週の空き） | PASS / FAIL | |
| 5-1 | 進捗要約（未選択時） | PASS / FAIL | |
| 5-2 | 進捗要約（選択時） | PASS / FAIL | |
| 6a | dedupe（二重追加なし） | PASS / FAIL | |
| 6b | remove（上書き/削除） | PASS / FAIL / 未対応OK | |
| 7 | クリア | PASS / FAIL | |

### 総評

- **結果**: PASS / FAIL
- **次アクション**: （A〜F のどれを修正するか）

### 詳細メモ

（エラーメッセージ、スクリーンショット、気づいた点など）
```

---

## 実施ログの保存場所

```
docs/integration_logs/YYYY-MM-DD_integration_run.md
```

- テンプレート: [_TEMPLATE.md](./integration_logs/_TEMPLATE.md)
- 毎回の実施結果をファイルで残し、PRで追跡可能に

---

## 関連ドキュメント

- [AI_CONVERSATIONAL_ROADMAP.md](./AI_CONVERSATIONAL_ROADMAP.md) - 全体設計とフェーズ定義
- [PREF-SET-1 実装完了（§27）](./AI_CONVERSATIONAL_ROADMAP.md#27-pref-set-1好み設定の会話入力実装完了-) 
- [PROG-1 実装完了（§28）](./AI_CONVERSATIONAL_ROADMAP.md#28-prog-1進捗要約実装完了-)
- [実施ログテンプレート](./integration_logs/_TEMPLATE.md)

---

*最終更新: 2026-01-24*
