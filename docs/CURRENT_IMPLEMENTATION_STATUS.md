# CURRENT_IMPLEMENTATION_STATUS.md
## ToMoniWao – 現状実装 × ドキュメントルール 突合表

最終更新日: 2025-12-29  
目的: ドキュメントのルールが現状コードにどこまで反映されているかを確認  
**重要**: この表は実装を変更するためではなく、「次に何を作るか」を安全に決めるための現状把握

---

## 0. 前提（絶対ルール）
- **DB/マイグレーション/APIコントラクトは一切変更しない**
- **既存E2E（外部招待→選択→票数→確定→Meet表示）を絶対に壊さない**
- **実装は後回し。まず現状把握と計画固定を優先**

---

## 1. SCHEDULING_RULES.md × 実装状況

| ルール | 実装状況 | "壊さず"に今やること |
|--------|----------|---------------------|
| AND / CORE / MAX の概念 | ❌ 未実装 | 実装は後。まず UI上の言い回しだけを docs に合わせる（文言・説明） |
| 最大2回ルール（Negotiation Budget=2） | ❌ 未実装 | 実装は後。まず **「外部は再調整なし/最大2回」**の"仕様テキスト"をUI/動画/資料に統一 |
| 外部は無限再調整禁止 | ✅ 運用で可 | 今は運用で固定（docsに合わせる）。本実装は後 |
| 主催者が確定してMeet生成 | ✅ 完全実装 | 現状維持（絶対に壊さない） |
| 票数表示（最多候補が見える） | ✅ 完全実装 | 現状維持（絶対に壊さない） |
| 招待者ごとの選択が見える | ✅ 完全実装 | 現状維持（絶対に壊さない） |
| 確定後Meet URL表示 | ✅ 完全実装 | 現状維持（絶対に壊さない） |

**結論**: 
- 調整ループ（2回まで）や AND/CORE/MAX の内部実装は"次フェーズ"
- 審査待ちの今は「実装をいじらず、仕様・計画・テストを固める」ほうが安全

---

## 2. NOTIFICATION_CHANNEL_RULES.md × 実装状況

| ルール | 実装状況 | "壊さず"に今やること |
|--------|----------|---------------------|
| externalはベル/メール中心 | ❌ UI未実装 | まず通知の出し分けを"定義だけ"固める（表示は後） |
| coworkerはチャットに出す | ❌ チャットUI未実装 | チャットUIに入る前提のカード設計だけ固定 |
| familyは文章通知中心 | ❌ 未実装 | まだ作らない。仕様が決まったことを docs に追記しておく |
| メール送信（external未登録） | ✅ 実装済み | 現状維持 |

**結論**: 
- 「今の画面に機能追加」ではなく、最終チャットUIで守るルールとして固定しておく段階
- 実装は Phase Next-3 以降

---

## 3. UX_CHAT_TO_API_MAPPING.md × 現在API

| 発話タイプ | 今できる？ | 依存するAPI | 欠けているもの（実装しないで把握） |
|-----------|----------|------------|-------------------------------|
| externalにリンク送付 | ✅ 可能 | POST /api/threads + /i/:token | "UIからの自然入力"だけ未完成 |
| 票数・選択状況確認 | ✅ 可能 | GET /api/threads/:id/status | 表示UIは改善余地あり（が致命ではない） |
| 確定→Meet | ✅ 可能 | POST /finalize | OK |
| coworker（相手のカレンダー見て調整） | ❌ 未実装 | 未 | 要: カレンダー"読み取り"と関係性権限 |
| family（勝手に仮押さえ） | ❌ 未実装 | 未 | 要: 家族権限モデル |
| MAX条件で最適日自動選択 | ⚠️ 人が判断 | status + 集計で可能 | 要: "確定候補の提案ロジック" |

**結論**: 
- **今のAPI/DBで"最終形は作れる"**
- coworker/family の "カレンダー参照"と "権限"が 次の大きい山

---

## 4. UX_CHAT_SPEC.md × 現在UI

| UX要素 | 実装状況 | 備考 |
|--------|----------|------|
| チャット中心UI | ❌ 未実装 | Phase Next-1 で器だけ作る |
| 左：スレッド一覧 | ❌ 未実装 | Phase Next-1 で作る |
| 右：チャット + カード | ❌ 未実装 | Phase Next-1 で作る |
| ベル通知 | ❌ 未実装 | Phase Next-3 で作る |
| 現在のDashboard/Threads | ✅ 実装済み | 審査用の仮UI（最終形ではない）- 現状維持 |

**結論**: 
- 現在のUIは審査用の仮UI
- 最終形チャットUIは Phase Next-1 から段階的に実装

---

## 5. 現状の強み（壊してはいけないもの）

### ✅ 完全に動作している機能
1. **Google OAuth認証** - ログイン・ログアウト
2. **Thread作成** - 候補日時の設定
3. **招待リンク生成** - `/i/:token` で外部ユーザー招待
4. **候補選択** - 外部ユーザーが候補日時を選択
5. **回答状況表示** - 誰がどの候補を選んだか、票数表示
6. **確定** - 主催者が最適日を選択して確定
7. **Google Meet生成** - 確定時に Meet URL 自動生成
8. **カレンダー登録** - Google Calendar にイベント作成
9. **Meet URL表示** - Thread詳細ページに常時表示

### ⚠️ 改善余地があるが致命的ではないもの
- UI/UXの微調整
- エラーハンドリング
- ローディング表示

---

## 6. 次に作るべきもの（優先度順）

### Phase Next-1（最優先 / 2週間で終わる）
**「チャットUIの器（UIだけ）を作る」**

- 左：スレッド一覧（title/status/pending/updated_at固定）
- 右：チャット表示（まだAI理解しない、まずログ表示でOK）
- カード：UI_CARD_CATALOG.mdの7種類の"箱"だけ作る（中身は薄く）

✅ これは DB/APIを一切変えずにできる  
✅ "最終形のUIっぽさ"が出る  
✅ 次フェーズでAI/意図解析を入れやすい

### Phase Next-2（2週間）
**「発話→intent→API呼び出し」だけ入れる（限定版）**

- intentは最初3つだけ
  - externalに日程調整送付（POST /threads）
  - 募集中一覧（GET /threads）
  - 特定スレッドの状況（GET /threads/:id/status）
- 音声入力は後回しでOK（まずテキスト）

✅ ここまでで「秘書に話すと作業が進む」を実現できる

### Phase Next-3（審査通過後 / 以降）
**Google Calendar "読み取り"を入れて coworker/CORE/MAX を本当にやる**

- FreeBusy / Events.list
- 権限・可視性（Room/Grid）
- 調整ループ（最大2回）
- externalは無限禁止（最大2回 or 1回で失敗）

---

## 7. AI実装指示テンプレート（Phase Next-1用）

```
最終形UXを作りたいが、DB/API/マイグレーションは一切変更禁止。
まずPhase Next-1として "チャットUIの器"だけ作る。

左スレッド一覧（title/status/pending/updated_at）。
右はチャットログ。
カードはUI_CARD_CATALOG.mdの7種の箱だけ。

既存E2E（外部招待→選択→票数→確定→Meet表示）を絶対に壊さない。

作業前に必ず、影響範囲（frontendのみ）と確認項目（E2E）を列挙してから着手して。
```

---

## 8. ロードマップ（6週間 - 審査待ち版）

| 週 | Phase | 内容 | 影響範囲 |
|----|-------|------|----------|
| W1-2 | Next-1 | チャットUIの器 | frontend のみ |
| W3-4 | Next-2 | 発話→intent→API | frontend のみ |
| W5-6 | Next-3 | 通知チャネル（ベル/メール/チャット表示の分離）※送信ロジックは現状維持 | frontend のみ |

---

## 9. まとめ

### ✅ 現状で完璧に動いているもの
- OAuth認証
- external型の日程調整フロー全体
- Meet生成・カレンダー登録

### ⚠️ 次に作るもの（段階的に）
- Phase Next-1: チャットUI（器だけ）
- Phase Next-2: 発話→intent→API（限定版）
- Phase Next-3: Calendar読み取り・調整ループ

### ❌ 今は作らないもの
- AND/CORE/MAXの自動ロジック
- 調整ループ（最大2回）
- coworker/family の権限モデル

👉 **審査待ち中は、実装より計画・設計・仕様固定を優先**

---
