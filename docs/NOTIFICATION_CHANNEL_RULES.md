# NOTIFICATION_CHANNEL_RULES.md
## ToMoniWao – 通知チャネル定義（UX固定）

最終更新日: 2025-12-29  
ステータス: 確定（UXの正）

---

## 1. このドキュメントの目的

本ドキュメントは以下を定義する：

- 誰に・どの通知を・どこへ出すか
- UXの「うざさ」を防ぐための分離ルール

👉 通知は UXの一部であり、API/DBとは独立した概念

---

## 2. 通知チャネルの種類（固定）

### A. チャット（秘書との会話）

- 家族
- 仕事仲間
- 自分にとって重要な確定通知

👉 **最優先チャネル**

---

### B. お知らせ（ベル）

- 他人からの招待
- 非緊急通知
- まとめて確認すれば良い情報

👉 チャットを汚さないための隔離領域

---

### C. メール

- ツール未利用者（external / 未登録）
- 登録を促す入口

👉 初回接触専用

---

## 3. 関係性 × 利用状況マトリクス

| 関係性 | 相手の状態 | 通知先 |
|------|----------|------|
| 家族 | 利用者 | チャット（結果のみ） |
| 仕事仲間 | 利用者 | チャット |
| 他人 | 未登録 | メール |
| 他人 | 登録済 | メール + ベル |

---

## 4. 通知の原則ルール

- **結果はチャット**
- **進捗はカード**
- **軽通知はベル**
- **未登録者はメール**

---

## 5. 禁止事項（重要）

- 他人の通知をチャットに出す
- 同じ内容を複数チャネルに乱発する
- 再調整通知を無制限に送る

---

## 6. 調整失敗時の通知

- 主催者：チャットで理由説明
- 他人：ベル or メールで「今回は見送り」

---

## 7. 将来拡張との整合

- external → coworker → family に昇格しても
  - 通知ルールは自然に切り替わる
- 既存スレッドはそのまま継続可能

---

## 8. まとめ

- 通知はUXの生命線
- うざさ回避が最優先
- チャットは聖域
- ベルは緩衝地帯
- メールは入口

👉 **この分離ルールは変更しない**

---

## 9. 関係性遷移時の通知チャネル切替（重要）

ToMoniWao では、同一の相手・案件でも **関係性が変化すると通知チャネルが自動的に切り替わる**。

これは「最適な通知方法は関係性で決まる」という設計思想に基づく。

---

### 9.1 関係性遷移のパターン

#### パターン A: external（未登録） → external（登録済み）

- **きっかけ**: 招待メールからツールに登録
- **変化**: メールのみ → メール + ベル

**before:**
- 招待リンク: メール
- 確定通知: メール

**after:**
- 招待リンク: メール + ベル
- 確定通知: メール + ベル

---

#### パターン B: external → coworker

- **きっかけ**: ツール内で Room / Grid / List に追加
- **変化**: メール + ベル → チャット

**before:**
- 調整依頼: メール
- 進捗通知: ベル

**after:**
- 調整依頼: チャット
- 進捗通知: チャット
- 確定通知: チャット

---

#### パターン C: coworker → family

- **きっかけ**: ユーザーが明示的に「家族」として登録
- **変化**: チャット（経過含む） → チャット（結果のみ）

**before:**
- 調整経過: チャットに表示
- 確定通知: チャット

**after:**
- 調整経過: 表示しない（AI が自動処理）
- 確定通知: チャット（結果のみ）

---

### 9.2 通知チャネル切替の原則

#### 原則 1: 格上げは常に許可

- external → coworker: 許可
- coworker → family: 許可

格上げ時は、より親密な通知方法（チャット）に自動的に切り替わる。

#### 原則 2: 格下げは慎重に

- coworker → external: 可能だが、チャット履歴は保持
- family → coworker: 可能だが、自動確定は停止

格下げ時は、通知方法を元に戻すが、過去の履歴は削除しない。

#### 原則 3: 既存スレッドはそのまま継続可能

- 関係性が変化しても、進行中のスレッドは継続
- 新規のスレッドから新しい通知ルールを適用
- 混乱を避けるため、既存スレッドの通知方法は変更しない

---

### 9.3 実装時の注意点

#### A. 通知先の判定タイミング

通知チャネルは **スレッド作成時** に決定される。

- スレッド作成時: 現在の関係性で通知先を決定
- スレッド進行中: 通知先は固定（変更しない）
- 新規スレッド: 最新の関係性で通知先を決定

#### B. 関係性変更時の既存スレッドの扱い

- 既存スレッドの通知先は **変更しない**
- 新規スレッドから新しいルールを適用
- ユーザーに混乱を与えないための配慮

#### C. 通知チャネルの判定ロジック

```
IF user_relationship == 'family':
  notification_channel = 'chat_result_only'
ELSE IF user_relationship == 'coworker':
  notification_channel = 'chat_full'
ELSE IF user_relationship == 'external' AND user_registered == true:
  notification_channel = 'email_and_bell'
ELSE:
  notification_channel = 'email_only'
```

---

### 9.4 禁止事項

以下は禁止とする：

- 進行中のスレッドの通知先を途中で変更すること
- 関係性が変わっても、過去の通知履歴を削除すること
- 同じ内容を複数チャネルに重複送信すること
- external を family に直接格上げすること（coworker を経由すること）

---

👉 **この切替ルールは変更しない**  
👉 **例外を作る場合は必ず設計レビューを行う**

---

## 10. 現状（Phase 0B MVP）の実装状況

### 実装済み
- ✅ メール通知（external / 未登録者への招待メール）
- ✅ inbox テーブル（通知データの保存）
- ✅ 招待承認通知（inbox に保存）

### 未実装（Phase Next で対応予定）
- ❌ チャット UI（秘書との会話）
- ❌ ベルアイコン UI（inbox テーブルからの通知表示）
- ❌ coworker / family のチャット通知

### 現状の通知チャネル

| 関係性 | 現状の通知方法 | 最終形 |
|------|-------------|-------|
| 家族 | **未実装**（Phase Next-3） | チャット |
| 仕事仲間 | **未実装**（Phase Next-2） | チャット |
| 他人（未登録） | ✅ メール | メール |
| 他人（登録済） | ✅ メール + inbox テーブル | メール + ベル |

### 暫定対応
現状は external（他人）のみ実装されており、以下の方法で通知している：

1. **招待メール**: thread_invites → EMAIL_QUEUE → メール送信
2. **承認通知**: inbox テーブルに保存（UI 未実装）
3. **確定通知**: メール送信（finalize 時）

### Phase Next での実装予定
- **Phase Next-1**: ベルアイコン UI を実装（inbox テーブルからの通知表示）
- **Phase Next-2**: チャット UI を実装（coworker の通知をチャットに表示）
- **Phase Next-3**: family の自動確定 + チャット通知

👉 **現状は「メール通知」を中心に動作しており、docs の方針に違反していない**

---
