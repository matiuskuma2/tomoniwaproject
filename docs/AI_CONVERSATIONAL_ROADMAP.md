# AIä¼šè©±åŒ–ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

> **ç›®æ¨™**: æ±ºã‚æ‰“ã¡ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆæ–¹å¼ã‚’å£Šã•ãšã«ã€AIç§˜æ›¸ã¨ã®è‡ªç„¶ä¼šè©±ã§å…¨æ©Ÿèƒ½ã‚’å‹•ã‹ã™
> 
> **åŸå‰‡**: AIã¯ã€Œè§£é‡ˆã¨è¨ˆç”»ã€ã®ã¿ã€å®Ÿè¡Œã¯ã€Œæ—¢å­˜ã®å …ã„ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ/å®Ÿè¡ŒåŸºç›¤ã€ã§è¡Œã†

---

## 0. æœ¬ä»•æ§˜æ›¸ã®ä½ç½®ã¥ã‘

- æœ¬æ›¸ã¯ **ç”»é¢ä»•æ§˜æ›¸ã§ã¯ãªã„**
- æœ¬æ›¸ã¯ **å®Ÿè£…è©³ç´°æ›¸ã§ã‚‚ãªã„**
- æœ¬æ›¸ã¯ **ã€Œã™ã¹ã¦ã®äºˆå®šèª¿æ•´æ©Ÿèƒ½ã®ä¸Šä½æ¦‚å¿µä»•æ§˜ã€** ã§ã‚ã‚‹
- æ—¢å­˜å®Ÿè£…ã¯ **ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆAction Layerï¼‰ã¨ã—ã¦å°Šé‡**
- æœ¬ä»•æ§˜ã¯ **ä¸Šæ›¸ãã›ãš"åŒ…ã‚€"**

---

## 1. è§£æ±ºã—ãŸã„æœ¬è³ªçš„èª²é¡Œ

### 1.1 äººé–“ã®äºˆå®šèª¿æ•´ãŒæŠ±ãˆã‚‹æ§‹é€ çš„å•é¡Œ

1. **ç›¸æ‰‹ã”ã¨ã«èª¿æ•´æ–¹æ³•ãŒé•ã†**
2. **äººæ•°ãŒå¢—ãˆã‚‹ã¨æŒ‡æ•°çš„ã«é¢å€’ã«ãªã‚‹**
3. **æš—é»™ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã®äººã¨ã¯åˆå¾Œç­‰ï¼‰ãŒè¨€èªåŒ–ã•ã‚Œãªã„**
4. **å†èª¿æ•´ãŒåœ°ç„**
5. **ã€Œèª°ã‹ã§ã„ã„ã€ã€Œå…¨å“¡å¿…è¦ã€ãªã©ã®æ¡ä»¶ãŒæ›–æ˜§**

### 1.2 æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®ã‚´ãƒ¼ãƒ«

```
ã€Œäºˆå®šèª¿æ•´ã€ã¨ã„ã†è¡Œç‚ºã‚’
äººãŒ"è€ƒãˆã‚‹ã‚‚ã®"ã‹ã‚‰
AIç§˜æ›¸ã«"ä»»ã›ã‚‹ã‚‚ã®"ã«å¤‰ãˆã‚‹
```

**ãŸã ã—ï¼š**
- å‹æ‰‹ã«æ±ºã‚ãªã„
- å‹æ‰‹ã«å‹•ã‹ãªã„
- **ç¢ºå®šã—ãŸç¬é–“ã ã‘å®Ÿè¡Œ**

---

## 2. è¨­è¨ˆåŸå‰‡ï¼ˆçµ¶å¯¾åŸå‰‡ï¼‰

### åŸå‰‡1ï¼šä¼šè©±ãŒä¸€æ¬¡æƒ…å ±
- UIæ“ä½œã¯è£œåŠ©
- **ä¼šè©±ãƒ­ã‚°ãŒSSOTï¼ˆSingle Source of Truthï¼‰**

### åŸå‰‡2ï¼šAIã¯åˆ¤æ–­è€…ã§ã¯ãªã„
- AIã¯ **åˆ†é¡ãƒ»æ•´ç†ãƒ»ææ¡ˆ** ã®ã¿
- **å®Ÿè¡Œã¯ç¢ºå®šã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®ã¿**

### åŸå‰‡3ï¼šäºˆå®šèª¿æ•´ã¯æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°ã§ã‚ã‚‹
- èª¿æ•´ã¯å¿…ãš **é–‹å§‹ â†’ é€²è¡Œ â†’ ç¢ºå®š or ä¸­æ–­**
- **ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’è¨±ã•ãªã„**

### åŸå‰‡4ï¼šæ—¢å­˜å®Ÿè£…ã‚’å£Šã•ãªã„
- æ—¢å­˜ã® `classifier â†’ intent â†’ apiExecutor/executors â†’ pending.action` ã‚’ **"å®Ÿè¡Œãƒ¬ãƒ¼ãƒ«"** ã¨ã—ã¦ç¶­æŒ
- AIã¯ **è‡ªç„¶è¨€èªâ†’(æ„å›³/ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿/è¨ˆç”»)** ã‚’ä½œã‚‹ã ã‘

---

## 3. äºˆå®šèª¿æ•´ã®ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆå…¨ä½“æ§‹é€ ï¼‰

ã™ã¹ã¦ã®äºˆå®šèª¿æ•´ã¯ã€ä»¥ä¸‹ **7è¦ç´ ** ã§å®Œå…¨ã«è¡¨ç¾ã§ãã‚‹ã€‚

### 3.1 èª¿æ•´ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«

| è¦ç´  | å®šç¾© | ä¾‹ |
|------|------|-----|
| **Initiator** | èª¿æ•´ã‚’é–‹å§‹ã—ãŸäºº | ä¸»å‚¬è€… |
| **Owner** | èª¿æ•´ã®è²¬ä»»è€… | ä¸»å‚¬è€…ï¼ˆã¾ãŸã¯ä»£ç†äººï¼‰ |
| **Participants** | å‚åŠ ãŒç¢ºå®šã™ã‚‹äºº | ANDæ¡ä»¶ã®å…¨å“¡ |
| **Candidate Pool** | å‚åŠ å€™è£œè€…ã®é›†åˆ | æ‹›å¾…å¯¾è±¡ãƒªã‚¹ãƒˆ |
| **Participation Rule** | AND / OR / Vote | å…¨å“¡å‚åŠ  or èª°ã‹1äºº |
| **Visibility Rule** | å…±æœ‰ãƒ¬ãƒ™ãƒ« | ç©ºãæ™‚é–“ã®ã¿å…±æœ‰ |
| **Commit Rule** | ç¢ºå®šæ–¹æ³• | æ‰‹å‹•æ‰¿èª / è‡ªå‹•ç¢ºå®š |

**ã“ã®7ã¤ãŒæƒã£ãŸæ™‚ç‚¹ã§ã€AIã¯ã€Œã©ã®èª¿æ•´ã‹ã€ã‚’ä¸€æ„ã«ç‰¹å®šã§ãã‚‹**

---

## 4. äººæ•°æ§‹é€ ï¼ˆParticipation Topologyï¼‰

### 4.1 åŸºæœ¬åˆ†é¡ï¼ˆå®Œå…¨ç¶²ç¾…ï¼‰

| ID | æ§‹é€  | èª¬æ˜ | å…¸å‹ä¾‹ |
|----|------|------|--------|
| **T1** | 1 : 1 | å€‹åˆ¥èª¿æ•´ | 1on1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| **T2** | 1 : N | ä¸€æ–‰æ¡ˆå†…ï¼ˆä¸»å‚¬è€…â†’è¤‡æ•°ï¼‰ | ã‚»ãƒŸãƒŠãƒ¼ã€èª¬æ˜ä¼š |
| **T3** | N : 1 | èª°ã‹1äººå‰²å½“ | å–¶æ¥­æ‹…å½“ã€ã‚µãƒãƒ¼ãƒˆ |
| **T4** | N : N | è¤‡æ•°äººåŒå£« | ãƒãƒ¼ãƒ MTG |
| **T5** | G : N | ã‚°ãƒ«ãƒ¼ãƒ—â†’å€‹äºº | ãƒãƒ¼ãƒ ã‹ã‚‰æ‹…å½“é¸å‡º |
| **T6** | N : G | å€‹äººâ†’ã‚°ãƒ«ãƒ¼ãƒ— | é¡§å®¢â†’ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ  |

â€» G = å®šç¾©æ¸ˆã¿ã‚°ãƒ«ãƒ¼ãƒ—

### 4.2 äººæ•°æ§‹é€ ã¨æ—¢å­˜ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®å¯¾å¿œ

| æ§‹é€  | å¯¾å¿œã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ | å‚™è€ƒ |
|------|----------------|------|
| 1:1 | `schedule.freebusy` | è‡ªåˆ†ã®ç©ºã |
| 1:N | `invite.prepare.*` | ä¸€æ–‰æ‹›å¾… |
| N:1 | ï¼ˆå°†æ¥ï¼‰`schedule.assign` | æ‹…å½“å‰²å½“ |
| N:N | `schedule.freebusy.batch` | å…±é€šç©ºã |

---

## 5. é–¢ä¿‚æ€§ãƒ¬ãƒ™ãƒ«ï¼ˆRelationship & Permissionï¼‰

### 5.1 é–¢ä¿‚æ€§ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒ¬ãƒ™ãƒ« | ç©ºãæ™‚é–“ | äºˆå®šå†…å®¹ | ä»£ç†æ“ä½œ | èª¿æ•´æ–¹å¼ |
|--------|----------|----------|----------|----------|
| **ä»–äºº** | Ã— | Ã— | Ã— | å€™è£œæç¤ºâ†’é¸æŠ |
| **åŠå…±æœ‰** | â—‹ | Ã— | Ã— | ç©ºãçªåˆâ†’ææ¡ˆ |
| **ä»•äº‹ä»²é–“** | â—‹ | Ã— | â–³ | ç©ºãçªåˆâ†’è‡ªå‹•ææ¡ˆ |
| **å®¶æ—ãƒ»å®Œå…¨ä¿¡é ¼** | â—‹ | â—‹ | â—‹ | å³æ™‚æŒ¿å…¥â†’é€šçŸ¥ã®ã¿ |

### 5.2 é–¢ä¿‚æ€§ã¨ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œ

| é–¢ä¿‚æ€§ | Googleé€£æº | ç©ºãå–å¾— | äºˆå®šæŒ¿å…¥ |
|--------|------------|----------|----------|
| ä»–äºº | ä¸è¦ | ä¸å¯ | ä¸å¯ |
| åŠå…±æœ‰ | ä»»æ„ | freebusy API | ä¸å¯ |
| ä»•äº‹ä»²é–“ | å¿…è¦ | freebusy API | æ‰¿èªå¾Œ |
| å®¶æ— | å¿…è¦ | freebusy API | å³æ™‚å¯ |

---

## 6. å‚åŠ æ¡ä»¶ãƒ«ãƒ¼ãƒ«ï¼ˆParticipation Ruleï¼‰

### 6.1 ANDï¼ˆå…¨å“¡å‚åŠ å¿…é ˆï¼‰
- **ç©é›†åˆ** ã§ç©ºãã‚’ç®—å‡º
- 1äººã§ã‚‚NGãªã‚‰å€™è£œã‹ã‚‰é™¤å¤–
- ç¾çŠ¶: `schedule.freebusy.batch` ã§å®Ÿè£…æ¸ˆã¿

### 6.2 ORï¼ˆèª°ã‹1äººã§æˆç«‹ï¼‰
- **å’Œé›†åˆ** ã§ç®—å‡º
- å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯å¿…è¦ï¼ˆå¾Œè¿°ï¼‰
- ç¾çŠ¶: æœªå®Ÿè£…ï¼ˆå°†æ¥è¨ˆç”»ï¼‰

### 6.3 Voteï¼ˆæŠ•ç¥¨ï¼‰
- å€™è£œæ—¥æç¤º â†’ å„äººãŒå¯å¦å…¥åŠ›
- é–¾å€¤æ¡ä»¶ã§ç¢ºå®š
- ç¾çŠ¶: æ—¢å­˜ã®æŠ•ç¥¨ãƒ•ãƒ­ãƒ¼

### 6.4 è¤‡åˆæ¡ä»¶ï¼ˆé«˜åº¦ï¼‰
- ä¾‹: `(A AND B) OR C`
- ç¾çŠ¶: æœªå®Ÿè£…ï¼ˆå°†æ¥è¨ˆç”»ï¼‰

---

## 7. å¯è¦–æ€§ãƒ«ãƒ¼ãƒ«ï¼ˆVisibility Ruleï¼‰

### 7.1 æƒ…å ±ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | å…±æœ‰å†…å®¹ | ç”¨é€” |
|--------|----------|------|
| **V0** | å€™è£œæ—¥æ™‚ã®ã¿ | å¤–éƒ¨æ‹›å¾… |
| **V1** | ç©ºãæ™‚é–“ | ç¤¾å†…èª¿æ•´ |
| **V2** | äºˆå®šã‚¿ã‚¤ãƒˆãƒ« | ãƒãƒ¼ãƒ å…±æœ‰ |
| **V3** | ãƒ•ãƒ«äºˆå®š | ç§˜æ›¸ä»£è¡Œ |

### 7.2 ç¾çŠ¶ã®å®Ÿè£…çŠ¶æ³

- V0: `invite.prepare.*` ã§å®Ÿè£…æ¸ˆã¿
- V1: `schedule.freebusy.batch` ã§å®Ÿè£…æ¸ˆã¿
- V2, V3: æœªå®Ÿè£…ï¼ˆå®¶æ—ãƒ¢ãƒ¼ãƒ‰ã§å°†æ¥è¨ˆç”»ï¼‰

---

## 8. ç¢ºå®šãƒ«ãƒ¼ãƒ«ï¼ˆCommit Ruleï¼‰

### 8.1 ç¢ºå®šæ–¹å¼

| æ–¹å¼ | å†…å®¹ | å¯¾å¿œã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ |
|------|------|----------------|
| **æ‰‹å‹•æ‰¿èª** | å…¨å“¡ç¢ºèªå¾Œã«ç¢ºå®š | `schedule.finalize` |
| **è‡ªå‹•ç¢ºå®š** | æ¡ä»¶æˆç«‹æ™‚ã«è‡ªå‹•ç¢ºå®š | `schedule.auto_propose.confirm` |
| **ä»®æŠ¼ã•ãˆ** | ä»®ç™»éŒ²â†’å¾Œæ‰¿èª | æœªå®Ÿè£… |
| **ä»£ç†ç¢ºå®š** | ç§˜æ›¸ãŒä»£è¡Œ | æœªå®Ÿè£…ï¼ˆå®¶æ—ãƒ¢ãƒ¼ãƒ‰ï¼‰ |

---

## 9. èª¿æ•´ãƒ•ãƒ­ãƒ¼ï¼ˆçŠ¶æ…‹é·ç§»ï¼‰

### 9.1 çŠ¶æ…‹é·ç§»å›³ï¼ˆMermaidï¼‰

```mermaid
stateDiagram-v2
    [*] --> Idle
    
    %% =====================================================
    %% A. å‚ç…§ç³»ï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰
    %% =====================================================
    Idle --> Reading : schedule.today/week/freebusy
    Reading --> Idle : ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
    
    %% =====================================================
    %% B. æ‹›å¾…æº–å‚™â†’ç¢ºèªâ†’å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
    %% =====================================================
    Idle --> PrepareSend : invite.prepare.emails/list
    PrepareSend --> PendingActionCreated : pending.action.created
    
    state PendingActionCreated {
        [*] --> WaitingDecision
        WaitingDecision --> ConfirmYes : ã€Œé€ã‚‹ã€
        WaitingDecision --> ConfirmNo : ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€
        WaitingDecision --> ConfirmNewThread : ã€Œåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã€
    }
    
    PendingActionCreated --> ExecuteExternal : pending.action.execute
    PendingActionCreated --> Cancelled : confirm(cancel)
    PendingActionCreated --> PrepareSend : confirm(new_thread)
    
    ExecuteExternal --> Sent : ãƒ¡ãƒ¼ãƒ«/é€šçŸ¥é€ä¿¡å®Œäº†
    
    %% =====================================================
    %% C. å›ç­”å¾…ã¡â†’ç¢ºå®šãƒ•ãƒ­ãƒ¼
    %% =====================================================
    Sent --> WaitingResponse : æ‹›å¾…é€ä¿¡æ¸ˆã¿
    WaitingResponse --> Sent : å›ç­”å—ä¿¡
    WaitingResponse --> Confirmed : schedule.finalize
    WaitingResponse --> Recalculating : schedule.additional_propose
    
    Recalculating --> PendingActionCreated : è¿½åŠ å€™è£œæº–å‚™
    
    %% =====================================================
    %% D. ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ­ãƒ¼
    %% =====================================================
    WaitingResponse --> RemindPending : schedule.remind.pending
    RemindPending --> PendingActionCreated : confirm(yes)
    RemindPending --> WaitingResponse : confirm(no)
    
    %% =====================================================
    %% E. ç¢ºå®šå¾Œãƒ•ãƒ­ãƒ¼
    %% =====================================================
    Confirmed --> [*] : æ­£å¸¸çµ‚äº†
    Confirmed --> ReschedulePending : schedule.reschedule
    
    ReschedulePending --> PendingActionCreated : reschedule.confirm
    ReschedulePending --> Confirmed : reschedule.cancel
    
    %% =====================================================
    %% F. çµ‚äº†çŠ¶æ…‹
    %% =====================================================
    Cancelled --> [*]
    
    %% å¤±æ•—æ™‚ã®ãƒªã‚«ãƒãƒª
    WaitingResponse --> Failed : æœŸé™åˆ‡ã‚Œ/å…¨å“¡NG
    Failed --> Recalculating : å†ææ¡ˆ
    Failed --> Cancelled : èª¿æ•´ä¸­æ­¢
```

### 9.2 PendingState åˆ¥ã®çŠ¶æ…‹é·ç§»å›³ï¼ˆå®Ÿè£…æº–æ‹ ï¼‰

```mermaid
stateDiagram-v2
    [*] --> NoPending
    
    %% pending.actionï¼ˆæ‹›å¾…/è¿½åŠ å€™è£œï¼‰
    NoPending --> PendingAction : invite.prepare.*\nschedule.additional_propose
    PendingAction --> NoPending : ã€Œé€ã‚‹ã€â†’ execute
    PendingAction --> NoPending : ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€
    PendingAction --> PendingAction : ã€Œåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã€
    
    %% remind.pendingï¼ˆæœªå›ç­”ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰
    NoPending --> RemindPending : schedule.remind.pending
    RemindPending --> NoPending : ã€Œã¯ã„ã€â†’ ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡
    RemindPending --> NoPending : ã€Œã„ã„ãˆã€
    
    %% remind.need_responseï¼ˆå†å›ç­”ä¾é ¼ï¼‰
    NoPending --> RemindNeedResponse : schedule.remind.need_response
    RemindNeedResponse --> NoPending : confirm/cancel
    
    %% remind.respondedï¼ˆå›ç­”æ¸ˆã¿è€…ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰
    NoPending --> RemindResponded : schedule.remind.responded
    RemindResponded --> NoPending : confirm/cancel
    
    %% notify.confirmedï¼ˆç¢ºå®šé€šçŸ¥ï¼‰
    NoPending --> NotifyConfirmed : schedule.notify.confirmed
    NotifyConfirmed --> NoPending : confirm/cancel
    
    %% split.proposeï¼ˆç¥¨å‰²ã‚Œè¿½åŠ ææ¡ˆï¼‰
    NoPending --> SplitPropose : schedule.propose_for_split
    SplitPropose --> PendingAction : confirm
    SplitPropose --> NoPending : cancel
    
    %% auto_proposeï¼ˆè‡ªå‹•ææ¡ˆï¼‰
    NoPending --> AutoPropose : schedule.auto_propose
    AutoPropose --> NoPending : confirm/cancel
    
    %% reschedule.pendingï¼ˆå†èª¿æ•´ï¼‰
    NoPending --> ReschedulePending : schedule.reschedule
    ReschedulePending --> PendingAction : reschedule.confirm
    ReschedulePending --> NoPending : reschedule.cancel
```

### 9.3 çŠ¶æ…‹å®šç¾©

| çŠ¶æ…‹ | èª¬æ˜ | å¯¾å¿œã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ |
|------|------|----------------|
| Idle | èª¿æ•´é–‹å§‹å‰ | - |
| Drafting | æ¡ä»¶å…¥åŠ›ä¸­ | `thread.create` |
| Candidate Presented | å€™è£œæç¤ºæ¸ˆã¿ | `invite.prepare.*` |
| Waiting Response | å›ç­”å¾…ã¡ | `schedule.status.check` |
| Recalculating | å†è¨ˆç®—ä¸­ | `schedule.additional_propose` |
| Confirming | ç¢ºå®šç¢ºèªä¸­ | `schedule.finalize` |
| Committed | ç¢ºå®šæ¸ˆã¿ | - |
| Failed | å¤±æ•—ï¼ˆæˆç«‹ã›ãšï¼‰ | - |
| Cancelled | ã‚­ãƒ£ãƒ³ã‚»ãƒ« | `schedule.reschedule.cancel` |

### 9.4 ç„¡é™é˜²æ­¢ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼‰

| ãƒ«ãƒ¼ãƒ« | å€¤ | è¶…éæ™‚ã®å‹•ä½œ |
|--------|-----|-------------|
| å†è¨ˆç®—å›æ•°ä¸Šé™ | æœ€å¤§3å› | Failed â†’ ä¸»å‚¬è€…åˆ¤æ–­ã«å§”ã­ã‚‹ |
| å›ç­”æœŸé™ | è¨­å®šå¯èƒ½ | æœŸé™åˆ‡ã‚Œ â†’ ãƒªãƒã‚¤ãƒ³ãƒ‰ or Failed |
| ç„¡å¿œç­”ãƒªãƒã‚¤ãƒ³ãƒ‰ | æœ€å¤§2å› | è¶…é â†’ Failedææ¡ˆ |

---

## 10. ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ï¼‰

### 10.1 å€‹äººãƒ«ãƒ¼ãƒ«ï¼ˆusers.schedule_prefs_jsonï¼‰

```typescript
interface SchedulePrefs {
  // æ™‚é–“å¸¯ã®å¥½ã¿
  time_windows?: TimeWindowRule[];    // å¥½ã‚€æ™‚é–“å¸¯
  avoid_windows?: TimeWindowRule[];   // é¿ã‘ãŸã„æ™‚é–“å¸¯
  
  // ä¸€èˆ¬ãƒ«ãƒ¼ãƒ«
  min_notice_hours?: number;          // æœ€ä½é€šçŸ¥æ™‚é–“ï¼ˆä¾‹: 24æ™‚é–“å‰ï¼‰
  max_days_ahead?: number;            // æœ€å¤§å…ˆèª­ã¿æ—¥æ•°ï¼ˆä¾‹: 14æ—¥ï¼‰
  max_meetings_per_day?: number;      // 1æ—¥ã®ä¸Šé™ä¼šè­°æ•°
  
  // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
  timezone?: string;
}
```

**ç¾çŠ¶**: P3-GEN1 ã§å®Ÿè£…æ¸ˆã¿

### 10.2 ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«ï¼ˆå°†æ¥è¨ˆç”»ï¼‰

```typescript
interface GroupPrefs {
  group_id: string;
  
  // ãƒãƒ¼ãƒ å…±é€šãƒ«ãƒ¼ãƒ«
  default_meeting_duration?: number;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¼šè­°æ™‚é–“
  preferred_days?: DayOfWeek[];       // å¥½ã‚€æ›œæ—¥
  avoid_days?: DayOfWeek[];           // é¿ã‘ã‚‹æ›œæ—¥
  
  // æš—é»™çŸ¥ã®æ˜æ–‡åŒ–
  rules?: Array<{
    description: string;              // "æœˆæ›œåˆå‰ã¯å…¨ä½“ä¼šè­°"
    constraint: ConstraintRule;
  }>;
}
```

**ç¾çŠ¶**: æœªå®Ÿè£…ï¼ˆå°†æ¥è¨ˆç”»ï¼‰

### 10.3 å„ªå…ˆé †ä½ï¼ˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰

1. **å‚åŠ å¿…é ˆæ¡ä»¶**ï¼ˆhard constraintï¼‰â†’ æº€ãŸã•ãªã„ã‚‚ã®ã¯é™¤å¤–
2. **å€‹äººåˆ¶ç´„**ï¼ˆsoft constraintï¼‰â†’ ã‚¹ã‚³ã‚¢åŠ æ¸›ç‚¹
3. **ã‚°ãƒ«ãƒ¼ãƒ—åˆ¶ç´„** â†’ ã‚¹ã‚³ã‚¢åŠ æ¸›ç‚¹
4. **è² è·åˆ†æ•£** â†’ åŒç‚¹æ™‚ã®èª¿æ•´
5. **ç›´è¿‘å„ªå…ˆ** â†’ ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼

**ç¾çŠ¶**: P3-GEN1 ã® slotScorer ã§éƒ¨åˆ†å®Ÿè£…æ¸ˆã¿

---

## 11. å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆN:1ï¼‰

### 11.1 é¸å®šåŸºæº–ï¼ˆå„ªå…ˆé †ï¼‰

| é †ä½ | åŸºæº– | èª¬æ˜ |
|------|------|------|
| 1 | ç©ºã | è©²å½“æ™‚é–“ãŒç©ºã„ã¦ã„ã‚‹äºº |
| 2 | å„ªå…ˆåº¦ | è¨­å®šã•ã‚ŒãŸå„ªå…ˆåº¦é † |
| 3 | è² è· | ä»Šé€±ã®ä¼šè­°æ•°ãŒå°‘ãªã„äºº |
| 4 | ç›´è¿‘å±¥æ­´ | æœ€è¿‘æ‹…å½“ã—ã¦ã„ãªã„äºº |
| 5 | ãƒ©ãƒ³ãƒ€ãƒ  | åŒç‚¹æ™‚ã®ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ |

**ç¾çŠ¶**: æœªå®Ÿè£…ï¼ˆå°†æ¥è¨ˆç”»ï¼‰

---

## 12. å†èª¿æ•´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»ãƒªã‚¹ã‚±

### 12.1 å†èª¿æ•´ï¼ˆRescheduleï¼‰

| é …ç›® | ãƒ«ãƒ¼ãƒ« |
|------|--------|
| ãƒˆãƒªã‚¬ãƒ¼ | `schedule.reschedule` |
| å›æ•°åˆ¶é™ | æœ€å¤§2å›ï¼ˆè¨­å®šå¯èƒ½ï¼‰ |
| è¶…éæ™‚ | èª¿æ•´ç ´æ£„ or ä¸»å‚¬è€…åˆ¤æ–­ |
| é€šçŸ¥ | æ—¢å­˜å‚åŠ è€…å…¨å“¡ã«å†èª¿æ•´é€šçŸ¥ |

**ç¾çŠ¶**: P2-D3 ã§å®Ÿè£…æ¸ˆã¿

### 12.2 ã‚­ãƒ£ãƒ³ã‚»ãƒ«

| æ¨©é™è€… | å¯èƒ½ãªæ“ä½œ |
|--------|-----------|
| ä¸»å‚¬è€… | å³æ™‚ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| å‚åŠ è€… | å‚åŠ è¾é€€ï¼ˆèª¿æ•´ã¯ç¶™ç¶šï¼‰ |
| ä»£ç†äºº | è¨­å®šæ™‚ã®ã¿å¯èƒ½ |

---

## 13. AIã¨ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®å½¹å‰²åˆ†æ‹…

### 13.1 AIã®è²¬å‹™

| è²¬å‹™ | èª¬æ˜ | å‡ºåŠ› |
|------|------|------|
| ä¼šè©±ç†è§£ | è‡ªç„¶æ–‡ã‚’è§£é‡ˆ | æ§‹é€ åŒ–ã•ã‚ŒãŸæ„å›³ |
| æ¡ä»¶è£œå®Œ | ä¸è¶³æƒ…å ±ã‚’è³ªå• | clarifications |
| ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®š | äººæ•°æ§‹é€ /é–¢ä¿‚æ€§ã‚’åˆ¤å®š | ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«è¦ç´  |
| ç¢ºå®šã‚¤ãƒ³ãƒ†ãƒ³ãƒˆæç¤º | æ—¢å­˜intentã«è½ã¨ã™ | ActionPlan |

### 13.2 AIãŒã‚„ã‚‰ãªã„ã“ã¨ï¼ˆç¦æ­¢äº‹é …ï¼‰

| ç¦æ­¢äº‹é … | ç†ç”± |
|----------|------|
| å‹æ‰‹ãªäºˆå®šç™»éŒ² | ç¢ºèªãªã—ã®å¤–éƒ¨å½±éŸ¿ |
| æš—é»™æ±ºå®š | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç¢ºèªãŒå¿…è¦ |
| ãƒ«ãƒ¼ãƒ«ç ´å£Š | æ—¢å­˜ã®å®‰å…¨æ©Ÿæ§‹ã‚’è¿‚å›ã—ãªã„ |
| æ¨æ¸¬ã«ã‚ˆã‚‹è£œå®Œ | æ›–æ˜§ãªã‚‰è³ªå•ã™ã‚‹ |

---

## 14. ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆä½“ç³»ï¼ˆæœ€ä¸Šä½åˆ†é¡ï¼‰

### 14.1 ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ

| Intent | æ§‹é€  | ãƒ•ã‚§ãƒ¼ã‚º |
|--------|------|----------|
| `schedule.create` | èª¿æ•´é–‹å§‹ | Drafting |
| `schedule.modify` | æ¡ä»¶å¤‰æ›´ | Candidate Presented |
| `schedule.commit` | ç¢ºå®š | Confirming â†’ Committed |
| `schedule.cancel` | ä¸­æ­¢ | â†’ Cancelled |
| `schedule.reschedule` | å†èª¿æ•´ | Committed â†’ Recalculating |

### 14.2 ç™ºè©±ã‹ã‚‰ã®åˆ†é¡ä¾‹

| ç™ºè©± | äººæ•°æ§‹é€  | Intent |
|------|----------|--------|
| ã€Œæ¥é€±Aã•ã‚“ã¨1on1ã€ | 1:1 | `schedule.freebusy` |
| ã€Œã‚»ãƒŸãƒŠãƒ¼çµ„ã‚“ã§ã€ | 1:N | `invite.prepare.*` |
| ã€Œèª°ã‹å¯¾å¿œã—ã¦ã€ | N:1 | ï¼ˆå°†æ¥ï¼‰`schedule.assign` |
| ã€Œå…¨å“¡ã§ã€ | N:N AND | `schedule.freebusy.batch` |
| ã€ŒæŠ•ç¥¨ã§æ±ºã‚ã¦ã€ | N:N Vote | æ—¢å­˜æŠ•ç¥¨ãƒ•ãƒ­ãƒ¼ |

---

## 15. æ—¢å­˜ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆä¸€è¦§ï¼ˆIntent Mapï¼‰

### A. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–²è¦§/ç©ºãæ ï¼ˆPhase Next-3ï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ | äººæ•°æ§‹é€  |
|--------|------|----------|----------|
| `schedule.today` | ä»Šæ—¥ã®äºˆå®š | ä¸è¦ | 1:0 |
| `schedule.week` | ä»Šé€±ã®äºˆå®š | ä¸è¦ | 1:0 |
| `schedule.freebusy` | è‡ªåˆ†ã®ç©ºãæ™‚é–“/ç©ºãæ  | ä¸è¦ | 1:1 |
| `schedule.freebusy.batch` | è¤‡æ•°å‚åŠ è€…ã®å…±é€šç©ºã | ä¸è¦ | N:N |

### B. æ‹›å¾…ãƒ»å€™è£œé€ä¿¡ï¼ˆBeta Aï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ | äººæ•°æ§‹é€  |
|--------|------|----------|----------|
| `invite.prepare.emails` | ãƒ¡ãƒ¼ãƒ«è²¼ã‚Šä»˜ã‘â†’é€ä¿¡æº–å‚™ | **å¿…è¦** | 1:N |
| `invite.prepare.list` | ãƒªã‚¹ãƒˆæŒ‡å®šâ†’é€ä¿¡æº–å‚™ | **å¿…è¦** | 1:N |
| `pending.action.decide` | é€ã‚‹/ã‚­ãƒ£ãƒ³ã‚»ãƒ«/åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ | ä¸è¦ | - |

### C. è‡ªå‹•èª¿æ•´ãƒ»è¿½åŠ å€™è£œï¼ˆPhase Next-5/6ï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ | çŠ¶æ…‹é·ç§» |
|--------|------|----------|----------|
| `schedule.auto_propose` | è‡ªå‹•èª¿æ•´ææ¡ˆ | **å¿…è¦** | â†’ Candidate Presented |
| `schedule.auto_propose.confirm` | ææ¡ˆç¢ºå®š | ä¸è¦ | â†’ Committed |
| `schedule.auto_propose.cancel` | ææ¡ˆã‚­ãƒ£ãƒ³ã‚»ãƒ« | ä¸è¦ | â†’ Cancelled |
| `schedule.additional_propose` | è¿½åŠ å€™è£œææ¡ˆ | **å¿…è¦** | â†’ Recalculating |

### D. ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆPhase Next-6 / Phase2ï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ | çŠ¶æ…‹ |
|--------|------|----------|------|
| `schedule.remind.pending` | æœªè¿”ä¿¡ãƒªãƒã‚¤ãƒ³ãƒ‰ææ¡ˆ | **å¿…è¦** | Waiting Response |
| `schedule.remind.pending.confirm` | ãƒªãƒã‚¤ãƒ³ãƒ‰ç¢ºå®š | ä¸è¦ | - |
| `schedule.remind.pending.cancel` | ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ« | ä¸è¦ | - |
| `schedule.need_response.list` | å†å›ç­”å¿…è¦è€…ãƒªã‚¹ãƒˆè¡¨ç¤º | ä¸è¦ | - |
| `schedule.remind.need_response` | å†å›ç­”å¿…è¦è€…ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ | **å¿…è¦** | - |
| `schedule.remind.responded` | å›ç­”æ¸ˆã¿ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ | **å¿…è¦** | - |

### E. ç¢ºå®šãƒ»å†èª¿æ•´ï¼ˆPhase2ï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ | çŠ¶æ…‹é·ç§» |
|--------|------|----------|----------|
| `schedule.finalize` | ç¢ºå®š | **å¿…è¦** | â†’ Committed |
| `schedule.reschedule` | ç¢ºå®šå¾Œã‚„ã‚Šç›´ã— | **å¿…è¦** | Committed â†’ Recalculating |
| `schedule.status.check` | çŠ¶æ³ç¢ºèª | ä¸è¦ | - |
| `schedule.invite.list` | æ‹›å¾…è€…ä¸€è¦§ | ä¸è¦ | - |

### F. ãƒªã‚¹ãƒˆç®¡ç†ï¼ˆBeta Aï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ |
|--------|------|----------|
| `list.create` | ãƒªã‚¹ãƒˆä½œæˆ | ä¸è¦ |
| `list.list` | ãƒªã‚¹ãƒˆä¸€è¦§ | ä¸è¦ |
| `list.members` | ãƒªã‚¹ãƒˆãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º | ä¸è¦ |
| `list.add_member` | ãƒªã‚¹ãƒˆã«ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ  | ä¸è¦ |

### G. å¥½ã¿è¨­å®šï¼ˆP3-PREFï¼‰

| Intent | èª¬æ˜ | ç¢ºèªè¦å¦ |
|--------|------|----------|
| `preference.set` | å¥½ã¿è¨­å®š | ä¸è¦ |
| `preference.show` | å¥½ã¿è¡¨ç¤º | ä¸è¦ |
| `preference.clear` | å¥½ã¿ã‚¯ãƒªã‚¢ | ä¸è¦ |

---

## 16. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### è¿½åŠ ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè©±                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  A) nlRouterï¼ˆNatural Language Routerï¼‰                     â”‚
â”‚  - å…¥åŠ›: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè©± + æ–‡è„ˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰/pending/ãƒ­ã‚°ï¼‰         â”‚
â”‚  - å‡ºåŠ›: ActionPlanï¼ˆæ§‹é€ åŒ–JSONï¼‰                           â”‚
â”‚  - ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«7è¦ç´ ã‚’åŸ‹ã‚ã‚‹                                   â”‚
â”‚  - å¤±æ•—æ™‚: æ—¢å­˜ãƒ«ãƒ¼ãƒ«åˆ†é¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  B) policyGateï¼ˆå®‰å…¨ã‚²ãƒ¼ãƒˆï¼‰                                â”‚
â”‚  - intentã”ã¨ã«ã€Œç¢ºèªãŒå¿…è¦ã‹ã€åˆ¤å®š                         â”‚
â”‚  - çŠ¶æ…‹é·ç§»ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯                                 â”‚
â”‚  - ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã‚„å±é™ºæ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ â†’ è³ªå•ã«åˆ†è§£              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C) executorBridge                                          â”‚
â”‚  - ActionPlan.intent ã‚’ IntentResult ã«å¤‰æ›                 â”‚
â”‚  - æ—¢å­˜ã® executeIntent() ã«æŠ•ã’ã‚‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¢å­˜: apiExecutor â†’ executors â†’ pending.action             â”‚
â”‚  ï¼ˆå¤‰æ›´ãªã—ï¼‰                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ActionPlan ã‚¹ã‚­ãƒ¼ãƒï¼ˆæ‹¡å¼µç‰ˆï¼‰

```typescript
interface ActionPlan {
  // æ—¢å­˜ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã«è½ã¨ã™
  intent: IntentType;
  
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  params: {
    range?: 'today' | 'week' | 'next_week';
    prefer?: 'morning' | 'afternoon' | 'evening' | 'business';
    duration_minutes?: number;
    threadId?: string;
    participants?: ParticipantInfo[];
  };
  
  // ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«è¦ç´ ï¼ˆæ–°è¦ï¼‰
  meta?: {
    topology?: 'T1' | 'T2' | 'T3' | 'T4' | 'T5' | 'T6';  // äººæ•°æ§‹é€ 
    participation_rule?: 'AND' | 'OR' | 'VOTE';
    visibility_level?: 'V0' | 'V1' | 'V2' | 'V3';
    commit_rule?: 'manual' | 'auto' | 'tentative' | 'proxy';
  };
  
  // P3-GEN1: å¥½ã¿ï¼ˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ç”¨ï¼‰
  preferences?: SchedulePrefs;
  
  // ç¢ºèªãŒå¿…è¦ã‹ï¼ˆpolicyGateã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
  requires_confirm: boolean;
  
  // ä¸è¶³æƒ…å ±ã®è³ªå•
  clarifications?: Array<{
    field: string;
    question: string;
  }>;
  
  // å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«
  response_style: 'brief' | 'detailed' | 'conversational';
  
  // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆï¼ˆPhase CONV-2ï¼‰
  suggested_next_actions?: Array<{
    label: string;
    intent: IntentType;
    params: Record<string, any>;
  }>;
}
```

---

## 17. å®‰å…¨ãƒãƒªã‚·ãƒ¼ï¼ˆConfirm Rulesï¼‰

### å¿…ãšç¢ºèªãŒå¿…è¦ãªæ“ä½œ

| ã‚«ãƒ†ã‚´ãƒª | Intent | ç†ç”± | çŠ¶æ…‹é·ç§» |
|----------|--------|------|----------|
| å¤–éƒ¨é€ä¿¡ | `invite.prepare.*`, `schedule.remind.*` | ãƒ¡ãƒ¼ãƒ«/é€šçŸ¥ãŒé£›ã¶ | â†’ Candidate Presented |
| ç¢ºå®šæ“ä½œ | `schedule.finalize`, `schedule.auto_propose.confirm` | å–ã‚Šæ¶ˆã—å›°é›£ | â†’ Committed |
| å†èª¿æ•´ | `schedule.reschedule` | æ—¢å­˜å‚åŠ è€…ã¸ã®å½±éŸ¿ | â†’ Recalculating |

### ç¢ºèªä¸è¦ï¼ˆå®‰å…¨ï¼‰ãªæ“ä½œ

| ã‚«ãƒ†ã‚´ãƒª | Intent | ç†ç”± |
|----------|--------|------|
| é–²è¦§ç³» | `schedule.today`, `schedule.week`, `schedule.freebusy` | å‰¯ä½œç”¨ãªã— |
| ãƒªã‚¹ãƒˆç®¡ç† | `list.*` | å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç³» | `*.cancel` | é€ä¿¡ã‚’æ­¢ã‚ã‚‹æ–¹å‘ |

---

## 18. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­è¨ˆ

### unknownæ™‚ã®è³ªå•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```typescript
const FALLBACK_QUESTIONS: Record<string, string> = {
  missing_thread: 'å¯¾è±¡ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„',
  missing_range: 'æœŸé–“ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä¾‹: ä»Šé€±ã€æ¥é€±ï¼‰',
  missing_participants: 'å‚åŠ è€…ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒªã‚¹ãƒˆåï¼‰',
  missing_topology: 'å‚åŠ è€…ã¯ã€Œå…¨å“¡ã€ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ã€Œèª°ã‹1äººã€ã§ã„ã„ã§ã™ã‹ï¼Ÿ',
  ambiguous_action: 'ä½•ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ\n- ç©ºãæ™‚é–“ã‚’ç¢ºèª\n- æ‹›å¾…ã‚’é€ã‚‹\n- ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ã‚‹',
};
```

### AIå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

```typescript
async function classifyWithFallback(input: string, context: IntentContext): Promise<IntentResult> {
  try {
    const aiResult = await nlRouter.classify(input, context);
    if (aiResult.confidence > 0.7) {
      return aiResult;
    }
  } catch (e) {
    console.warn('[nlRouter] Failed, falling back to rules', e);
  }
  
  // ãƒ«ãƒ¼ãƒ«åˆ†é¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return runRuleClassifiers(input, context);
}
```

---

## 19. ãƒ­ã‚°/ç›£æŸ»ï¼ˆIncidentå¯¾å¿œï¼‰

### ä¿å­˜ã™ã¹ããƒ‡ãƒ¼ã‚¿

```typescript
interface NlRouterLog {
  id: string;
  timestamp: string;
  user_id: string;
  
  // å…¥åŠ›
  user_message: string;
  context: NlRouterInput['context'];
  
  // AIå‡ºåŠ›
  ai_response_raw: string;
  action_plan: ActionPlan | null;
  validation_errors?: string[];
  
  // ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«åˆ¤å®šçµæœ
  detected_topology?: string;
  detected_participation_rule?: string;
  
  // å®Ÿè¡Œçµæœ
  final_intent: IntentType;
  executed: boolean;
  execution_result?: string;
  
  // çŠ¶æ…‹é·ç§»
  state_before?: string;
  state_after?: string;
}
```

---

## 20. Intent Catalogï¼ˆnlRouterè¨±å¯ãƒªã‚¹ãƒˆï¼‰

> **å‚ç…§**: [`docs/intent_catalog.json`](./intent_catalog.json)

Intent Catalog ã¯ nlRouter ãŒã€Œå‹æ‰‹ã«çŸ¥ã‚‰ãªã„ã“ã¨ã‚’å®Ÿè¡Œã—ãªã„ã€ãŸã‚ã®è¨±å¯ãƒªã‚¹ãƒˆã§ã™ã€‚
å…¨ 40+ ã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼š

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|-----------|------|
| `intent` | ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆå |
| `category` | ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ï¼ˆcalendar.read, invite.prepare, etc.ï¼‰ |
| `side_effect` | å‰¯ä½œç”¨ã‚¿ã‚¤ãƒ—ï¼ˆnone/read/write_local/write_externalï¼‰ |
| `requires_confirmation` | ç¢ºèªãŒå¿…è¦ã‹ |
| `topology` | äººæ•°æ§‹é€ ï¼ˆ1:1, 1:N, N:N, etc.ï¼‰ |
| `params_schema` | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ |
| `executor` | å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« |
| `api` | å¯¾å¿œAPI |

### å‰¯ä½œç”¨ã‚¿ã‚¤ãƒ—åˆ†é¡

| ã‚¿ã‚¤ãƒ— | èª¬æ˜ | ä¾‹ |
|--------|------|-----|
| `none` | å‰¯ä½œç”¨ãªã— | ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç³» |
| `read` | å‚ç…§ã®ã¿ï¼ˆå®‰å…¨ï¼‰ | schedule.today, schedule.freebusy |
| `write_local` | DBæ›´æ–°ï¼ˆå¤–éƒ¨é€ä¿¡ãªã—ï¼‰ | invite.prepare.*, preference.set |
| `write_external` | å¤–éƒ¨é€ä¿¡ï¼ˆå¿…ãšç¢ºèªï¼‰ | remind.*.confirm, pending.action.execute |

---

## 21. P3-SCORE1 è¨­è¨ˆä»•æ§˜ï¼ˆç†ç”±è¡¨ç¤ºï¼‰

### 21.1 ç›®çš„

ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã•ã‚ŒãŸå€™è£œã«å¯¾ã—ã¦ã€Œãªãœã“ã®æ ãŒä¸Šä½ãªã®ã‹ã€ã‚’
ãƒ¦ãƒ¼ã‚¶ãƒ¼åä»˜ãã§è¡¨ç¤ºã—ã€AIç§˜æ›¸ã¨ã—ã¦ã®èª¬æ˜åŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

### 21.2 ScoreReason æ§‹é€ ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

```typescript
// apps/api/src/utils/schedulePrefs.ts

interface ScoreReason {
  source: string;          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¾ãŸã¯ 'proximity'
  label: string;           // ç†ç”±ã®ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹: 'åˆå¾Œå¸Œæœ›', 'æœ¨æ›œå¤œå¸Œæœ›'ï¼‰
  delta: number;           // ã‚¹ã‚³ã‚¢ã¸ã®å½±éŸ¿ï¼ˆæ­£/è² ï¼‰
}

interface ScoredSlot {
  start_at: string;        // ISO 8601
  end_at: string;          // ISO 8601
  label: string;           // è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«
  score: number;           // åˆè¨ˆã‚¹ã‚³ã‚¢
  reasons: ScoreReason[];  // ã‚¹ã‚³ã‚¢ã®ç†ç”±ä¸€è¦§
}
```

### 21.3 ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ«

| ãƒ«ãƒ¼ãƒ«ç¨®åˆ¥ | ã‚¹ã‚³ã‚¢å½±éŸ¿ | ä¾‹ |
|-----------|-----------|-----|
| `time_windows` ãƒãƒƒãƒ | + weight | ã€Œåˆå¾Œ14:00-18:00ã€ã«åˆè‡´ â†’ +10 |
| `avoid_windows` ãƒãƒƒãƒ | - weight | ã€Œæœˆæ›œæœã€ã«è©²å½“ â†’ -12 |
| ç›´è¿‘å„ªå…ˆï¼ˆã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ï¼‰ | -0.001 Ã— hours | 1æ™‚é–“å¾Œ â†’ -0.001 |

### 21.4 ç†ç”±è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆP3-SCORE1 ToDoï¼‰

**è¡¨ç¤ºä¾‹ï¼ˆç›®æ¨™ï¼‰:**
```
1. 1/27(æœˆ) 14:00-15:00  [score: 42]
   - Aã•ã‚“: åˆå¾Œ(14:00-18:00)ã«åˆè‡´ (+10)
   - Bã•ã‚“: æœ¨æ›œå¤œå¸Œæœ›ã«è¿‘ã„ (+6)

2. 1/28(ç«) 10:00-11:00  [score: 28]
   - Aã•ã‚“: åˆå¾Œå¸Œæœ›ã«åˆã‚ãªã„ (-3)
   - Bã•ã‚“: ç‰¹ã«åˆ¶ç´„ãªã— (0)
```

### 21.5 åœ§ç¸®ãƒ«ãƒ¼ãƒ«ï¼ˆå®Ÿè£…äºˆå®šï¼‰

1. **å‚åŠ è€…ã§åˆç®—**: åŒä¸€ participant + åŒä¸€ rule ã¯ delta ã‚’åˆç®—
2. **ä¸Šä½3ä»¶ã®ã¿**: ç†ç”±ãŒå¤šã„å ´åˆã¯ |delta| ãŒå¤§ãã„é †ã«3ä»¶
3. **ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼éè¡¨ç¤º**: proximity ã¯é€šå¸¸éè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿ï¼‰

### 21.6 å®Ÿè£…ToDo

| å¯¾è±¡ | ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|------|----------|------|
| Backend | `slotScorer.ts` | `formatReasonsWithUsers()` å®Ÿè£…æ¸ˆã¿ |
| Backend | `schedulePrefs.ts` | `rule.label` è‡ªå‹•ç”Ÿæˆï¼ˆæœªï¼‰ |
| Frontend | `calendar.ts` | `ScoreReason` å‹å®šç¾©æ¸ˆã¿ |
| Frontend | `executors/calendar.ts` | ç†ç”±ã®æ•´å½¢è¡¨ç¤ºï¼ˆå¼·åŒ–äºˆå®šï¼‰ |
| E2E | `calendar.spec.ts` | ç†ç”±è¡¨ç¤ºãƒ†ã‚¹ãƒˆè¿½åŠ äºˆå®š |

---

## 22. æ®µéšçš„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase CONV-0: AIã‚’ã€Œå¥½ã¿æŠ½å‡ºã€ã«ã ã‘ä½¿ã†ï¼ˆâœ… å®Œäº†ï¼‰

**çŠ¶æ…‹**: P3-GEN1 å®Œäº†
- `SchedulePrefs` ã‚¹ã‚­ãƒ¼ãƒå®šç¾©æ¸ˆã¿
- `slotScorer.ts` ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Ÿè£…æ¸ˆã¿
- `scored_slots` ã‚’APIã§è¿”å´
- ãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤ºå¯¾å¿œæ¸ˆã¿

**æˆæœ**:
- "å¥½ã¿ã£ã½ã„æ–‡è¨€" â†’ æ§‹é€ åŒ– â†’ ã‚¹ã‚³ã‚¢åæ˜ 
- æ—¢å­˜ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã¯æ¸©å­˜

### Phase CONV-1: AIãŒã€Œè§£é‡ˆè£œåŠ©ã€ã«ãªã‚‹ï¼ˆâœ… å®Ÿè£…å®Œäº†ï¼‰

**å®Ÿè£…å†…å®¹**:
- ç¾çŠ¶ã® classifier ã¯ãã®ã¾ã¾
- **classifier ãŒ `unknown` ã«ãªã£ãŸæ™‚ã ã‘** nlRouter ã‚’å‘¼ã¶
- nlRouter ãŒæ—¢çŸ¥ã® intent ã«è½ã¨ã›ãŸã‚‰å®Ÿè¡Œã€è½ã¨ã›ãªã‘ã‚Œã°è³ªå•

**æˆæœ**:
- "æ±ºã‚æ‰“ã¡æ–‡è¨€ã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„" ãŒä¸€æ°—ã«ç·©å’Œ
- äº‹æ•…ã¯å¢—ãˆãªã„ï¼ˆconfirmã¯æ—¢å­˜ã®ã¾ã¾ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**:

**Backendï¼ˆcalendaré™å®š /api/nl/routeï¼‰**:

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `apps/api/src/routes/nlRouter.ts` | /api/nl/route ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆLLMå‘¼ã³å‡ºã—ï¼‰ |
| `apps/api/src/utils/nlRouterSchema.ts` | Zodã‚¹ã‚­ãƒ¼ãƒï¼ˆIntentEnum, RangeEnum, DayTimeEnumï¼‰ |
| `apps/api/src/utils/nlRouterPrompt.ts` | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡ |

**Frontendï¼ˆnlRouter ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰**:

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `nlRouter/types.ts` | Zod ã‚¹ã‚­ãƒ¼ãƒ + ActionPlan/NlRouterOutput å‹å®šç¾© |
| `nlRouter/systemPrompt.ts` | AI ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ |
| `nlRouter/nlRouter.ts` | AIå‘¼ã³å‡ºã—æœ¬ä½“ï¼ˆOpenAIäº’æ›ï¼‰ |
| `nlRouter/policyGate.ts` | å®‰å…¨ã‚²ãƒ¼ãƒˆï¼ˆwrite_externalå¿…ãšç¢ºèªã€pendingä¸­åˆ¶é™ï¼‰ |
| `nlRouter/executorBridge.ts` | ActionPlanâ†’IntentResultå¤‰æ›ã€æ—¢å­˜å®Ÿè¡Œã¸ã®æ©‹æ¸¡ã— |
| `nlRouter/index.ts` | çµ±åˆã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ |

**Frontendï¼ˆçµ±åˆï¼‰**:

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `core/api/nlRouter.ts` | Backend /api/nl/route APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `core/chat/apiExecutor.ts` | unknownæ™‚ã®AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ±åˆ |
| `core/chat/classifier/index.ts` | unknownæ™‚ã«rawInputã‚’paramsã«å«ã‚ã‚‹ |

**ä½¿ã„æ–¹**:
```typescript
import { route, classifyWithAiFallback, createContext, createInput } from './nlRouter';

// æ–¹æ³•1: ç›´æ¥ AI ã‚’å‘¼ã¶å ´åˆ
const context = createContext({ selectedThreadId });
const input = createInput(userMessage, context);
const output = await route(input, { apiKey: 'YOUR_API_KEY' });

// æ–¹æ³•2: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ + AI ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®çµ±åˆãƒ•ãƒ­ãƒ¼
const result = await classifyWithAiFallback({
  input: userMessage,
  context,
  ruleResult: classifyIntent(userMessage, intentContext),
  aiEnabled: true,
  aiOptions: { apiKey: 'YOUR_API_KEY' }
});
// result.source = 'rule' | 'ai' | 'fallback'
```

**å®‰å…¨ãƒãƒªã‚·ãƒ¼ï¼ˆpolicyGateï¼‰**:
- `.confirm` ç³» intent ã¯ AI ãŒç›´æ¥è¿”ã™ã“ã¨ã‚’ç¦æ­¢
- `write_external` ç³»ã¯ AI ãŒç›´æ¥è¿”ã™ã“ã¨ã‚’ç¦æ­¢ï¼ˆç¢ºèªãƒ•ãƒ­ãƒ¼çµŒç”±å¿…é ˆï¼‰
- pending ä¸­ã¯ `pending.action.decide`, `schedule.today/week/freebusy` ç­‰ã®ã¿è¨±å¯
- ç¢ºèªå¿…é ˆ intent ã¯ `requires_confirm` ã‚’å¼·åˆ¶ true

### Phase CONV-2: AIãŒã€Œä¼šè©±ã®ä¸»å°æ¨©ã€ã‚’æŒã¤

**å®Ÿè£…å†…å®¹**:
- ã™ã¹ã¦ã®å…¥åŠ›ã‚’ nlRouter ã«é€šã™
- æ—¢çŸ¥intentã¯ãã®ã¾ã¾å®Ÿè¡Œãƒ¬ãƒ¼ãƒ«ã¸
- ä¸æ˜ã¯è³ªå•
- pendingä¸­ã¯ã€AIãŒ "æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹" ã‚’è‡ªç„¶è¨€èªã§å°ã

### Phase CONV-3: è¤‡åˆã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ

**å®Ÿè£…å†…å®¹**:
- 1å›ã®ä¼šè©±ã§è¤‡æ•°intentã‚’æ®µéšå®Ÿè¡Œ
- çŠ¶æ…‹é·ç§»ã®ç®¡ç†
- ä¾‹ï¼šã€Œæ¥é€±ã®åˆå¾Œã§ã€A/B/Cã«é€ã£ã¦ã€
  - â†’ `freebusy.batch` â†’ `score` â†’ `prepareSend` â†’ `pending.action.created`

### Phase CONV-4: é«˜åº¦ãªäººæ•°æ§‹é€ å¯¾å¿œï¼ˆå°†æ¥ï¼‰

**å®Ÿè£…å†…å®¹**:
- N:1ï¼ˆèª°ã‹1äººå‰²å½“ï¼‰ã®å®Ÿè£…
- è¤‡åˆæ¡ä»¶ï¼ˆ(A AND B) OR Cï¼‰
- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…

---

## 23. ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚ï¼‰

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| äººæ•°æ§‹é€ ï¼ˆ6ç¨®ï¼‰ | âœ… å®šç¾©æ¸ˆã¿ | T3-T6ã¯å°†æ¥å®Ÿè£… |
| é–¢ä¿‚æ€§ï¼ˆ4æ®µéšï¼‰ | âœ… å®šç¾©æ¸ˆã¿ | å®¶æ—ãƒ¢ãƒ¼ãƒ‰ã¯å°†æ¥ |
| å‚åŠ æ¡ä»¶ï¼ˆAND/OR/Vote/è¤‡åˆï¼‰ | âœ… å®šç¾©æ¸ˆã¿ | OR/è¤‡åˆã¯å°†æ¥ |
| çŠ¶æ…‹é·ç§»å›³ï¼ˆMermaidï¼‰ | âœ… è¿½åŠ æ¸ˆã¿ | 9.1, 9.2 |
| ç„¡é™é˜²æ­¢ãƒ«ãƒ¼ãƒ« | âœ… å®šç¾©æ¸ˆã¿ | å›æ•°åˆ¶é™ |
| å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯ | âœ… å®šç¾©æ¸ˆã¿ | å°†æ¥å®Ÿè£… |
| å†èª¿æ•´/ã‚­ãƒ£ãƒ³ã‚»ãƒ« | âœ… å®Ÿè£…æ¸ˆã¿ | P2-D3 |
| é€šçŸ¥ãƒãƒ£ãƒãƒ« | âœ… å®Ÿè£…æ¸ˆã¿ | Email/Slack/Chatwork |
| Intent Catalog JSON | âœ… è¿½åŠ æ¸ˆã¿ | docs/intent_catalog.json |
| P3-SCORE1 è¨­è¨ˆ | âœ… è¿½åŠ æ¸ˆã¿ | Â§21 |
| æ—¢å­˜å®Ÿè£…éç ´å£Š | âœ… åŸå‰‡éµå®ˆ | - |

---

## 24. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ç›´è¿‘ï¼ˆCONV-1 å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

1. âœ… **P3-SCORE1ï¼ˆç†ç”±è¡¨ç¤ºï¼‰å®Ÿè£…**: `rule.label` è‡ªå‹•ç”Ÿæˆã€executorsè¡¨ç¤ºå¼·åŒ–
2. âœ… **Phase CONV-1 è¨­è¨ˆ**: nlRouter ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆã€Zodã‚¹ã‚­ãƒ¼ãƒå®šç¾©
3. âœ… **CONV-1.0ï¼ˆcalendaré™å®šï¼‰å®Ÿè£…**: unknownæ™‚ã®AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€E2Eãƒ†ã‚¹ãƒˆ
4. âœ… **PREF-SET-1ï¼ˆå¥½ã¿è¨­å®šã®ä¼šè©±å…¥åŠ›ï¼‰**: AIã«ã‚ˆã‚‹è‡ªç„¶æ–‡ã‹ã‚‰ã®å¥½ã¿æŠ½å‡ºã€ç¢ºèªãƒ•ãƒ­ãƒ¼

### ä¸­æœŸ

5. **AI ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶š**: æœ¬ç•ªç’°å¢ƒã§ã®APIã‚­ãƒ¼è¨­å®šï¼‹æ‰‹å‹•ç¢ºèª
6. **CONV-1.1ï¼ˆè£œåŠ©è§£é‡ˆï¼‰**: æ—¢å­˜classifierã‚ˆã‚Šå„ªå…ˆåº¦ä½ã„"è£œåŠ©è§£é‡ˆ"ã¨ã—ã¦AIã‚’ä½¿ã†
7. **çŠ¶æ…‹é·ç§»ã®å¯è¦–åŒ–**: èª¿æ•´ãƒ•ãƒ­ãƒ¼ã®é€²æ—è¡¨ç¤ºï¼ˆUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

### å°†æ¥

8. **N:1å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯**: æ‹…å½“è€…è‡ªå‹•é¸å‡º
9. **ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«**: ãƒãƒ¼ãƒ å…±é€šã®æš—é»™çŸ¥æ˜æ–‡åŒ–
10. **å®¶æ—ãƒ¢ãƒ¼ãƒ‰**: å³æ™‚æŒ¿å…¥æ©Ÿèƒ½

---

## ä»˜éŒ²: é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | æ¦‚è¦ |
|-------------|------|
| [`docs/intent_catalog.json`](./intent_catalog.json) | Intentå®Œå…¨å®šç¾©ï¼ˆnlRouterè¨±å¯ãƒªã‚¹ãƒˆï¼‰ |
| `apps/api/src/utils/schedulePrefs.ts` | SchedulePrefs å‹å®šç¾© |
| `apps/api/src/utils/slotScorer.ts` | ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ |
| `frontend/src/core/chat/classifier/types.ts` | IntentType å®šç¾© |
| `frontend/src/core/chat/pendingTypes.ts` | PendingState å®šç¾© |
| `frontend/src/core/chat/nlRouter/` | CONV-1 AI ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­è¨ˆ |

---

## 25. CONV-1 è¨­è¨ˆè©³ç´°ï¼ˆnlRouterï¼‰

### 25.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
frontend/src/core/chat/nlRouter/
â”œâ”€â”€ types.ts          # Zod ã‚¹ã‚­ãƒ¼ãƒ + å‹å®šç¾©
â”œâ”€â”€ systemPrompt.ts   # AI ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
â”œâ”€â”€ policyGate.ts     # å®‰å…¨ã‚²ãƒ¼ãƒˆ
â”œâ”€â”€ executorBridge.ts # æ—¢å­˜å®Ÿè¡Œã¸ã®æ©‹æ¸¡ã—
â””â”€â”€ index.ts          # çµ±åˆã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
```

### 25.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  classifyIntentChain()                   â”‚
â”‚  ï¼ˆæ—¢å­˜ãƒ«ãƒ¼ãƒ«åˆ†é¡ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ intent === 'unknown' ã®å ´åˆã®ã¿
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  classifyWithFallback()                  â”‚
â”‚  ï¼ˆAI ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰                    â”‚
â”‚                                          â”‚
â”‚  1. nlRouter.classify() â†’ ActionPlan    â”‚
â”‚  2. policyGate.evaluate() â†’ æ¤œè¨¼        â”‚
â”‚  3. executorBridge.convert() â†’ IntentResult â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¢å­˜ã® executeIntent()                  â”‚
â”‚  ï¼ˆapiExecutor / executorsï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 25.3 ActionPlan ã‚¹ã‚­ãƒ¼ãƒ

```typescript
interface ActionPlan {
  intent: IntentType;           // æ—¢å­˜ã® intent ã«è½ã¨ã™
  params: {                     // Intent åˆ¥ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    range?: 'today' | 'week' | 'next_week';
    prefer?: 'morning' | 'afternoon' | 'evening' | 'business';
    duration_minutes?: number;
    threadId?: string;
    participants?: ParticipantInfo[];
    // ...
  };
  meta?: {                      // ãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«è¦ç´ 
    topology?: 'T1' | 'T2' | 'T3' | 'T4' | 'T5' | 'T6';
    participation_rule?: 'AND' | 'OR' | 'VOTE';
    visibility_level?: 'V0' | 'V1' | 'V2' | 'V3';
    commit_rule?: 'manual' | 'auto' | 'tentative' | 'proxy';
  };
  requires_confirm: boolean;    // ç¢ºèªãŒå¿…è¦ã‹
  clarifications?: Array<{      // ä¸è¶³æƒ…å ±ã®è³ªå•
    field: string;
    question: string;
  }>;
  confidence: number;           // AI ã®ä¿¡é ¼åº¦ (0.0-1.0)
  message?: string;             // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¿”ç­”
}
```

### 25.4 policyGate ãƒ«ãƒ¼ãƒ«

| ãƒã‚§ãƒƒã‚¯é …ç›® | å†…å®¹ | ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-------------|------|----------------------|
| è¨±å¯ãƒªã‚¹ãƒˆ | intent ãŒè¨±å¯ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹ | ã‚¨ãƒ©ãƒ¼è¿”å´ |
| ã‚¹ãƒ¬ãƒƒãƒ‰å¿…é ˆ | ä¸€éƒ¨ intent ã¯ threadId å¿…é ˆ | è³ªå•ã‚’è¿”ã™ |
| pending å¿…é ˆ | pending.action.decide ç­‰ | è³ªå•ã‚’è¿”ã™ |
| å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | intent åˆ¥ã®å¿…é ˆé …ç›® | è³ªå•ã‚’è¿”ã™ |
| ä¿¡é ¼åº¦é–¾å€¤ | confidence < 0.5 | è³ªå•ã‚’è¿”ã™ |
| clarifications | ä¸è¶³æƒ…å ±ãŒã‚ã‚‹ | è³ªå•ã‚’è¿”ã™ |

### 25.5 ä½¿ç”¨æ–¹æ³•

```typescript
import { classifyWithFallback, configureNlRouter } from './nlRouter';

// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è¨­å®š
configureNlRouter({
  enabled: true,
  endpoint: process.env.AI_SERVICE_ENDPOINT,
});

// åˆ†é¡æ™‚ï¼ˆæ—¢å­˜ã® classifyIntent ã®ä»£ã‚ã‚Šã«ï¼‰
const result = await classifyWithFallback(userInput, context);
```

### 25.6 å®Ÿè£… TODO

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | çŠ¶æ…‹ |
|--------|--------|------|
| é«˜ | Zod ã‚¹ã‚­ãƒ¼ãƒå®šç¾© | âœ… å®Œäº† |
| é«˜ | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ | âœ… å®Œäº† |
| é«˜ | policyGate å®Ÿè£… | âœ… å®Œäº† |
| é«˜ | executorBridge å®Ÿè£… | âœ… å®Œäº† |
| é«˜ | çµ±åˆã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ | âœ… å®Œäº† |
| é«˜ | Backend /api/nl/route | âœ… å®Œäº† |
| é«˜ | Frontend APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | âœ… å®Œäº† |
| é«˜ | apiExecutor ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ±åˆ | âœ… å®Œäº† |
| ä¸­ | E2E ãƒ†ã‚¹ãƒˆï¼ˆcalendar.spec.tsï¼‰ | âœ… å®Œäº† |
| ä¸­ | AI ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šï¼ˆæœ¬ç•ªAPIã‚­ãƒ¼è¨­å®šï¼‰ | æ‰‹å‹•ç¢ºèªå¾…ã¡ |
| ä½ | ç›£æŸ»ãƒ­ã‚°ä¿å­˜ | æœªç€æ‰‹ |

---

## 26. CONV-1.0ï¼ˆcalendaré™å®šï¼‰å®Ÿè£…å®Œäº† âœ…

### 26.1 å®Ÿè£…æ¦‚è¦

- **unknown intent ã®å ´åˆã®ã¿** NL Router ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **calendarç³»ã®ã¿è¨±å¯**ï¼ˆread-only: schedule.today/week/freebusy/freebusy.batchï¼‰
- **writeç³»ã¯å¯¾è±¡å¤–**ï¼ˆinvite/send/finalize/remind ã¯ NL Router ã‹ã‚‰è¿”ã•ãªã„ï¼‰
- threadId ãŒå¿…è¦ãªå ´åˆã¯ `needs_clarification` ã‚’è¿”ã™

### 26.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `apps/api/src/routes/nlRouter.ts` | /api/nl/route ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `apps/api/src/utils/nlRouterSchema.ts` | Zod ã‚¹ã‚­ãƒ¼ãƒï¼ˆIntentEnum, RangeEnum, DayTimeEnum, RouteResultSchemaï¼‰ |
| `apps/api/src/utils/nlRouterPrompt.ts` | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆbuildNlRouterSystemPrompt, buildNlRouterUserPromptï¼‰ |

**APIä»•æ§˜ï¼ˆ/api/nl/routeï¼‰**:
```typescript
// Request
{ text: string; context: { selected_thread_id?: string; viewer_timezone: string } }

// Responseï¼ˆæˆåŠŸï¼‰
{ intent: 'schedule.freebusy'; confidence: 0.82; params: { range: 'next_week', dayTimeWindow: 'afternoon', durationMinutes: 60 }; rationale: 'æ¥é€±+åˆå¾Œ+' }

// Responseï¼ˆè¦ç¢ºèªï¼‰
{ intent: 'schedule.freebusy.batch'; confidence: 0.78; needs_clarification: { field: 'threadId', message: 'ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰...' } }

// Responseï¼ˆä¸æ˜ï¼‰
{ intent: 'unknown'; confidence: 0.2; params: {} }
```

### 26.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `frontend/src/core/api/nlRouter.ts` | Backend APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `frontend/src/core/chat/apiExecutor.ts` | unknownæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ±åˆï¼ˆexecuteUnknownWithNlRouterï¼‰ |
| `frontend/src/core/chat/classifier/index.ts` | unknownæ™‚ã« rawInput ã‚’ params ã«å«ã‚ã‚‹ |

### 26.4 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|---------|------------|
| `frontend/e2e/calendar.spec.ts` | CONV-1.0: è‡ªç„¶æ–‡â†’unknownâ†’nlRouterâ†’freebusy ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| | CONV-1.0: å£èªçš„ãªç©ºãç¢ºèªã«ã‚‚å¯¾å¿œ |

### 26.5 å®‰å…¨ãƒãƒªã‚·ãƒ¼

- `.confirm` ç³» intent ã¯ AI ãŒç›´æ¥è¿”ã™ã“ã¨ã‚’ç¦æ­¢
- `write_external` ç³»ï¼ˆinvite/send/finalize/remindï¼‰ã¯ AI ãŒç›´æ¥è¿”ã™ã“ã¨ã‚’ç¦æ­¢
- pending ä¸­ã¯ `pending.action.decide`, `schedule.today/week/freebusy` ç­‰ã®ã¿è¨±å¯
- ç¢ºèªå¿…é ˆ intent ã¯ `requires_confirm` ã‚’å¼·åˆ¶ true

### 26.6 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | çŠ¶æ…‹ |
|--------|--------|------|
| é«˜ | æœ¬ç•ªç’°å¢ƒã§APIã‚­ãƒ¼è¨­å®šï¼‹æ‰‹å‹•ç¢ºèª | æ‰‹å‹•ç¢ºèªå¾…ã¡ |
| é«˜ | âœ… PREF-SET-1ï¼ˆå¥½ã¿è¨­å®šã®ä¼šè©±å…¥åŠ›ï¼‰ | å®Œäº† |
| ä¸­ | propose ç³»ã® AI ã‚µãƒãƒ¼ãƒˆï¼ˆCONV-1.2ï¼‰ | æœªç€æ‰‹ |
| ä½ | ç›£æŸ»ãƒ­ã‚°ä¿å­˜ | æœªç€æ‰‹ |

---

## 27. PREF-SET-1ï¼ˆå¥½ã¿è¨­å®šã®ä¼šè©±å…¥åŠ›ï¼‰å®Ÿè£…å®Œäº† âœ…

### 27.1 å®Ÿè£…æ¦‚è¦

- **ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æŠ½å‡º**: æ—¢å­˜ã® `parsePreferenceFromText()` ã§æŠ½å‡ºå¯èƒ½ãªå ´åˆã¯å³ä¿å­˜
- **AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ãƒ«ãƒ¼ãƒ«ã§æŠ½å‡ºã§ããªã„å ´åˆã€AIï¼ˆ/api/nl/prefs/extractï¼‰ã§æŠ½å‡º
- **ç¢ºèªãƒ•ãƒ­ãƒ¼**: AIæŠ½å‡ºçµæœã¯å¿…ãšç¢ºèªãƒ•ãƒ­ãƒ¼ï¼ˆprefs.pendingï¼‰ã‚’çµŒç”±ã—ã¦ä¿å­˜
- **å®‰å…¨è¨­è¨ˆ**: å¤–éƒ¨é€ä¿¡ãªã—ã€DBæ›´æ–°ã®ã¿ã€ç¢ºèªå¾Œã«ä¿å­˜

### 27.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `apps/api/src/routes/nlPrefs.ts` | /api/nl/prefs/extract ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `apps/api/src/utils/nlPrefsSchema.ts` | Zodã‚¹ã‚­ãƒ¼ãƒï¼ˆExtractPrefsInput/Outputï¼‰ |
| `apps/api/src/utils/nlPrefsPrompt.ts` | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå¥½ã¿æŠ½å‡ºãƒ«ãƒ¼ãƒ«ï¼‰ |

**APIä»•æ§˜ï¼ˆ/api/nl/prefs/extractï¼‰**:
```typescript
// Request
{ text: string; viewer_timezone: string; existing_prefs?: any }

// Responseï¼ˆæˆåŠŸï¼‰
{
  success: true,
  data: {
    proposed_prefs: { windows?: [...], avoid?: [...] },
    changes: [{ op: 'add', path: '...', reason: '...' }],
    summary: 'å¹³æ—¥ã®ãƒ©ãƒ³ãƒæ™‚é–“(12:00-13:00)ã‚’å›é¿ã—ã¾ã™',
    confidence: 0.85,
    needs_confirmation: true
  }
}
```

### 27.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `core/api/nlPrefs.ts` | Backend APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `classifier/preference.ts` | AIæŠ½å‡ºãƒãƒ¼ã‚¯ï¼ˆneeds_ai_extractionï¼‰ |
| `executors/preference.ts` | AIæŠ½å‡ºå®Ÿè¡Œï¼‹ç¢ºèªãƒ•ãƒ­ãƒ¼ä½œæˆ |
| `classifier/pendingDecision.ts` | prefs.pending ã®ç¢ºèª/ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† |
| `apiExecutor.ts` | prefs_confirm/prefs_cancel ã®çµ±åˆ |

### 27.4 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "ãƒ©ãƒ³ãƒæ™‚é–“ã¯é¿ã‘ã¦"
    â†“
classifier/preference.ts
  parsePreferenceFromText() â†’ nullï¼ˆãƒ«ãƒ¼ãƒ«ã§æŠ½å‡ºä¸å¯ï¼‰
  â†’ { intent: 'preference.set', params: { needs_ai_extraction: true } }
    â†“
apiExecutor.ts â†’ executePreferenceSet()
  â†’ executePreferenceSetWithAi()
    â†“
/api/nl/prefs/extractï¼ˆAIæŠ½å‡ºï¼‰
  â†’ { proposed_prefs: { avoid: [...] }, summary: '...' }
    â†“
ç¢ºèªãƒ•ãƒ­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  "ã“ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ ã¯ã„/ã„ã„ãˆ"
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã¯ã„"
    â†“
classifier/pendingDecision.ts
  â†’ { intent: 'pending.action.decide', params: { decision: 'prefs_confirm' } }
    â†“
apiExecutor.ts â†’ executePendingDecision()
  â†’ executePreferenceSetConfirm()
    â†“
/api/users/me/schedule-prefsï¼ˆä¿å­˜ï¼‰
  â†’ "å¥½ã¿ã‚’è¨­å®šã—ã¾ã—ãŸ"
```

### 27.5 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|---------|------------|
| `frontend/e2e/preferences.spec.ts` | PREF-1a: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€Œåˆå¾Œ14æ™‚ä»¥é™ãŒã„ã„ã€â†’ å³ä¿å­˜ |
| | PREF-1b: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€Œå¤œã¯é¿ã‘ãŸã„ã€â†’ å³ä¿å­˜ |
| | PREF-2a: AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€Œãƒ©ãƒ³ãƒæ™‚é–“ã¯é¿ã‘ã¦ã€â†’ ç¢ºèªãƒ•ãƒ­ãƒ¼ |
| | PREF-2b: AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ ã€Œã¯ã„ã€ã§ä¿å­˜ |
| | PREF-3a: å¥½ã¿è¡¨ç¤ºã€Œå¥½ã¿è¦‹ã›ã¦ã€ |
| | PREF-3b: å¥½ã¿ã‚¯ãƒªã‚¢ã€Œå¥½ã¿ã‚¯ãƒªã‚¢ã€ |
| | PREF-4: ä¿å­˜å¾Œã« freebusy â†’ è¨­å®šåæ˜ ç¢ºèª |

### 27.6 å®‰å…¨ãƒãƒªã‚·ãƒ¼

- AIæŠ½å‡ºçµæœã¯ **å¿…ãšç¢ºèªãƒ•ãƒ­ãƒ¼ã‚’çµŒç”±**ï¼ˆèª¤ä¿å­˜é˜²æ­¢ï¼‰
- å¤–éƒ¨é€ä¿¡ãªã—ï¼ˆDBã¸ã®ä¿å­˜ã®ã¿ï¼‰
- ç¢ºèªãƒ•ãƒ­ãƒ¼ä¸­ã¯ä»–ã®æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆprefs.pendingï¼‰
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ã„ã¤ã§ã‚‚ä¸­æ­¢å¯èƒ½

### 27.7 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | çŠ¶æ…‹ |
|--------|--------|------|
| é«˜ | æœ¬ç•ªç’°å¢ƒã§APIã‚­ãƒ¼è¨­å®šï¼‹æ‰‹å‹•ç¢ºèª | æ‰‹å‹•ç¢ºèªå¾…ã¡ |
| ä¸­ | CONV-1.1ï¼ˆè£œåŠ©è§£é‡ˆï¼‰ | æœªç€æ‰‹ |
| ä½ | ã‚°ãƒ«ãƒ¼ãƒ—å¥½ã¿è¨­å®š | æœªç€æ‰‹ |

---

## 28. PROG-1ï¼ˆé€²æ—è¦ç´„ï¼‰å®Ÿè£…å®Œäº† âœ…

### 28.1 æ¦‚è¦

- **ç›®çš„**: AIãŒã€Œä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿã€ã«ç­”ãˆã‚‹ãŸã‚ã®é€²æ—è¦ç´„æ©Ÿèƒ½
- **ç‰¹å¾´**: 
  - read-onlyï¼ˆå¤–éƒ¨é€ä¿¡ãªã—ã€side_effect: readï¼‰
  - ä¼šè©±å‘ã‘ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¿”ç­”
  - æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¨å¥¨ã‚’è‡ªå‹•è¨ˆç®—

### 28.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `apps/api/src/services/threadProgressSummary.ts` | é€²æ—è¦ç´„ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆé›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰ |
| `apps/api/src/routes/threadsStatus.ts` | GET /api/threads/:id/summary ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ  |

**APIä»•æ§˜ï¼ˆGET /api/threads/:id/summaryï¼‰**:
```typescript
// Request
GET /api/threads/{threadId}/summary?format=chat

// Response
{
  success: true,
  format: 'chat',
  message: 'ğŸ“Œ **é€²æ—: ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°èª¿æ•´**\n\nçŠ¶æ…‹: å‹Ÿé›†ä¸­ï¼ˆv1 / è¿½åŠ å€™è£œã‚ã¨2å›å¯ï¼‰...',
  data: {
    thread: { id, title, status, created_at },
    proposal: { current_version, remaining_proposals, total_slots },
    counts: { total, pending, responded_latest, responded_old, declined, accepted },
    next_recommended_action: 'remind' | 'finalize' | 'wait' | ...,
    recommendation_reason: '3åãŒæœªå›ç­”ã§ã™ã€‚ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ãŠã™ã™ã‚ã—ã¾ã™',
    notes: ['2åãŒæ—§å€™è£œã§å›ç­”æ¸ˆã¿ï¼ˆå†å›ç­”ãƒªãƒã‚¤ãƒ³ãƒ‰æ¨å¥¨ï¼‰']
  }
}
```

### 28.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `core/api/threads.ts` | getSummary() è¿½åŠ ã€å‹å®šç¾©è¿½åŠ  |
| `classifier/thread.ts` | ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ ï¼ˆã€Œä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿã€ç­‰ï¼‰ |
| `executors/thread.ts` | executeProgressSummary() è¿½åŠ  |

### 28.4 ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³

ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§é€²æ—è¦ç´„ãŒè¿”ã‚‹ï¼š

| å…¥åŠ›ä¾‹ | èª¬æ˜ |
|--------|------|
| ã€Œä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿã€ | ä¼šè©±çš„ãªé€²æ—è³ªå• |
| ã€Œè¿”äº‹ããŸï¼Ÿã€ | å›ç­”çŠ¶æ³ã®ç¢ºèª |
| ã€Œèª°ãŒæœªå›ç­”ï¼Ÿã€ | æœªå›ç­”è€…ã®ç¢ºèª |
| ã€Œé€²æ—æ•™ãˆã¦ã€ | é€²æ—çŠ¶æ³ã®ç¢ºèª |
| ã€Œæ¬¡ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿã€ | æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèª |
| ã€ŒçŠ¶æ³ç¢ºèªã€ | å¾“æ¥ã®çŠ¶æ³ç¢ºèªï¼ˆè¦ç´„å½¢å¼ï¼‰ |

### 28.5 æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¨å¥¨ãƒ­ã‚¸ãƒƒã‚¯

| çŠ¶æ³ | æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ç†ç”± |
|------|---------------|------|
| æœªå›ç­”è€…ã‚ã‚Š | `remind` | ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ |
| æ—§ä¸–ä»£å›ç­”è€…ã‚ã‚Š | `remind_need_response` | å†å›ç­”ãƒªãƒã‚¤ãƒ³ãƒ‰ |
| å…¨å“¡å›ç­”æ¸ˆã¿ | `finalize` | ç¢ºå®šå¯èƒ½ |
| å…¨å“¡è¾é€€ | `reschedule` | å†èª¿æ•´ãŒå¿…è¦ |
| ãã®ä»– | `wait` | å›ç­”å¾…ã¡ |

### 28.6 å¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
ğŸ“Œ **é€²æ—: ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°èª¿æ•´**

çŠ¶æ…‹: å‹Ÿé›†ä¸­ï¼ˆv1 / è¿½åŠ å€™è£œã‚ã¨2å›å¯ï¼‰
å€™è£œæ•°: 5ä»¶

ğŸ‘¥ **æ‹›å¾…è€…: 4å**
â€¢ æœªå›ç­”: 2å
â€¢ å›ç­”æ¸ˆã¿: 1å
â€¢ è¾é€€: 1å

âœ… **æ¬¡ã®ãŠã™ã™ã‚:**
2åãŒæœªå›ç­”ã§ã™ã€‚ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ãŠã™ã™ã‚ã—ã¾ã™

ğŸ’¡ ã€Œãƒªãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„
```

### 28.7 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|---------|------------|
| `frontend/e2e/progress.spec.ts` | PROG-1a: ã€Œä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿã€â†’ ã‚¹ãƒ¬ãƒƒãƒ‰é¸æŠæ¡ˆå†…ã¾ãŸã¯ä¸€è¦§ |
| | PROG-1b: ã€Œè¿”äº‹ããŸï¼Ÿã€â†’ ã‚¹ãƒ¬ãƒƒãƒ‰é¸æŠæ¡ˆå†…ã¾ãŸã¯è¦ç´„ |
| | PROG-1c: ã€ŒçŠ¶æ³ç¢ºèªã€â†’ è¦ç´„å½¢å¼ã¾ãŸã¯ä¸€è¦§ |
| | PROG-1d: ã€Œå‹Ÿé›†ä¸­ã®äºˆå®šã€â†’ ä¸€è¦§è¡¨ç¤º |
| | PROG-1e: ã€Œæ¬¡ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿã€â†’ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¨å¥¨ |

### 28.8 è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

1. **read-only**: å¤–éƒ¨é€ä¿¡ãªã—ã€DBã®èª­ã¿å–ã‚Šã®ã¿
2. **æ—¢å­˜ã¨ã®å…±å­˜**: threadsStatus.ts ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ï¼ˆç ´å£Šãªã—ï¼‰
3. **ä¼šè©±å‘ã‘**: format=chat ã§ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã€format=json ã§ãƒ‡ãƒ¼ã‚¿å½¢å¼
4. **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: çŠ¶æ³ã«å¿œã˜ãŸæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•è¨ˆç®—
5. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: APIå¤±æ•—æ™‚ã‚‚ãƒ•ãƒ­ãƒ³ãƒˆã§ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆå¯èƒ½

---

## 29. CONV-CHATï¼ˆAIç§˜æ›¸ã®é›‘è«‡å¯¾å¿œï¼‰å®Ÿè£…å®Œäº† âœ…

### 29.1 æ¦‚è¦

- **ç›®çš„**: AIç§˜æ›¸ã¨ã—ã¦è‡ªç„¶ãªä¼šè©±ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- **ç‰¹å¾´**: 
  - äºˆå®šèª¿æ•´ä»¥å¤–ã®è©±é¡Œã«ã‚‚å¿œç­”
  - ä¼šè©±å±¥æ­´ã¯DBã«æ°¸ç¶šåŒ–
  - ã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼ˆç›´è¿‘5ã‚¿ãƒ¼ãƒ³ã®ã¿LLMã«é€ä¿¡ã€å®šå‹å¿œç­”ã¯LLMã‚¹ã‚­ãƒƒãƒ—ï¼‰
  - æ©Ÿèƒ½æ„å›³ã‚’æ¤œå‡ºã—ãŸã‚‰æ—¢å­˜intentã¸èª˜å°

### 29.2 ä½“é¨“ã‚¤ãƒ¡ãƒ¼ã‚¸

**Beforeï¼ˆç¾çŠ¶ï¼‰**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã“ã‚“ã«ã¡ã¯
AI: ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªæŒ‡ç¤ºãŒã§ãã¾ã™... âŒ
```

**Afterï¼ˆç›®æ¨™ï¼‰**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã“ã‚“ã«ã¡ã¯
AI: ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ âœ…

ãƒ¦ãƒ¼ã‚¶ãƒ¼: æœ€è¿‘å¿™ã—ãã¦ç–²ã‚Œã¦ã‚‹ã‚“ã ã‚ˆã­
AI: ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚ âœ…

ãƒ¦ãƒ¼ã‚¶ãƒ¼: æ¥é€±ã®ç©ºãæ•™ãˆã¦
AI: [é€šå¸¸ã®freebusyå‡¦ç†] âœ…
```

### 29.3 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `db/migrations/0079_create_chat_messages.sql` | ä¼šè©±å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« |
| `apps/api/src/routes/chat.ts` | POST /api/chat/message, GET /api/chat/history |

**APIä»•æ§˜ï¼ˆPOST /api/chat/messageï¼‰**:
```typescript
// Request
{ text: string; context?: { thread_id?: string } }

// Response
{ message: string; intent_detected?: string; should_execute?: boolean }
```

### 29.4 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `frontend/src/core/api/chat.ts` | Chat API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `frontend/src/core/chat/apiExecutor.ts` | executeChatFallback è¿½åŠ  |

**ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµŒè·¯**:
```
classifyIntentChain â†’ unknown â†’ executeUnknownWithNlRouter 
â†’ nlRouter ã‚‚ unknown â†’ executeChatFallback â†’ /api/chat/message
```

### 29.5 ã‚³ã‚¹ãƒˆæœ€é©åŒ–

| æˆ¦ç•¥ | å†…å®¹ |
|------|------|
| å®šå‹å¿œç­” | ã€Œã“ã‚“ã«ã¡ã¯ã€ã€Œã‚ã‚ŠãŒã¨ã†ã€ç­‰ã¯LLMã‚¹ã‚­ãƒƒãƒ— |
| å±¥æ­´åˆ¶é™ | ç›´è¿‘5ã‚¿ãƒ¼ãƒ³ã®ã¿LLMã«é€ä¿¡ |
| ä½ã‚³ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ« | gpt-4o-miniï¼ˆtemperature: 0.7ï¼‰ |
| å¿œç­”åˆ¶é™ | max_tokens: 200ï¼ˆçŸ­ã„å¿œç­”ï¼‰ |

### 29.6 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|---------|------------|
| `frontend/e2e/chat.spec.ts` | CHAT-1: æŒ¨æ‹¶ã¸ã®å¿œç­” |
| | CHAT-2: ãƒ˜ãƒ«ãƒ—ã¸ã®å¿œç­” |
| | CHAT-3: é›‘è«‡ã‹ã‚‰æ©Ÿèƒ½ã¸ã®åˆ‡ã‚Šæ›¿ãˆ |
| | CHAT-4: æ„Ÿè¬ã¸ã®å¿œç­” |

### 29.7 è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

1. **æ©Ÿèƒ½å„ªå…ˆ**: classifyIntentChain â†’ nlRouter ã®å¾Œã«é›‘è«‡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
2. **è‡ªç„¶ãªèª˜å°**: é›‘è«‡ã§ã‚‚ã€Œä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ï¼Ÿã€ã§æ©Ÿèƒ½ã¸èª˜å°
3. **å±¥æ­´æ°¸ç¶šåŒ–**: chat_messages ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
4. **ã‚¨ãƒ©ãƒ¼è€æ€§**: LLMã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªå¿œç­”ã‚’è¿”ã™

### 29.8 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [CONV_CHAT_DESIGN.md](./CONV_CHAT_DESIGN.md) - è©³ç´°è¨­è¨ˆæ›¸

---

## 30. CONV-1.1ï¼ˆAI Assist - paramsè£œå®Œï¼‰å®Ÿè£…å®Œäº† âœ…

### 30.1 æ¦‚è¦

- **ç›®çš„**: classifierã§intentãŒç¢ºå®šã—ãŸå¾Œã€ä¸è¶³paramsã‚’AIã§è£œå®Œ
- **ç‰¹å¾´**: 
  - intentã¯å¤‰æ›´ã—ãªã„ï¼ˆå®‰å…¨è¨­è¨ˆï¼‰
  - read-only ã®calendarç³»ã®ã¿å¯¾è±¡
  - å¤±æ•—ã—ã¦ã‚‚å¾“æ¥å‹•ä½œã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### 30.2 ä½“é¨“ã‚¤ãƒ¡ãƒ¼ã‚¸

**Beforeï¼ˆCONV-1.0ã¾ã§ï¼‰**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: æ¥é€±ã®åˆå¾Œã€ç©ºã„ã¦ã‚‹ï¼Ÿ
AI: [å…¨æ™‚é–“å¸¯ã®ç©ºãã‚’è¡¨ç¤º] â† åˆå¾Œã¨ã„ã†æŒ‡å®šãŒç„¡è¦–ã•ã‚Œã‚‹
```

**Afterï¼ˆCONV-1.1ï¼‰**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: æ¥é€±ã®åˆå¾Œã€ç©ºã„ã¦ã‚‹ï¼Ÿ
AI: [åˆå¾Œã®ç©ºãã®ã¿ã‚’è¡¨ç¤º] â† AI Assistã§åˆå¾Œparamsè£œå®Œ âœ…

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ä»Šé€±ã€å¤œã„ã‘ã‚‹ï¼Ÿ
AI: [18æ™‚ä»¥é™ã®ç©ºãã‚’è¡¨ç¤º] â† AI Assistã§å¤œparamsè£œå®Œ âœ…
```

### 30.3 å¯¾è±¡ã‚¹ã‚³ãƒ¼ãƒ—

| Intent | è£œå®Œå¯¾è±¡params |
|--------|---------------|
| schedule.freebusy | range, dayTimeWindow, durationMinutes |
| schedule.freebusy.batch | range, dayTimeWindow, durationMinutes |
| schedule.today | dayTimeWindow |
| schedule.week | range, dayTimeWindow |

### 30.4 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `apps/api/src/utils/nlRouterSchema.ts` | AssistExtract schemaè¿½åŠ  |
| `apps/api/src/utils/nlAssistPrompt.ts` | Assist Modeå°‚ç”¨prompt |
| `apps/api/src/routes/nlRouter.ts` | POST /api/nl/assist ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |

**APIä»•æ§˜ï¼ˆPOST /api/nl/assistï¼‰**:
```typescript
// Request
{
  text: string;
  detected_intent: string;
  existing_params: Record<string, any>;
  viewer_timezone?: string;
  now_iso?: string;
  context_hint?: string;
}

// Response
{
  target_intent: string;      // detected_intentã¨åŒä¸€ï¼ˆå¤‰æ›´ç¦æ­¢ï¼‰
  params_patch: Record<string, any>;
  confidence: number;         // 0.0-1.0
  rationale?: string;
}
```

### 30.5 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ |
|---------|------|
| `frontend/src/core/api/nlAssist.ts` | Assist API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `frontend/src/core/chat/apiExecutor.ts` | maybeAssistParams ãƒ•ãƒƒã‚¯ |

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
classifyIntentChain â†’ calendar intentæ¤œå‡º â†’ maybeAssistParams
â†’ paramsä¸è¶³? â†’ /api/nl/assist â†’ params_patchã‚’ãƒãƒ¼ã‚¸
â†’ executeIntentï¼ˆè£œå®Œæ¸ˆã¿paramsï¼‰
```

### 30.6 è£œå®Œãƒãƒƒãƒ”ãƒ³ã‚°

| æ—¥æœ¬èªè¡¨ç¾ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|-----------|-----------|
| æ¥é€± | range: "next_week" |
| ä»Šé€± | range: "this_week" |
| åˆå¾Œ | dayTimeWindow: "afternoon" |
| å¤œ | dayTimeWindow: "night" |
| å¤•æ–¹ | dayTimeWindow: "evening" |
| åˆå‰ | dayTimeWindow: "morning" |
| 1æ™‚é–“ | durationMinutes: 60 |
| 30åˆ† | durationMinutes: 30 |

### 30.7 å®‰å…¨è¨­è¨ˆ

1. **intentå¤‰æ›´ç¦æ­¢**: target_intent !== detected_intent ã¯ reject
2. **ä½ä¿¡é ¼åº¦ã‚¹ã‚­ãƒƒãƒ—**: confidence < 0.6 ã¯ params_patch é©ç”¨ã—ãªã„
3. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: APIå¤±æ•—æ™‚ã¯å¾“æ¥å‹•ä½œã‚’ç¶™ç¶š
4. **read-only**: calendarç³»ã®ã¿ã€writeç³»ã¯å¯¾è±¡å¤–

### 30.8 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|---------|------------|
| `frontend/e2e/calendar.spec.ts` | CONV-1.1a: åˆå¾Œparamsè£œå®Œ |
| | CONV-1.1b: å¤œparamsè£œå®Œ |

### 30.9 ä»Šå¾Œã®æ‹¡å¼µï¼ˆCONV-1.2ä»¥é™ï¼‰

- write_externalç³»ã¸ã®æ‹¡å¼µï¼ˆpolicyGateé€šéå¿…é ˆï¼‰
- duration/countç­‰ã®è¿½åŠ è£œå®Œ
- æ›œæ—¥æŒ‡å®šï¼ˆæœˆæ›œæ—¥ã€é€±æœ«ãªã©ï¼‰

---

*æœ€çµ‚æ›´æ–°: 2026-01-24*
